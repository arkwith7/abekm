"""Add seed data migration

Revision ID: seed_data_001
Revises: 3e19d6566abb
Create Date: 2025-09-30 13:00:00.000000

"""
from typing import Sequence, Union
from alembic import op
import sqlalchemy as sa
import asyncio
import sys
from pathlib import Path

# Import seed system
project_root = Path(__file__).parent.parent.parent
sys.path.insert(0, str(project_root))

# revision identifiers, used by Alembic.
revision: str = 'seed_data_001'
down_revision: Union[str, None] = '3e19d6566abb'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Run upgrade migrations with seed data."""
    print("ğŸŒ± ì‹œë“œ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...")
    
    # ë™ê¸°ì ìœ¼ë¡œ ì‹œë“œ ë°ì´í„° ì‹¤í–‰
    import subprocess
    import os
    
    # í˜„ì¬ ë””ë ‰í„°ë¦¬ë¥¼ ë°±ì—”ë“œ ë£¨íŠ¸ë¡œ ë³€ê²½
    backend_dir = Path(__file__).parent.parent.parent
    original_dir = os.getcwd()
    
    try:
        os.chdir(backend_dir)
        
        # ì‹œë“œ ë°ì´í„° ì‹¤í–‰
        result = subprocess.run([
            sys.executable, "-m", "data.seeds.run_all_seeders"
        ], input="y\n", text=True, capture_output=True)
        
        if result.returncode == 0:
            print("âœ… ì‹œë“œ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!")
            print(result.stdout)
        else:
            print("âŒ ì‹œë“œ ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤íŒ¨!")
            print(result.stderr)
            raise Exception(f"ì‹œë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {result.stderr}")
            
    finally:
        os.chdir(original_dir)


def downgrade() -> None:
    """Run downgrade migrations."""
    print("ğŸ”„ ì‹œë“œ ë°ì´í„° ë‹¤ìš´ê·¸ë ˆì´ë“œ...")
    
    # ë‹¤ìš´ê·¸ë ˆì´ë“œ ì‹œì—ëŠ” ë°ì´í„°ë§Œ ì‚­ì œ (í…Œì´ë¸” êµ¬ì¡°ëŠ” ìœ ì§€)
    import subprocess
    import os
    
    backend_dir = Path(__file__).parent.parent.parent
    original_dir = os.getcwd()
    
    try:
        os.chdir(backend_dir)
        
        # ê°œë³„ í…Œì´ë¸” ë°ì´í„° ì‚­ì œ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
        cleanup_script = """
import asyncio
import sys
from pathlib import Path

project_root = Path(__file__).parent
sys.path.insert(0, str(project_root))

from app.core.database import get_async_session_local
from data.seeds.base_seeder import BaseSeeder

async def cleanup_seed_data():
    async_session = get_async_session_local()
    async with async_session() as session:
        seeder = BaseSeeder(session)
        
        tables = [
            "tb_user_permissions",
            "tb_user", 
            "tb_sap_hr_info",
            "tb_knowledge_categories",
            "tb_cmns_cd_grp_item"
        ]
        
        for table in tables:
            await seeder.clear_table(table)
        
        await session.commit()
        print("âœ… ì‹œë“œ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ!")

if __name__ == "__main__":
    asyncio.run(cleanup_seed_data())
"""
        
        # ì„ì‹œ ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ ìƒì„± ë° ì‹¤í–‰
        temp_script = backend_dir / "temp_cleanup.py"
        with open(temp_script, 'w', encoding='utf-8') as f:
            f.write(cleanup_script)
        
        result = subprocess.run([sys.executable, str(temp_script)], 
                              capture_output=True, text=True)
        
        # ì„ì‹œ íŒŒì¼ ì‚­ì œ
        temp_script.unlink()
        
        if result.returncode == 0:
            print("âœ… ì‹œë“œ ë°ì´í„° ì •ë¦¬ ì™„ë£Œ!")
        else:
            print("âŒ ì‹œë“œ ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨!")
            print(result.stderr)
            
    finally:
        os.chdir(original_dir)