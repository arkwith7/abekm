# 10.2 Orchestration & AgentCatalog (Supervisor·Registry·Team-of-Teams)

> 본 문서는 ABEKM 멀티에이전트의 오케스트레이션 설계(단/2단 Supervisor), AgentCatalog(Registry) 기반 확장 방법을 정의합니다.

---

## 1. 핵심 구조 요약

- **SupervisorAgent**가 사용자 요청을 받아 작업을 라우팅
- **Worker**는 전문 에이전트(검색 RAG, PPT, KIPRIS, Text-to-SQL, Deep Research, 분석 등)
- Supervisor는 워커를 하드코딩으로 들고 있지 않고, **AgentCatalog**를 통해 목록/설명/핸들러를 동적으로 얻습니다.

현재 코드 기준(Phase 1 완료):
- `backend/app/agents/catalog.py`: AgentCatalog(통합 카탈로그)
- `backend/app/agents/supervisor_agent.py`: Supervisor
- `backend/app/agents/core/workers.py`: legacy 기본 워커 정의(호환 폴백)
- `backend/app/agents/features/*/worker.py`: feature-pack 워커 정의(디스커버리 대상)

---

## 2. AgentCatalog(Registry) 패턴

### 2.1 왜 Catalog인가?

기존에는
- Tool registry
- Autonomous registry
- Worker 목록
이 서로 다른 진입점으로 존재해 통합/확장이 어려웠습니다.

Catalog는 아래를 단일 진입점으로 제공합니다.
- tools
- autonomous agents
- workers

권장 사용:
```python
from app.agents import agent_catalog

workers = agent_catalog.get_workers()
tool = agent_catalog.get_tool("summary")
autonomous = agent_catalog.get_autonomous("patent_analysis")
```

### 2.2 확장 방향(Phase 2)

현재 `get_workers()`는 아래를 수행합니다.

- legacy 기본 워커(`app.agents.core.workers.get_default_workers`)를 먼저 로드
- `app.agents.features` 아래 모듈들을 스캔하여 `app.agents.features.<feature>.worker:get_worker_specs()`를 발견
- feature-pack 워커 스펙을 merge(동일 key는 feature-pack이 우선)

현재 Supervisor 라우팅 대상 워커(키):
- `SearchAgent`
- `PresentationAgent`
- `PriorArtAgent`

---

## 3. 2단계 계층 Supervisor(Team-of-Teams) — 목표 아키텍처

워커 수가 증가하면 단일 Supervisor가 비대해집니다.
따라서 목표 구조는 다음과 같습니다.

- **Top-Level Supervisor**: 팀 단위 라우팅(거칠게)
- **Team Supervisor**: 팀 내부 워커 라우팅(정교하게)

권장 팀 구성(초기안):
- **Research Team**: Search RAG, KIPRIS(Prior Art), Text-to-SQL, Deep Research
- **Analysis Team**: Topic Modeling, Network Analysis, Knowledge Graph
- **Output Team**: Presentation(PPT), Report

운영 권장: 초기에는 활성 워커 수를 작게 유지(예: 5개 이하)하고, 팀 단위로 확장합니다.

---

## 4. 통합 패턴: Subgraph vs Wrapper

기존 에이전트들이 서로 다른 상태/입출력 스키마를 가질 수 있으므로, 통합 방식은 아래 2가지로 명시합니다.

- **Subgraph 통합**
  - 공용 상태 키를 공유할 수 있을 때, 각 에이전트를 Subgraph로 컴파일해 부모 그래프 노드로 추가

- **Wrapper(Adapter) 통합**
  - 상태 스키마가 다를 때, 부모 상태 ↔ 내부 입력/출력 변환 래퍼를 제공

이 규약을 고정하면, “각자 잘 돌아가지만 연계가 어려운 상태”를 단계적으로 해소할 수 있습니다.

---

## 5. Deprecation 정책

직접 registry 접근은 점진적으로 deprecate 합니다.

- Deprecated(향후 제거 예정)
  - `app.agents.registry`
  - `app.agents.autonomous_registry`

- Recommended
  - `from app.agents import agent_catalog`

---

## 6. 다음 구현 체크포인트

- Phase 2: feature-pack 기반 worker discovery
- Phase 3: 통합 테스트 확장(실DB/Redis/외부 최소 경로)

테스트/변경 관리 규칙은 10.5 참고
