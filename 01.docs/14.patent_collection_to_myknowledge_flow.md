# 특허 수집 → 지식 컨테이너(MyKnowledge) 표출 흐름

## 목표

- KIPRIS 등에서 **특허를 수집하면**
  - (A) 특허 서지정보 DB에 저장되고
  - (B) 동시에 해당 지식 컨테이너의 **문서 목록(MyKnowledge)** 에도 **일반 업로드 문서처럼** 표시되어
  - (C) 기존 **뷰어/다운로드 UX** 를 그대로 재사용한다.

## 정책(요구사항)

- 특허는 공개 데이터이므로 시스템은 **원본 파일(PDF 등)을 저장하지 않는다**.
- 대신 시스템은 특허의 **접근/다운로드 URL만 저장**한다.
- 하이브리드 검색을 위해 특허의 **서지정보(제목/초록 등)는 항상 색인 및 임베딩**한다.

## 핵심 데이터 모델

### 1) 특허 서지정보 저장

- 테이블: `TbPatentBibliographicInfo` ([backend/app/models/patent/patent_models.py](../backend/app/models/patent/patent_models.py))
- 주요 필드
  - `application_number`, `publication_number`, `title`, `abstract`, 날짜 필드
  - `knowledge_container_id`: 수집 대상 지식 컨테이너
  - `data_source`: 기본 `KIPRIS`
  - `source_url`: 특허 원본 접근 URL(외부)

### 2) 지식 컨테이너 문서 목록 표출(통합 문서 테이블)

- 테이블: `TbFileBssInfo` ([backend/app/models/document/file_models.py](../backend/app/models/document/file_models.py))
- 특허 수집 시 생성되는 레코드 규칙
  - `document_type = "patent"`
  - `knowledge_container_id = (수집 대상 컨테이너)`
  - `path = (외부 URL)`
  - `file_extsn = "url"` (UI에서 확장자 표시 목적)
  - `processing_status = "completed"` (서지 임베딩/인덱싱이 끝난 상태를 의미)
  - `korean_metadata`에 최소 식별자 저장
    - `applicationNumber`, `publicationNumber`, `data_source`, `source_url`

### 3) 검색/임베딩

- 테이블
  - `TbDocumentSearchIndex` (서지 텍스트 인덱싱)
  - `DocChunkSession`, `DocChunk`, `DocEmbedding` (임베딩 파이프라인 호환)
- 전략
  - 특허는 파일 파싱 대신 `title + abstract`를 1개 청크로 생성
  - 임베딩 provider는 환경 설정(`default_embedding_provider`)에 따라 저장

## 처리 흐름(End-to-End)

### 0) 수집 설정 저장/실행

- API: `POST /api/v1/patent-collection/settings`
- 실행: `POST /api/v1/patent-collection/start` → Celery task 실행
- Task: `collect_patents_from_kipris` ([backend/app/tasks/patent_collection_tasks.py](../backend/app/tasks/patent_collection_tasks.py))

### 1) KIPRIS 검색

- `KIPRISClient.search_patents()`가 최소 서지 필드 반환
  - `applicationNumber`, `publicationNumber`, `inventionTitle`, `abstract`, 날짜 등

### 2) DB 저장(서지 + 문서 목록 엔트리)

- `PatentCollectionService.save_patent_to_database()` ([backend/app/services/patent/collection_service.py](../backend/app/services/patent/collection_service.py))
  1. `TbPatentBibliographicInfo` 레코드 생성 (중복 방지)
  2. `TbFileBssInfo` 레코드 생성 (MyKnowledge 목록에 보일 ‘문서’ 엔트리)
  3. `_generate_patent_embeddings()` 호출
     - `TbDocumentSearchIndex` + `DocChunk*` + `DocEmbedding` 저장

### 3) MyKnowledge(지식 컨테이너) 문서 목록 노출

- 프론트: MyKnowledge는 `/api/v1/documents?container_id=...`로 목록을 가져옴
- 백엔드: `GET /api/v1/documents` ([backend/app/api/v1/documents.py](../backend/app/api/v1/documents.py))
  - 일반 문서는 provider 기반 필터(추출/세션 성공 등) 조건이 적용됨
  - **특허 문서(`document_type="patent"`)는 예외로 항상 표시**하여 컨테이너 문서 목록에 누락되지 않게 함

### 4) 뷰어/다운로드 재사용

- 뷰어
  - 프론트 FileViewer는 `GET /api/files/iframe-view/{file_id}?token=...` 사용
  - 백엔드가 `TbFileBssInfo.path`를 확인
    - 로컬/S3/Azure: 기존 방식
    - **http(s) URL:** iframe에서 열 수 있도록 리다이렉트 또는 링크 HTML 반환

- 다운로드
  - 프론트는 `GET /api/v1/documents/{id}/download`를 `blob`으로 다운로드
  - 외부 도메인으로의 리다이렉트는 CORS로 실패할 수 있으므로
    **특허는 URL을 담은 `.url`(바로가기) 파일을 다운로드로 제공**

## 중복/재수집 처리

- 기준: `TbPatentBibliographicInfo.application_number`로 중복 방지
- 재수집 시에도 `TbFileBssInfo(document_type=patent, applicationNumber=...)`가 없으면 생성하여
  “서지는 있는데 목록이 비는” 상태를 방지

## 권한/접근 제어

- 문서 목록/다운로드 권한은 기존 컨테이너 권한 로직을 그대로 사용
  - `knowledge_container_id` 기준

## 특허 수집 설정 및 작업 상태 관리 (2025-12-24 개선)

### 배경
특허 수집 작업 실행 시 명확한 상태 구분과 결과 피드백이 필요했다. 특히 "0건 수집" 같은 경우 실패인지 검색 조건이 좁아서 그런 것인지 구분이 어려웠다.

### 개선 사항

#### 1. 작업 상태 추적 강화
- **상태 정의** (`TbPatentCollectionTasks.status`)
  - `pending`: 작업이 대기열에 등록됨
  - `running`: KIPRIS 검색 및 데이터 수집 진행 중
  - `completed`: 수집 완료 (0건이어도 completed)
  - `failed`: 오류로 인한 실패

#### 2. 상태별 메시지 시스템
프론트엔드 `PatentCollectionSettings.tsx`의 `pollTask()` 함수가 상태에 따라 적절한 메시지를 생성:

```typescript
// 상태별 메시지 예시
if (status === 'completed') {
  if (collected === 0) {
    message = '⚠️ 검색 조건에 맞는 특허가 없습니다. 검색 조건을 조정해보세요.';
  } else {
    message = `✅ 수집 완료: ${collected}건 성공${errors > 0 ? `, ${errors}건 실패` : ''}`;
  }
} else if (status === 'failed') {
  message = '❌ 수집 작업이 실패했습니다.';
} else if (status === 'running') {
  message = `🔄 수집 중... (${current}/${total})`;
}
```

#### 3. 마지막 수집 결과 저장
설정별로 마지막 실행 정보를 추적하기 위해 DB 스키마 개선:

**모델 변경** (`TbPatentCollectionSettings`)
```python
last_collection_date = Column(DateTime(timezone=True), nullable=True)
last_collection_result = Column(JSONB, nullable=True)  # 새로 추가
# 저장 형식: {"collected": 25, "errors": 2}
```

**자동 업데이트 로직** (`PatentCollectionService.update_task_progress()`)
- 작업이 `completed` 상태가 되면:
  - `last_collection_date`: 현재 시각 저장
  - `last_collection_result`: `{collected, errors}` JSON 저장

#### 4. UI/UX 개선

**설정 카드 표시**
- 작업이 실행 중이지 않을 때: 마지막 수집 일시 및 결과 표시
  - 예: "마지막 수집: 2025-12-24 10:30 / 결과: 25건 수집, 2건 실패"
- 색상 구분:
  - 🟢 녹색: 수집 성공 (건수 > 0)
  - 🟡 노란색: 수집 완료이지만 0건 (조건 재검토 필요)
  - 🔴 빨간색: 실패

**진행 상태 UI**
- 실시간 프로그레스 바 (running 상태일 때만)
- 완료 후 결과 요약 박스 (5초간 표시 후 자동 제거)

#### 5. 구현 파일

**Backend**
- 모델: `backend/app/models/patent/collection_models.py`
  - `TbPatentCollectionSettings.last_collection_result` 추가
- API: `backend/app/api/v1/patent_collection.py`
  - Response 모델에 `last_collection_result` 포함
- 서비스: `backend/app/services/patent/collection_service.py`
  - `update_task_progress()`: completed 시 설정 업데이트 로직
- 마이그레이션: `backend/alembic/versions/20251224_add_last_collection_result.py`

**Frontend**
- 컴포넌트: `frontend/src/pages/user/PatentCollectionSettings.tsx`
  - `pollTask()`: 상태별 메시지 생성 및 자동 정리
  - UI: 마지막 수집 정보 카드, 진행 상태 표시 개선

### 사용자 경험 흐름

1. **수집 시작**: "🚀 수집 작업을 시작합니다..."
2. **진행 중**: "🔄 수집 중... (15/100)" + 프로그레스 바
3. **완료 - 성공**: "✅ 수집 완료: 25건 성공" (녹색)
4. **완료 - 0건**: "⚠️ 검색 조건에 맞는 특허가 없습니다..." (노란색)
5. **실패**: "❌ 수집 작업이 실패했습니다" (빨간색)
6. **5초 후**: 상태 메시지 자동 제거, 마지막 수집 정보로 대체

이를 통해 사용자는:
- 작업의 현재 상태를 명확히 파악
- 0건 수집 시 검색 조건 조정 필요성 인지
- 각 설정의 마지막 실행 이력 추적
- 성공/실패를 시각적으로 즉시 구분

