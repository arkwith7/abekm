# 08. ABEKM 정적 설계 명세서

> 최종 업데이트: 2025-10-27 실제 데이터베이스 스키마 기준 전면 개정

## 변경 이력 (Revision History)

| 날짜         | 버전  | 변경 내용                                                                                                                                                              | 비고                                |
| ---------- | --- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ | --------------------------------- |
| 2025-10-27 | 2.0 | 실제 데이터베이스 스키마 기준 전면 개정 (PostgreSQL 실제 테이블 구조 반영)                                                                                                                   | 데이터베이스 직접 조회 후 업데이트               |
| 2025-10-27 | 2.0 | 학술 서지정보 모델 5종 추가 (`tb_academic_document_metadata`, `tb_academic_authors`, `tb_academic_affiliations`, `tb_academic_document_authors`, `tb_academic_references`) | Alembic rev b9e25ab62141          |
| 2025-10-27 | 2.0 | Refresh Token 모델 추가 (`tb_refresh_tokens`) - JWT 토큰 갱신 및 세션 관리                                                                                                       | Alembic rev 9c2a4d9c1b2e          |
| 2025-10-27 | 2.0 | 멀티모달 CLIP 벡터 필드 추가 (`doc_embedding.clip_vector` 512차원) 및 HNSW 인덱스                                                                                                   | Alembic rev 20251017_001          |
| 2025-10-27 | 2.0 | `tb_document_search_index` 확장 필드 반영 (`has_images`, `has_tables`, `image_count`, `table_count`, `images_metadata`, `content_tsvector_en`, `keyword_tsvector_en`)    | 멀티모달 + 다국어 검색 지원                  |
| 2025-10-27 | 2.0 | `doc_chunk.blob_key` 필드 추가 (Azure Blob Storage 연동)                                                                                                                  | Alembic rev 7641fa6f6c28          |
| 2025-10-27 | 2.0 | `doc_extracted_object` 이미지 특징 필드 추가 (`image_width`, `image_height`, `phash`)                                                                                         | 이미지 중복 제거 및 품질 관리                 |
| 2025-10-15 | 1.2 | 벡터 차원 1536 마이그레이션 (`vs_doc_contents_chunks.chunk_embedding`) 및 HNSW 인덱스 재생성                                                                                        | Alembic rev k3l4m5n6o7p8          |
| 2025-10-15 | 1.2 | PostgreSQL korean FTS 트리거 구현 (`tb_document_search_index.keyword_tsvector`, `content_tsvector`)                                                                     | Alembic rev 72342a21e7bc          |
| 2025-10-15 | 1.2 | Azure Blob Storage 통합 문서화 (`wkms-raw`, `wkms-intermediate`, `wkms-derived` 컨테이너)                                                                                   | 클라우드 스토리지 전환                      |
| 2025-09-30 | 1.1 | 멀티모달 스키마 테이블 5종 추가 (`doc_extraction_session`, `doc_extracted_object`, `doc_chunk_session`, `doc_chunk`, `doc_embedding`)                                           | Alembic rev b38f1337b6ae          |
| 2025-08 ~  | 1.0 | 초기 정적 설계 문서                                                                                                                                                        | 기본 데이터베이스 스키마 (300c1a2a7c7f) |

## 1. 개요

### 1.1 문서 목적

본 문서는 ABEKM(AI Based Enterprise Knowledge Management)의 정적 설계를 정의합니다. 현재 구현된 SQLAlchemy 모델들을 기반으로 주요 객체들의 구조, 속성, 관계를 표 형태로 상세히 기술합니다.

### 1.2 설계 범위

- **인증/권한 모델**: 사용자 인증 및 권한 관리
- **문서 관리 모델**: 파일 및 문서 처리
- **벡터 검색 모델**: pgvector 기반 벡터 검색
- **채팅 모델**: 대화형 질의응답
- **핵심 시스템 모델**: 공통 코드 및 시스템 설정

## 2. 모델 아키텍처 개요

### 2.1 현재 구현된 모델 분류 (2025-10-27 기준, 총 38개 테이블)

| 분류         | 모델명                         | 테이블명                         | 주요 역할                |
| ---------- | --------------------------- | ---------------------------- | -------------------- |
| **인증/권한**  | TbSapHrInfo                 | tb_sap_hr_info               | SAP 인사 정보 관리         |
| **인증/권한**  | User                        | tb_user                      | ABEKM 사용자 인증          |
| **인증/권한**  | RefreshToken                | tb_refresh_tokens            | JWT 리프레시 토큰 관리       |
| **인증/권한**  | TbKnowledgeContainers       | tb_knowledge_containers      | 지식 컨테이너 계층 구조        |
| **인증/권한**  | TbUserRoles                 | tb_user_roles                | 사용자 역할 관리            |
| **인증/권한**  | TbUserPermissions           | tb_user_permissions          | 사용자별 세부 권한           |
| **인증/권한**  | TbPermissionRequests        | tb_permission_requests       | 권한 요청/승인             |
| **인증/권한**  | TbPermissionAuditLog        | tb_permission_audit_log      | 권한 변경 감사 로그          |
| **인증/권한**  | TbPermissionManagementInfo  | tb_permission_management_info | 권한 관리 정보             |
| **인증/권한**  | TbUserPermissionView        | tb_user_permission_view      | 사용자 권한 뷰 (쿼리 최적화)    |
| **문서 관리**  | TbFileBssInfo               | tb_file_bss_info             | 파일 기본 정보             |
| **문서 관리**  | TbFileDtlInfo               | tb_file_dtl_info             | 파일 상세 정보             |
| **문서 관리**  | VsDocContentsChunks         | vs_doc_contents_chunks       | (레거시) 문서 벡터 청킹       |
| **문서 관리**  | TbDocumentSearchIndex       | tb_document_search_index     | 통합 검색 인덱스 (다국어+멀티모달) |
| **문서 관리**  | DocExtractionSession        | doc_extraction_session       | 멀티모달 추출 세션           |
| **문서 관리**  | DocExtractedObject          | doc_extracted_object         | 추출 객체(텍스트/표/이미지)     |
| **문서 관리**  | DocChunkSession             | doc_chunk_session            | 청킹 세션 메타             |
| **문서 관리**  | DocChunk                    | doc_chunk                    | 멀티모달 청크 저장           |
| **문서 관리**  | DocEmbedding                | doc_embedding                | 청크 임베딩 (듀얼 벡터 지원)    |
| **학술 서지**  | TbAcademicDocumentMetadata  | tb_academic_document_metadata | 학술논문 서지 메타데이터        |
| **학술 서지**  | TbAcademicAuthors           | tb_academic_authors          | 학술논문 저자 정보           |
| **학술 서지**  | TbAcademicAffiliations      | tb_academic_affiliations     | 학술논문 소속기관 정보         |
| **학술 서지**  | TbAcademicDocumentAuthors   | tb_academic_document_authors  | 학술논문-저자 매핑           |
| **학술 서지**  | TbAcademicReferences        | tb_academic_references       | 학술논문 참고문헌            |
| **채팅**     | TbChatHistory               | tb_chat_history              | 채팅 이력                |
| **채팅**     | TbChatSessions              | tb_chat_sessions             | 채팅 세션                |
| **채팅**     | TbChatFeedback              | tb_chat_feedback             | 채팅 피드백               |
| **검색/분석**  | TbKnowledgeAccessLog        | tb_knowledge_access_log      | 지식 접근 로그             |
| **검색/분석**  | TbKnowledgeSharingLog       | tb_knowledge_sharing_log     | 지식 공유 로그             |
| **검색/분석**  | TbSearchAnalytics           | tb_search_analytics          | 검색 분석 데이터            |
| **핵심 시스템** | TbCmnsCdGrpItem             | tb_cmns_cd_grp_item          | 공통 코드 그룹             |
| **핵심 시스템** | TbKnowledgeCategories       | tb_knowledge_categories      | 지식 카테고리              |
| **핵심 시스템** | TbContainerCategories       | tb_container_categories      | 컨테이너 카테고리            |
| **핵심 시스템** | TbSystemSettings            | tb_system_settings           | 시스템 설정               |
| **검색 사전**  | KorSearchWordSynonyms       | kor_search_word_synonyms     | 한국어 검색 동의어 사전        |
| **검색 사전**  | KorSearchWordTransform      | kor_search_word_transform    | 한국어 검색어 변환 사전        |

**주요 업데이트 (v2.0)**:
- 학술 서지정보 관리를 위한 5개 테이블 추가
- JWT 리프레시 토큰 관리 테이블 추가
- 멀티모달 검색을 위한 CLIP 벡터 지원
- 다국어 검색(한국어/영어)을 위한 tsvector 컬럼 확장
- Azure Blob Storage 연동을 위한 blob_key 필드 추가

## 3. 인증 및 권한 관리 모델

### 3.1 TbSapHrInfo (SAP 인사 정보)

**테이블명**: `tb_sap_hr_info`  
**목적**: SAP 시스템과 연동하여 조직도 및 인사 정보 관리

| 컬럼명                | 타입          | 제약조건        | 설명             |
| ------------------ | ----------- | ----------- | -------------- |
| emp_no             | String(20)  | PRIMARY KEY | 사번             |
| emp_nm             | String(100) | NOT NULL    | 직원명            |
| dept_cd            | String(20)  |             | 부서 코드          |
| dept_nm            | String(100) |             | 부서명            |
| postn_cd           | String(20)  |             | 직급 코드          |
| postn_nm           | String(100) |             | 직급명            |
| email              | String(200) |             | 이메일            |
| telno              | String(20)  |             | 전화번호           |
| mbtlno             | String(20)  |             | 휴대폰번호          |
| entrps_de          | String(8)   |             | 입사일 (YYYYMMDD) |
| rsgntn_de          | String(8)   |             | 퇴사일 (YYYYMMDD) |
| emp_stats_cd       | String(10)  |             | 재직 상태          |
| del_yn             | String(1)   | DEFAULT 'N' | 삭제 여부          |
| created_by         | String(50)  |             | 생성자            |
| created_date       | DateTime    |             | 생성일            |
| last_modified_by   | String(50)  |             | 최종 수정자         |
| last_modified_date | DateTime    |             | 최종 수정일         |

**인덱스**:
- idx_tb_sap_hr_info_dept_cd (dept_cd)
- idx_tb_sap_hr_info_email (email)
- idx_tb_sap_hr_info_emp_stats_cd (emp_stats_cd)
- idx_tb_sap_hr_info_del_yn (del_yn)

### 3.2 User (ABEKM 사용자)

**테이블명**: `tb_user`  
**목적**: ABEKM 시스템 사용자 인증 및 기본 정보 관리

| 컬럼명                   | 타입          | 제약조건                        | 설명          |
| --------------------- | ----------- | --------------------------- | ----------- |
| id                    | Integer     | PRIMARY KEY, AUTO_INCREMENT | 사용자 ID      |
| emp_no                | String(20)  | NOT NULL, UNIQUE            | 사번          |
| username              | String(50)  | NOT NULL                    | 사용자명        |
| email                 | String(200) | NOT NULL, UNIQUE            | 이메일         |
| password_hash         | String(255) | NOT NULL                    | 해시된 비밀번호    |
| is_active             | Boolean     | DEFAULT TRUE                | 활성화 여부      |
| is_admin              | Boolean     | DEFAULT FALSE               | 관리자 여부      |
| last_login            | DateTime    |                             | 마지막 로그인 날짜  |
| failed_login_attempts | Integer     | DEFAULT 0                   | 로그인 실패 횟수   |
| account_locked_until  | DateTime    |                             | 계정 잠금 해제 시간 |
| created_date          | DateTime    | NOT NULL                    | 생성일         |
| last_modified_date    | DateTime    | NOT NULL                    | 최종 수정일      |

**관계**:
- sap_hr_info: TbSapHrInfo (emp_no 기준)
- refresh_tokens: RefreshToken (user_id 기준)

**인덱스**:
- idx_tb_user_emp_no (emp_no)
- idx_tb_user_email (email)
- idx_tb_user_is_active (is_active)

### 3.3 RefreshToken (JWT 리프레시 토큰)

**테이블명**: `tb_refresh_tokens`  
**목적**: JWT 리프레시 토큰 저장 및 세션 관리

| 컬럼명           | 타입          | 제약조건                        | 설명                   |
| ------------- | ----------- | --------------------------- | -------------------- |
| id            | Integer     | PRIMARY KEY, AUTO_INCREMENT | 토큰 ID                |
| user_id       | Integer     | FK, NOT NULL                | 사용자 ID (tb_user 참조)  |
| emp_no        | String(20)  | NOT NULL                    | 사번                   |
| jti           | String(64)  | NOT NULL, UNIQUE            | JWT ID (토큰 고유 식별자)   |
| token_hash    | String(255) | NOT NULL                    | 해시된 리프레시 토큰          |
| user_agent    | Text        |                             | 사용자 에이전트            |
| ip_address    | String(45)  |                             | IP 주소 (IPv6 지원)      |
| created_at    | DateTime TZ | NOT NULL, DEFAULT NOW()     | 생성 시각                |
| expires_at    | DateTime TZ | NOT NULL                    | 만료 시각                |
| rotated_at    | DateTime TZ |                             | 토큰 갱신 시각             |
| revoked_at    | DateTime TZ |                             | 폐기 시각                |
| revoke_reason | Text        |                             | 폐기 사유                |
| is_active     | Boolean     | DEFAULT TRUE                | 활성화 여부 (폐기 시 FALSE) |

**관계**:
- user: User (user_id 기준, ON DELETE CASCADE)

**인덱스**:
- uq_tb_refresh_tokens_jti (jti, UNIQUE) - JWT ID 고유성 보장
- idx_tb_refresh_tokens_user_id (user_id)
- idx_tb_refresh_tokens_emp_no (emp_no)
- idx_tb_refresh_tokens_expires (expires_at) - 만료 토큰 정리 최적화
- idx_tb_refresh_tokens_active (is_active)

**특징**:
- JWT 토큰 탈취 방지를 위한 토큰 회전(rotation) 지원
- 세션별 디바이스 추적 (user_agent, ip_address)
- 토큰 폐기 이력 관리 (revoked_at, revoke_reason)

### 3.4 TbKnowledgeContainers (지식 컨테이너)

**테이블명**: `tb_knowledge_containers`  
**목적**: 계층형 조직 구조 기반 지식 컨테이너 관리

| 컬럼명                         | 타입            | 제약조건                 | 설명              |
| --------------------------- | ------------- | -------------------- | --------------- |
| container_id                | String(50)    | PRIMARY KEY          | 컨테이너 ID         |
| container_name              | String(200)   | NOT NULL             | 컨테이너 명          |
| parent_container_id         | String(50)    | FK                   | 상위 컨테이너 ID      |
| container_type              | String(20)    | DEFAULT 'department' | 컨테이너 유형         |
| sap_org_code                | String(20)    |                      | SAP 조직 코드       |
| sap_cost_center             | String(20)    |                      | SAP 코스트 센터      |
| org_level                   | Integer       | DEFAULT 1            | 조직 레벨           |
| org_path                    | Text          |                      | 조직 경로           |
| description                 | Text          |                      | 컨테이너 설명         |
| knowledge_category          | String(50)    |                      | 주요 지식 분야        |
| access_level                | String(20)    | DEFAULT 'internal'   | 접근 수준           |
| default_permission          | String(20)    | DEFAULT 'VIEWER'     | 기본 권한 레벨        |
| inherit_parent_permissions  | Boolean       | DEFAULT TRUE         | 상위 권한 상속 여부     |
| permission_inheritance_type | String(20)    | DEFAULT 'additive'   | 권한 상속 방식        |
| container_owner             | String(20)    | FK                   | 컨테이너 소유자        |
| permission_managers         | ARRAY(String) |                      | 권한 관리자 목록       |
| auto_assign_by_org          | Boolean       | DEFAULT TRUE         | 조직도 기반 자동 권한 할당 |
| require_approval_for_access | Boolean       | DEFAULT FALSE        | 접근 시 승인 필요      |
| approval_workflow_enabled   | Boolean       | DEFAULT FALSE        | 승인 워크플로우        |
| approvers                   | ARRAY(String) |                      | 승인자 목록          |
| is_active                   | Boolean       | DEFAULT TRUE         | 활성화 여부          |
| document_count              | Integer       | DEFAULT 0            | 문서 수            |
| total_knowledge_size        | BigInteger    | DEFAULT 0            | 총 지식 크기         |
| last_knowledge_update       | DateTime      |                      | 마지막 지식 업데이트     |
| user_count                  | Integer       | DEFAULT 0            | 접근 권한 사용자 수     |
| permission_request_count    | Integer       | DEFAULT 0            | 권한 요청 건수        |
| last_permission_update      | DateTime      |                      | 마지막 권한 변경 시간    |
| created_by                  | String(20)    |                      | 생성자             |
| created_date                | DateTime      | DEFAULT NOW()        | 생성일             |
| last_modified_by            | String(20)    |                      | 최종 수정자          |
| last_modified_date          | DateTime      | DEFAULT NOW()        | 최종 수정일          |

**관계**:
- parent_container: TbKnowledgeContainers (자기 참조)
- child_containers: TbKnowledgeContainers (자기 참조)
- owner: TbSapHrInfo (container_owner 기준)
- user_permissions: TbUserPermissions
- permission_requests: TbPermissionRequests

## 4. 문서 관리 모델

### 4.1 TbFileBssInfo (파일 기본 정보)

**테이블명**: `tb_file_bss_info`  
**목적**: 업로드된 파일의 기본 정보 및 메타데이터 관리

| 컬럼명                    | 타입          | 제약조건                        | 설명            |
| ---------------------- | ----------- | --------------------------- | ------------- |
| file_bss_info_sno      | Integer     | PRIMARY KEY, AUTO_INCREMENT | 파일 기본 정보 일련번호 |
| drcy_sno               | Integer     | NOT NULL                    | 디렉토리 일련번호     |
| file_dtl_info_sno      | Integer     |                             | 파일 상세 정보 일련번호 |
| file_lgc_nm            | String(255) | NOT NULL                    | 파일 논리명        |
| file_psl_nm            | String(255) | NOT NULL                    | 파일 물리명        |
| file_extsn             | String(10)  | NOT NULL                    | 파일 확장자        |
| path                   | String(500) | NOT NULL                    | 파일 저장 경로      |
| del_yn                 | CHAR(1)     | DEFAULT 'N'                 | 삭제 여부         |
| korean_metadata        | JSON        |                             | 한국어 메타데이터     |
| chunk_count            | Integer     | DEFAULT 0                   | 청크 개수         |
| knowledge_container_id | String(50)  |                             | 지식 컨테이너 ID    |
| permission_level       | String(20)  | DEFAULT 'INTERNAL'          | 권한 레벨         |
| access_restrictions    | JSONB       |                             | 접근 제한         |
| owner_emp_no           | String(20)  |                             | 소유자 사번        |
| last_accessed_date     | DateTime    |                             | 마지막 접근일       |
| access_count           | Integer     | DEFAULT 0                   | 접근 횟수         |
| created_by             | String(50)  |                             | 생성자 ID        |
| created_date           | DateTime    | DEFAULT NOW()               | 생성일시          |
| last_modified_by       | String(50)  |                             | 최종 수정자 ID     |
| last_modified_date     | DateTime    | DEFAULT NOW()               | 최종 수정일시       |

**인덱스**:
- idx_tb_file_bss_info_del_yn (del_yn)
- idx_file_bss_info_container (knowledge_container_id)
- idx_file_bss_info_owner (owner_emp_no)
- idx_file_bss_info_permission (permission_level)
- idx_file_bss_info_accessed (last_accessed_date)

### 4.2 TbFileDtlInfo (파일 상세 정보)

**테이블명**: `tb_file_dtl_info`  
**목적**: 파일의 상세 메타데이터 및 분석 정보 관리

| 컬럼명                | 타입           | 제약조건                        | 설명             |
| ------------------ | ------------ | --------------------------- | -------------- |
| file_dtl_info_sno  | Integer      | PRIMARY KEY, AUTO_INCREMENT | 파일 상세 정보 일련번호  |
| sj                 | String(500)  |                             | 파일 제목          |
| cn                 | Text         |                             | 파일 내용 요약       |
| kwrd               | String(1000) |                             | 키워드 (콤마 구분)    |
| authr              | String(100)  |                             | 작성자            |
| wrt_de             | String(8)    |                             | 작성일 (YYYYMMDD) |
| updt_de            | String(8)    |                             | 수정일 (YYYYMMDD) |
| ctgry_cd           | String(20)   |                             | 카테고리 코드        |
| ctgry_nm           | String(100)  |                             | 카테고리명          |
| file_sz            | Integer      |                             | 파일 크기 (bytes)  |
| page_co            | Integer      |                             | 페이지 수          |
| lang_cd            | String(10)   |                             | 언어 코드          |
| secrty_lvl         | String(10)   |                             | 보안 등급          |
| vrsn               | String(20)   |                             | 버전             |
| tag                | String(500)  |                             | 태그 (콤마 구분)     |
| sumry              | Text         |                             | 요약             |
| del_yn             | CHAR(1)      | DEFAULT 'N'                 | 삭제 여부          |
| created_by         | String(50)   |                             | 생성자 ID         |
| created_date       | DateTime     | DEFAULT NOW()               | 생성일시           |
| last_modified_by   | String(50)   |                             | 최종 수정자 ID      |
| last_modified_date | DateTime     | DEFAULT NOW()               | 최종 수정일시        |

**인덱스**:
- idx_tb_file_dtl_info_sj (sj)
- idx_tb_file_dtl_info_authr (authr)
- idx_tb_file_dtl_info_ctgry_cd (ctgry_cd)
- idx_tb_file_dtl_info_del_yn (del_yn)

### 4.3 VsDocContentsChunks (문서 벡터 청킹)

**테이블명**: `vs_doc_contents_chunks`  
**목적**: pgvector 기반 문서 내용 벡터화 및 청킹 관리

| 컬럼명               | 타입           | 제약조건          | 설명              |
| ----------------- | ------------ | ------------- | --------------- |
| chunk_id          | String(50)   | PRIMARY KEY   | 청크 ID           |
| file_bss_info_sno | Integer      | FK            | 파일 기본 정보 일련번호   |
| chunk_index       | Integer      | NOT NULL      | 청크 순서           |
| chunk_text        | Text         | NOT NULL      | 청크 텍스트          |
| chunk_summary     | Text         |               | 청크 요약           |
| embedding_vector  | Vector(1024) |               | 임베딩 벡터 (1024차원) |
| korean_tokens     | JSONB        |               | 한국어 토큰 정보       |
| chunk_metadata    | JSONB        |               | 청크 메타데이터        |
| token_count       | Integer      | DEFAULT 0     | 토큰 수            |
| character_count   | Integer      | DEFAULT 0     | 문자 수            |
| created_date      | DateTime     | DEFAULT NOW() | 생성일시            |
| last_updated      | DateTime     | DEFAULT NOW() | 최종 업데이트일        |

**관계**:
- file_info: TbFileBssInfo (file_bss_info_sno 기준)

**인덱스**:
- idx_vs_doc_contents_chunks_file (file_bss_info_sno)
- idx_vs_doc_contents_chunks_embedding (embedding_vector) USING hnsw
- idx_vs_doc_contents_chunks_tokens (token_count)

### 4.4 TbDocumentSearchIndex (통합 검색 인덱스)

**테이블명**: `tb_document_search_index`  
**목적**: 하이브리드 + 멀티모달 + 다국어 검색을 위한 통합 검색 인덱스

| 컬럼명                      | 타입            | 제약조건                     | 설명                            |
| ------------------------ | ------------- | ------------------------ | ----------------------------- |
| search_doc_id            | Integer       | PRIMARY KEY, SERIAL      | 검색 문서 ID (자동 증번)              |
| file_bss_info_sno        | Integer       | FK, NOT NULL             | 파일 기본 정보 일련번호                 |
| knowledge_container_id   | String(50)    | FK, NOT NULL             | 지식 컨테이너 ID                    |
| document_title           | String(500)   |                          | 문서 제목                         |
| full_content             | Text          | NOT NULL                 | 문서 전체 내용                      |
| content_summary          | Text          |                          | 문서 요약                         |
| main_topics              | Text[]        |                          | 주요 주제 배열                      |
| document_type            | String(50)    |                          | 문서 타입 (pdf/docx/pptx 등)       |
| page_count               | Integer       |                          | 페이지 수                         |
| content_length           | Integer       |                          | 내용 길이 (문자 수)                  |
| language_code            | String(10)    | NOT NULL                 | 언어 코드 (ko/en 등)               |
| keyword_tsvector         | TSVector      |                          | 한국어 키워드 검색용 tsvector          |
| content_tsvector         | TSVector      |                          | 한국어 내용 검색용 tsvector           |
| keyword_tsvector_en      | TSVector      |                          | 영어 키워드 검색용 tsvector           |
| content_tsvector_en      | TSVector      |                          | 영어 내용 검색용 tsvector            |
| search_weight            | Integer       | NOT NULL                 | 검색 가중치                        |
| access_level             | String(20)    | NOT NULL                 | 접근 레벨                         |
| is_public                | Boolean       | NOT NULL                 | 공개 여부                         |
| indexing_status          | String(20)    | NOT NULL                 | 인덱싱 상태 (indexed/processing)   |
| last_searched_at         | DateTime TZ   |                          | 마지막 검색 시각                     |
| search_count             | Integer       | NOT NULL, DEFAULT 0      | 검색 횟수                         |
| created_date             | DateTime TZ   | NOT NULL, DEFAULT NOW()  | 생성일시                          |
| last_updated             | DateTime TZ   | NOT NULL, DEFAULT NOW()  | 최종 업데이트일                      |
| primary_chunk_session_id | BigInteger    |                          | 대표 청킹 세션 ID (멀티모달)            |
| last_embedding_model     | String(100)   |                          | 마지막 임베딩 생성 모델명                |
| has_table                | Boolean       | DEFAULT FALSE            | 표(Table) 포함 여부 (레거시)          |
| has_image                | Boolean       | DEFAULT FALSE            | 이미지 포함 여부 (레거시)               |
| extraction_session_id    | BigInteger    |                          | 추출 세션 ID                      |
| has_images               | Boolean       | NOT NULL, DEFAULT FALSE  | 이미지 포함 여부 (최신)                |
| has_tables               | Boolean       | NOT NULL, DEFAULT FALSE  | 표 포함 여부 (최신)                  |
| image_count              | Integer       | NOT NULL, DEFAULT 0      | 이미지 개수                        |
| table_count              | Integer       | NOT NULL, DEFAULT 0      | 표 개수                          |
| images_metadata          | JSONB         |                          | 이미지 메타데이터 (크기, 타입, 경로 등)      |

**관계**:
- file_info: TbFileBssInfo (file_bss_info_sno 기준, ON DELETE CASCADE)
- container: TbKnowledgeContainers (knowledge_container_id 기준)

**인덱스**:
- tb_document_search_index_pkey (search_doc_id, PRIMARY KEY)
- idx_search_file_access (file_bss_info_sno, access_level) - 권한 필터링 최적화
- idx_search_container_type (knowledge_container_id, document_type) - 컨테이너별 문서 타입 필터
- idx_search_container_status_fts (knowledge_container_id, indexing_status WHERE indexed) - 검색 대상만 필터
- idx_search_status (indexing_status) - 인덱싱 상태 관리
- idx_search_updated (last_updated) - 증분 업데이트 최적화
- idx_search_topics (main_topics) USING GIN - 주제 검색
- idx_search_multimodal (has_images, image_count) - 멀티모달 필터
- idx_search_has_images (has_images) - 이미지 문서 필터
- idx_search_images_metadata (images_metadata) USING GIN - 이미지 메타 검색
- idx_search_keyword_tsvector (keyword_tsvector) USING GIN - 한국어 키워드 FTS
- idx_search_content_tsvector (content_tsvector) USING GIN - 한국어 내용 FTS
- idx_search_keyword_tsvector_en (keyword_tsvector_en) USING GIN - 영어 키워드 FTS
- idx_search_content_tsvector_en (content_tsvector_en) USING GIN - 영어 내용 FTS
- idx_search_document_title_trgm (document_title) USING GIN (gin_trgm_ops) - 제목 유사도 검색
- idx_search_full_content_trgm (full_content) USING GIN (gin_trgm_ops) - 내용 유사도 검색

**트리거**:
- tsvector_update_keyword: document_title, content_summary 변경 시 keyword_tsvector 자동 업데이트
- tsvector_update_content: full_content 변경 시 content_tsvector 자동 업데이트

**특징 (v2.0 업데이트)**:
- 다국어 검색 지원: 한국어(keyword_tsvector, content_tsvector) + 영어(keyword_tsvector_en, content_tsvector_en)
- 멀티모달 메타데이터: has_images, has_tables, image_count, table_count, images_metadata
- Trigram 인덱스: 오타 허용 유사도 검색 (pg_trgm 확장 활용)
- 검색 분석: search_count, last_searched_at으로 인기 문서 추적
| primary_chunk_session_id | BigInteger    |                    | 대표(기준) 청킹 세션 ID (멀티모달 기준 세션)                |
| last_embedding_model     | String(100)   |                    | 마지막 임베딩 생성 모델명                              |
| has_table                | Boolean       | DEFAULT FALSE      | 표(Table) 데이터 포함 여부                          |
| has_image                | Boolean       | DEFAULT FALSE      | 이미지/비주얼 객체 포함 여부                            |
| extraction_session_id    | BigInteger    |                    | 연결된 추출 세션 ID (doc_extraction_session FK 예정) |

**추가 설명 (2025-09-30 확장)**:
- `primary_chunk_session_id`: 동일 문서가 여러 청킹 전략을 거친 경우 대표 검색용 세션을 지정.
- `last_embedding_model`: 재임베딩/모델 교체 시 어떤 모델이 최신인지 관리 → 재처리 배치 대상 선별.
- `has_table` / `has_image`: UI 필터 및 멀티모달 재랭킹/가중치 전략에 활용.
- `extraction_session_id`: 역추적(어떤 추출 파이프라인/프로바이더로 생성되었는지) 및 재처리 링크.

### 4.5 DocExtractionSession (멀티모달 추출 세션)

**테이블명**: `doc_extraction_session`  
**목적**: 문서 단위 추출 실행(파서/프로바이더/모델 조합) 메타 관리. 재처리/장애 진단/비교 분석을 위한 기준.

| 컬럼명                   | 타입          | 제약조건            | 설명                                 |
| --------------------- | ----------- | --------------- | ---------------------------------- |
| extraction_session_id | BigInteger  | PRIMARY KEY     | 추출 세션 ID                           |
| file_bss_info_sno     | BigInteger  | FK              | 대상 파일                              |
| provider              | String(50)  | NOT NULL        | 추출 제공자 (azure, local, ocr 등)       |
| model_profile         | String(50)  |                 | 적용 모델/프로파일 명 (ex: layout-v1)       |
| pipeline_type         | String(20)  | DEFAULT 'azure' | 파이프라인 유형 (azure/opensource 등)      |
| started_at            | DateTime TZ |                 | 시작 시각                              |
| completed_at          | DateTime TZ |                 | 완료 시각                              |
| status                | String(20)  | DEFAULT running | 상태(running/success/failed/partial) |
| page_count_detected   | Integer     |                 | 감지된 페이지 수                          |
| error_message         | Text        |                 | 실패 시 에러 메시지                        |

**인덱스**:
- idx_extraction_session_file (file_bss_info_sno)
- idx_extraction_session_status (status)

### 4.6 DocExtractedObject (추출 객체)

**테이블명**: `doc_extracted_object`  
**목적**: 페이지 단위 또는 레이아웃 분석 결과에서 얻어진 원자적 객체(텍스트 블록/표/이미지 등) 저장.

| 컬럼명                   | 타입           | 제약조건         | 설명                                           |
| --------------------- | ------------ | ------------ | -------------------------------------------- |
| object_id             | BigInteger   | PRIMARY KEY  | 추출 객체 ID                                     |
| extraction_session_id | BigInteger   | FK           | 소속 추출 세션                                     |
| file_bss_info_sno     | BigInteger   |              | 파일 참조 (冗長 저장으로 조인 비용 감소)                     |
| page_no               | Integer      |              | 페이지 번호                                       |
| object_type           | String(20)   | NOT NULL     | TEXT_BLOCK / TABLE / IMAGE / HEADER / FOOTER |
| sequence_in_page      | Integer      |              | 페이지 내 순서                                     |
| bbox                  | INT[]        |              | 경계 박스 [x1,y1,x2,y2]                          |
| content_text          | Text         |              | 텍스트 콘텐츠 (이미지/표의 경우 추출 텍스트)                   |
| structure_json        | JSONB        |              | 구조 정보 (표 셀 구조, 레이아웃 메타 등)                    |
| lang_code             | String(10)   | DEFAULT 'ko' | 언어 코드                                        |
| char_count            | Integer      |              | 문자 수                                         |
| token_estimate        | Integer      |              | 추정 토큰 수 (프롬프트 비용 추정)                         |
| confidence            | Numeric(5,2) |              | 추출 신뢰도                                       |
| hash_sha256           | String(64)   |              | 중복/캐싱 식별 해시                                  |
| created_at            | DateTime TZ  |              | 생성 시각                                        |

**인덱스**:
- idx_extracted_object_file_page (file_bss_info_sno, page_no)
- idx_extracted_object_type (object_type)
- idx_extracted_object_hash (hash_sha256)

### 4.7 DocChunkSession (청킹 세션)

**테이블명**: `doc_chunk_session`  
**목적**: 특정 추출 세션의 결과를 어떤 전략/파라미터로 청킹했는지 버전 관리.

| 컬럼명                   | 타입          | 제약조건            | 설명                           |
| --------------------- | ----------- | --------------- | ---------------------------- |
| chunk_session_id      | BigInteger  | PRIMARY KEY     | 청킹 세션 ID                     |
| file_bss_info_sno     | BigInteger  | FK              | 파일 참조                        |
| extraction_session_id | BigInteger  | FK              | 원본 추출 세션                     |
| strategy_name         | String(50)  | NOT NULL        | 청킹 전략명 (sliding, semantic 등) |
| params_json           | JSONB       |                 | 파라미터(윈도우 크기, overlap 등)      |
| started_at            | DateTime TZ |                 | 시작 시각                        |
| completed_at          | DateTime TZ |                 | 완료 시각                        |
| status                | String(20)  | DEFAULT running | 상태(running/success/failed)   |
| chunk_count           | Integer     |                 | 생성된 청크 수                     |

**인덱스**:
- idx_chunk_session_file (file_bss_info_sno, strategy_name)
- idx_chunk_session_status (status)

### 4.8 DocChunk (멀티모달 청크)

**테이블명**: `doc_chunk`  
**목적**: 하나 이상의 원본 객체를 묶어 검색 단위로 사용하는 텍스트/표/이미지 캡션/혼합 영역.

| 컬럼명               | 타입           | 제약조건         | 설명                               |
| ----------------- | ------------ | ------------ | -------------------------------- |
| chunk_id          | BigInteger   | PRIMARY KEY  | 청크 ID (자동 증번)                    |
| chunk_session_id  | BigInteger   | FK           | 소속 청킹 세션                         |
| file_bss_info_sno | BigInteger   | NOT NULL     | 파일 참조 (冗長 저장)                    |
| chunk_index       | Integer      | NOT NULL     | 세션 내 순번                          |
| source_object_ids | BIGINT[]     | NOT NULL     | 구성한 원본 object_id 배열              |
| content_text      | Text         | NOT NULL     | 청크 텍스트(표/이미지 캡션 포함)              |
| token_count       | Integer      |              | 토큰 수                             |
| char_count        | Integer      |              | 문자 수                             |
| modality          | String(20)   | DEFAULT text | text/table/image/mixed 등 모달리티 구분 |
| section_heading   | Text         |              | 상위 섹션/헤더 추출 값                    |
| page_range        | INT4RANGE    |              | 포함 페이지 범위 (PostgreSQL 범위 타입)     |
| blob_key          | String(500)  |              | Azure Blob Storage 파일 경로 (이미지/표) |
| quality_score     | Numeric(5,2) |              | 품질/랭킹 사전 점수 (옵션)                 |
| created_at        | DateTime TZ  | DEFAULT NOW  | 생성 시각                            |

**관계**:
- chunk_session: DocChunkSession (chunk_session_id 기준, ON DELETE CASCADE)
- embeddings: DocEmbedding (chunk_id 기준, cascade)

**인덱스**:
- doc_chunk_pkey (chunk_id, PRIMARY KEY)
- idx_doc_chunk_file (file_bss_info_sno)
- idx_doc_chunk_session (chunk_session_id)
- idx_doc_chunk_modality (modality)
- ix_doc_chunk_blob_key (blob_key)

**특징 (v2.0 업데이트)**:
- blob_key 필드: 이미지/표 청크의 경우 Azure Blob Storage 경로 저장 (wkms-intermediate 컨테이너)
- char_count 필드: 토큰 외 문자 수 추가 (다국어 대응)
- INT4RANGE: PostgreSQL 네이티브 범위 타입으로 페이지 범위 효율적 저장

### 4.9 DocEmbedding (임베딩)

**테이블명**: `doc_embedding`  
**목적**: 청크별 모델/모달리티 조합 임베딩 저장. 듀얼 벡터 전략으로 텍스트 검색과 멀티모달 검색 동시 지원.

| 컬럼명               | 타입          | 제약조건                   | 설명                                         |
| ----------------- | ----------- | ---------------------- | ------------------------------------------ |
| embedding_id      | BigInteger  | PRIMARY KEY, SERIAL    | 임베딩 ID (자동 증번)                            |
| chunk_id          | BigInteger  | FK, NOT NULL           | 대응 청크                                      |
| file_bss_info_sno | BigInteger  | NOT NULL               | (冗長) 파일 참조                                 |
| model_name        | String(100) | NOT NULL               | 사용 모델명 (ex: text-embedding-3-small)        |
| modality          | String(20)  | DEFAULT 'text'         | text/table/image 등                         |
| dimension         | Integer     | NOT NULL               | vector 컬럼의 차원 (1536, 3072 등)               |
| vector            | Vector      |                        | 텍스트 임베딩 벡터 (동적 차원 지원)                     |
| clip_vector       | Vector(512) |                        | Azure CLIP 멀티모달 임베딩 (512차원 고정)            |
| norm_l2           | Double      |                        | L2 노름 (정규화/유사도 최적화용)                       |
| created_at        | DateTime TZ | DEFAULT NOW()          | 생성 시각                                      |

**관계**:
- chunk: DocChunk (chunk_id 기준, ON DELETE CASCADE)

**인덱스**:
- doc_embedding_pkey (embedding_id, PRIMARY KEY)
- doc_embedding_chunk_id_model_name_key (chunk_id, model_name, UNIQUE) - 중복 임베딩 방지
- idx_doc_embedding_model (model_name)
- idx_doc_embedding_file (file_bss_info_sno)
- idx_doc_embedding_multimodal_filter (file_bss_info_sno, modality) - 멀티모달 필터링 최적화
- idx_doc_embedding_clip_vector (clip_vector) USING hnsw (vector_cosine_ops) WITH (m=16, ef_construction=64)
- idx_doc_embedding_clip_vector_exists (clip_vector WHERE clip_vector IS NOT NULL) - CLIP 벡터 존재 여부 필터

**특징 (v2.0 업데이트)**:
- **듀얼 벡터 전략**:
  - `vector`: 텍스트 전용 임베딩 (1536d, 3072d 등 동적 차원)
  - `clip_vector`: Azure CLIP 멀티모달 임베딩 (512d 고정) - 이미지/텍스트 크로스 모달 검색
- **HNSW 인덱스**: clip_vector에 대해 코사인 유사도 기반 고속 검색
  - m=16: 각 레이어 최대 연결 수 (검색 속도와 정확도 균형)
  - ef_construction=64: 인덱스 생성 시 탐색 깊이 (품질 향상)
- **재임베딩 지원**: (chunk_id, model_name) 복합 UNIQUE 제약으로 모델별 버전 관리
- **모달리티별 벡터**: text는 vector만, image는 clip_vector만, mixed는 둘 다 저장 가능

## 4.10 학술 서지정보 모델 (Academic Bibliographic Models)

### 4.10.1 TbAcademicDocumentMetadata (학술논문 서지 메타데이터)

**테이블명**: `tb_academic_document_metadata`  
**목적**: 학술논문 PDF의 서지정보 (제목, 초록, DOI, 저널 등) 관리

| 컬럼명               | 타입            | 제약조건                 | 설명                                |
| ----------------- | ------------- | -------------------- | --------------------------------- |
| file_bss_info_sno | Integer       | PRIMARY KEY, FK      | 파일 기본 정보 일련번호 (tb_file_bss_info) |
| title             | String(1000)  |                      | 논문 제목                             |
| abstract          | Text          |                      | 초록                                |
| doi               | String(200)   | UNIQUE               | DOI (Digital Object Identifier)   |
| journal           | String(300)   |                      | 저널명                               |
| volume            | String(50)    |                      | 권(Volume)                         |
| issue             | String(50)    |                      | 호(Issue)                          |
| year              | String(4)     |                      | 출판 연도                             |
| pages             | String(50)    |                      | 페이지 범위 (예: 123-145)              |
| publisher         | String(200)   |                      | 출판사                               |
| issn              | String(50)    |                      | ISSN (International Standard Serial Number) |
| isbn              | String(50)    |                      | ISBN (International Standard Book Number) |
| language_code     | String(10)    |                      | 언어 코드 (ko/en 등)                   |
| keywords          | Text[]        |                      | 키워드 배열                            |
| publication_date  | Date          |                      | 출판일                               |
| accepted_date     | Date          |                      | 게재 승인일                            |
| created_date      | DateTime TZ   | NOT NULL, DEFAULT NOW() | 생성일시                              |

**관계**:
- file: TbFileBssInfo (file_bss_info_sno 기준, ON DELETE CASCADE)
- authors: TbAcademicDocumentAuthors (역참조, cascade)
- references: TbAcademicReferences (역참조, cascade)

**인덱스**:
- tb_academic_document_metadata_pkey (file_bss_info_sno, PRIMARY KEY)
- idx_acad_doc_doi (doi, UNIQUE)
- idx_acad_doc_year_journal (year, journal) - 연도별/저널별 조회 최적화
- idx_acad_doc_keywords (keywords) USING GIN - 키워드 검색

### 4.10.2 TbAcademicAuthors (학술논문 저자)

**테이블명**: `tb_academic_authors`  
**목적**: 학술논문 저자 정보 (이름, ORCID, 이메일 등) 중복 제거 관리

| 컬럼명          | 타입            | 제약조건                    | 설명                   |
| ------------ | ------------- | ----------------------- | -------------------- |
| author_id    | BigInteger    | PRIMARY KEY, SERIAL     | 저자 ID (자동 증번)        |
| full_name    | String(300)   | NOT NULL                | 전체 이름 (Full Name)    |
| given_name   | String(150)   |                         | 이름 (Given Name)      |
| family_name  | String(150)   |                         | 성 (Family Name)      |
| orcid        | String(50)    | UNIQUE                  | ORCID (연구자 고유 식별자)   |
| email        | String(200)   |                         | 이메일                  |
| created_date | DateTime TZ   | NOT NULL, DEFAULT NOW() | 생성일시                 |

**관계**:
- documents: TbAcademicDocumentAuthors (역참조, cascade)

**인덱스**:
- tb_academic_authors_pkey (author_id, PRIMARY KEY)
- idx_author_full_name (full_name) - 이름 검색 최적화
- idx_author_orcid (orcid, UNIQUE) - ORCID 고유성 보장

### 4.10.3 TbAcademicAffiliations (학술논문 소속기관)

**테이블명**: `tb_academic_affiliations`  
**목적**: 저자 소속기관 정보 중복 제거 관리

| 컬럼명            | 타입            | 제약조건                    | 설명             |
| -------------- | ------------- | ----------------------- | -------------- |
| affiliation_id | BigInteger    | PRIMARY KEY, SERIAL     | 소속기관 ID (자동 증번) |
| institution    | String(300)   |                         | 기관명            |
| department     | String(300)   |                         | 부서명            |
| country        | String(100)   |                         | 국가             |
| created_date   | DateTime TZ   | NOT NULL, DEFAULT NOW() | 생성일시           |

**관계**:
- authors: TbAcademicDocumentAuthors (역참조)

**인덱스**:
- tb_academic_affiliations_pkey (affiliation_id, PRIMARY KEY)
- idx_affiliation_institution (institution) - 기관명 검색 최적화

### 4.10.4 TbAcademicDocumentAuthors (학술논문-저자 매핑)

**테이블명**: `tb_academic_document_authors`  
**목적**: 논문과 저자의 다대다 관계 + 저자 순서 및 소속 정보

| 컬럼명                  | 타입         | 제약조건                    | 설명                  |
| -------------------- | ---------- | ----------------------- | ------------------- |
| file_bss_info_sno    | Integer    | PRIMARY KEY (복합), FK   | 논문 파일 ID           |
| author_id            | BigInteger | PRIMARY KEY (복합), FK   | 저자 ID              |
| author_order         | Integer    | NOT NULL                | 저자 순서 (1, 2, 3...)  |
| affiliation_id       | BigInteger | FK                      | 소속기관 ID            |
| corresponding_author | Boolean    | NOT NULL, DEFAULT FALSE | 교신저자 여부            |
| created_date         | DateTime TZ | NOT NULL, DEFAULT NOW() | 생성일시               |

**관계**:
- document: TbAcademicDocumentMetadata (file_bss_info_sno 기준, ON DELETE CASCADE)
- author: TbAcademicAuthors (author_id 기준, ON DELETE CASCADE)
- affiliation: TbAcademicAffiliations (affiliation_id 기준)

**인덱스**:
- tb_academic_document_authors_pkey (file_bss_info_sno, author_id, PRIMARY KEY)
- idx_doc_authors_order (file_bss_info_sno, author_order) - 저자 순서 정렬 최적화

### 4.10.5 TbAcademicReferences (학술논문 참고문헌)

**테이블명**: `tb_academic_references`  
**목적**: 논문의 참고문헌 목록 및 인용 관계 관리

| 컬럼명               | 타입           | 제약조건                    | 설명                    |
| ----------------- | ------------ | ----------------------- | --------------------- |
| reference_id      | BigInteger   | PRIMARY KEY, SERIAL     | 참고문헌 ID (자동 증번)      |
| file_bss_info_sno | Integer      | FK, NOT NULL            | 논문 파일 ID             |
| ref_index         | Integer      | NOT NULL                | 참고문헌 순서 (1, 2, 3...) |
| raw_text          | Text         |                         | 원본 참고문헌 텍스트          |
| title             | String(1000) |                         | 참고문헌 제목              |
| authors           | Text         |                         | 참고문헌 저자 (문자열)        |
| year              | String(4)    |                         | 출판 연도                |
| doi               | String(200)  |                         | DOI                   |
| cited_paper_id    | Integer      | FK                      | 인용된 논문 ID (자기 참조)    |
| created_date      | DateTime TZ  | NOT NULL, DEFAULT NOW() | 생성일시                 |

**관계**:
- document: TbAcademicDocumentMetadata (file_bss_info_sno 기준, ON DELETE CASCADE)
- cited_paper: TbAcademicDocumentMetadata (cited_paper_id 기준, 자기 참조)

**인덱스**:
- tb_academic_references_pkey (reference_id, PRIMARY KEY)
- idx_ref_file_index (file_bss_info_sno, ref_index) - 논문별 참고문헌 순서 조회
- idx_ref_doi (doi) - DOI 기반 인용 관계 추적
- idx_ref_cited_paper (cited_paper_id) - 인용 관계 역방향 조회

**특징**:
- 학술논문 자동 파싱: Grobid, Science-Parse 등 활용
- 인용 네트워크 분석: cited_paper_id를 통한 논문 간 인용 관계 추적
- 참고문헌 자동 링크: DOI 매칭으로 시스템 내 다른 논문과 자동 연결

## 5. 채팅 및 대화 모델

### 5.1 TbChatSessions (채팅 세션)

**테이블명**: `tb_chat_sessions`  
**목적**: 사용자별 채팅 세션 관리

| 컬럼명                  | 타입          | 제약조건          | 설명         |
| -------------------- | ----------- | ------------- | ---------- |
| session_id           | String(50)  | PRIMARY KEY   | 세션 ID      |
| user_emp_no          | String(20)  | FK, NOT NULL  | 사용자 사번     |
| session_title        | String(200) |               | 세션 제목      |
| container_context    | String(50)  | FK            | 컨테이너 컨텍스트  |
| session_metadata     | JSONB       |               | 세션 메타데이터   |
| ai_model_config      | JSONB       |               | AI 모델 설정   |
| conversation_context | JSONB       |               | 대화 컨텍스트    |
| is_active            | Boolean     | DEFAULT TRUE  | 활성화 여부     |
| is_archived          | Boolean     | DEFAULT FALSE | 아카이브 여부    |
| created_date         | DateTime    | DEFAULT NOW() | 생성일시       |
| last_activity        | DateTime    | DEFAULT NOW() | 마지막 활동 시간  |
| total_messages       | Integer     | DEFAULT 0     | 총 메시지 수    |
| total_tokens_used    | Integer     | DEFAULT 0     | 사용된 총 토큰 수 |

**관계**:
- user: TbSapHrInfo (user_emp_no 기준)
- container: TbKnowledgeContainers (container_context 기준)
- chat_history: TbChatHistory (session_id 기준)

**인덱스**:
- idx_chat_sessions_user (user_emp_no)
- idx_chat_sessions_container (container_context)
- idx_chat_sessions_active (is_active, last_activity)
- idx_chat_sessions_created (created_date)

### 5.2 TbChatHistory (채팅 이력)

**테이블명**: `tb_chat_history`  
**목적**: 채팅 대화 내역 및 AI 응답 기록

| 컬럼명                  | 타입         | 제약조건          | 설명                             |
| -------------------- | ---------- | ------------- | ------------------------------ |
| message_id           | String(50) | PRIMARY KEY   | 메시지 ID                         |
| session_id           | String(50) | FK, NOT NULL  | 세션 ID                          |
| user_emp_no          | String(20) | FK, NOT NULL  | 사용자 사번                         |
| message_type         | String(20) | NOT NULL      | 메시지 유형 (user/assistant/system) |
| message_content      | Text       | NOT NULL      | 메시지 내용                         |
| message_role         | String(20) | NOT NULL      | 메시지 역할                         |
| response_metadata    | JSONB      |               | 응답 메타데이터                       |
| referenced_documents | JSONB      |               | 참조된 문서 정보                      |
| search_results       | JSONB      |               | 검색 결과 정보                       |
| ai_model_used        | String(50) |               | 사용된 AI 모델                      |
| prompt_tokens        | Integer    | DEFAULT 0     | 프롬프트 토큰 수                      |
| completion_tokens    | Integer    | DEFAULT 0     | 완성 토큰 수                        |
| total_tokens         | Integer    | DEFAULT 0     | 총 토큰 수                         |
| processing_time_ms   | Integer    |               | 처리 시간 (밀리초)                    |
| confidence_score     | FLOAT      |               | 신뢰도 점수                         |
| feedback_score       | Integer    |               | 피드백 점수 (1-5)                   |
| feedback_comment     | Text       |               | 피드백 코멘트                        |
| is_helpful           | Boolean    |               | 도움 여부                          |
| created_date         | DateTime   | DEFAULT NOW() | 생성일시                           |

**관계**:
- session: TbChatSessions (session_id 기준)
- user: TbSapHrInfo (user_emp_no 기준)

**인덱스**:
- idx_chat_history_session (session_id, created_date)
- idx_chat_history_user (user_emp_no, created_date)
- idx_chat_history_type (message_type)
- idx_chat_history_feedback (feedback_score)
- idx_chat_history_tokens (total_tokens)

### 5.3 TbChatFeedback (채팅 피드백)

**테이블명**: `tb_chat_feedback`  
**목적**: 채팅 응답에 대한 사용자 피드백 수집

| 컬럼명                    | 타입         | 제약조건                | 설명                           |
| ---------------------- | ---------- | ------------------- | ---------------------------- |
| feedback_id            | String(50) | PRIMARY KEY         | 피드백 ID                       |
| message_id             | String(50) | FK, NOT NULL        | 메시지 ID                       |
| session_id             | String(50) | FK, NOT NULL        | 세션 ID                        |
| user_emp_no            | String(20) | FK, NOT NULL        | 사용자 사번                       |
| feedback_type          | String(20) | NOT NULL            | 피드백 유형 (like/dislike/report) |
| rating                 | Integer    |                     | 평점 (1-5)                     |
| feedback_category      | String(50) |                     | 피드백 카테고리                     |
| feedback_comment       | Text       |                     | 피드백 상세 내용                    |
| improvement_suggestion | Text       |                     | 개선 제안                        |
| is_anonymous           | Boolean    | DEFAULT FALSE       | 익명 여부                        |
| admin_response         | Text       |                     | 관리자 응답                       |
| status                 | String(20) | DEFAULT 'submitted' | 처리 상태                        |
| created_date           | DateTime   | DEFAULT NOW()       | 생성일시                         |
| processed_date         | DateTime   |                     | 처리일시                         |

**관계**:
- message: TbChatHistory (message_id 기준)
- session: TbChatSessions (session_id 기준)
- user: TbSapHrInfo (user_emp_no 기준)

**인덱스**:
- idx_chat_feedback_message (message_id)
- idx_chat_feedback_user (user_emp_no, created_date)
- idx_chat_feedback_type (feedback_type)
- idx_chat_feedback_rating (rating)
- idx_chat_feedback_status (status)

## 6. 검색 및 분석 모델

### 6.1 TbKnowledgeAccessLog (지식 접근 로그)

**테이블명**: `tb_knowledge_access_log`  
**목적**: 지식 접근 패턴 분석 및 감사

| 컬럼명                  | 타입         | 제약조건          | 설명                                 |
| -------------------- | ---------- | ------------- | ---------------------------------- |
| log_id               | String(50) | PRIMARY KEY   | 로그 ID                              |
| user_emp_no          | String(20) | FK, NOT NULL  | 사용자 사번                             |
| access_type          | String(20) | NOT NULL      | 접근 유형 (search/download/view/share) |
| resource_type        | String(20) | NOT NULL      | 리소스 유형 (document/container/chat)   |
| resource_id          | String(50) |               | 리소스 ID                             |
| container_id         | String(50) | FK            | 컨테이너 ID                            |
| access_method        | String(20) |               | 접근 방법 (web/api/mobile)             |
| search_query         | Text       |               | 검색 쿼리                              |
| search_type          | String(20) |               | 검색 유형 (vector/keyword/hybrid)      |
| search_results_count | Integer    |               | 검색 결과 수                            |
| clicked_result_rank  | Integer    |               | 클릭한 결과 순위                          |
| response_time_ms     | Integer    |               | 응답 시간                              |
| client_info          | JSONB      |               | 클라이언트 정보                           |
| ip_address           | String(45) |               | IP 주소                              |
| user_agent           | Text       |               | 사용자 에이전트                           |
| referer              | Text       |               | 리퍼러                                |
| success              | Boolean    | DEFAULT TRUE  | 성공 여부                              |
| error_code           | String(20) |               | 에러 코드                              |
| error_message        | Text       |               | 에러 메시지                             |
| access_date          | DateTime   | DEFAULT NOW() | 접근 일시                              |

**관계**:
- user: TbSapHrInfo (user_emp_no 기준)
- container: TbKnowledgeContainers (container_id 기준)

**인덱스**:
- idx_knowledge_access_user (user_emp_no, access_date)
- idx_knowledge_access_type (access_type, access_date)
- idx_knowledge_access_container (container_id, access_date)
- idx_knowledge_access_search (search_query) USING gin
- idx_knowledge_access_date (access_date)
- idx_knowledge_access_success (success, access_date)

### 6.2 TbSearchAnalytics (검색 분석)

**테이블명**: `tb_search_analytics`  
**목적**: 검색 패턴 및 성능 분석

| 컬럼명                    | 타입         | 제약조건          | 설명                             |
| ---------------------- | ---------- | ------------- | ------------------------------ |
| analytics_id           | String(50) | PRIMARY KEY   | 분석 ID                          |
| search_query           | Text       | NOT NULL      | 검색 쿼리                          |
| query_hash             | String(64) |               | 쿼리 해시 (중복 분석용)                 |
| query_normalized       | Text       |               | 정규화된 쿼리                        |
| user_emp_no            | String(20) | FK            | 사용자 사번                         |
| search_type            | String(20) | NOT NULL      | 검색 유형 (vector/keyword/hybrid)  |
| search_scope           | String(50) |               | 검색 범위 (container_id 또는 global) |
| search_filters         | JSONB      |               | 적용된 필터                         |
| results_count          | Integer    | DEFAULT 0     | 결과 수                           |
| relevant_results_count | Integer    | DEFAULT 0     | 관련성 높은 결과 수                    |
| processing_time_ms     | Integer    |               | 처리 시간                          |
| vector_search_time_ms  | Integer    |               | 벡터 검색 시간                       |
| keyword_search_time_ms | Integer    |               | 키워드 검색 시간                      |
| clicked_results        | JSONB      |               | 클릭된 결과 정보                      |
| click_through_rate     | FLOAT      |               | 클릭률                            |
| average_click_position | FLOAT      |               | 평균 클릭 위치                       |
| search_score           | FLOAT      |               | 검색 점수                          |
| user_satisfaction      | Integer    |               | 사용자 만족도 (1-5)                  |
| bounce_rate            | FLOAT      |               | 이탈률                            |
| session_duration_ms    | Integer    |               | 세션 지속 시간                       |
| follow_up_searches     | Integer    | DEFAULT 0     | 후속 검색 수                        |
| result_downloaded      | Boolean    | DEFAULT FALSE | 결과 다운로드 여부                     |
| created_date           | DateTime   | DEFAULT NOW() | 생성일시                           |
| updated_date           | DateTime   | DEFAULT NOW() | 업데이트일시                         |

**관계**:
- user: TbSapHrInfo (user_emp_no 기준)

**인덱스**:
- idx_search_analytics_query (query_hash)
- idx_search_analytics_user (user_emp_no, created_date)
- idx_search_analytics_type (search_type, created_date)
- idx_search_analytics_performance (processing_time_ms)
- idx_search_analytics_satisfaction (user_satisfaction)
- idx_search_analytics_date (created_date)

### 6.3 TbKnowledgeSharingLog (지식 공유 로그)

**테이블명**: `tb_knowledge_sharing_log`  
**목적**: 지식 공유 활동 추적

| 컬럼명                | 타입         | 제약조건          | 설명                                         |
| ------------------ | ---------- | ------------- | ------------------------------------------ |
| sharing_id         | String(50) | PRIMARY KEY   | 공유 ID                                      |
| sharer_emp_no      | String(20) | FK, NOT NULL  | 공유자 사번                                     |
| recipient_emp_no   | String(20) | FK            | 수신자 사번 (개인 공유시)                            |
| container_id       | String(50) | FK            | 대상 컨테이너 ID                                 |
| document_id        | String(50) |               | 공유된 문서 ID                                  |
| sharing_type       | String(20) | NOT NULL      | 공유 유형 (link/email/internal)                |
| sharing_method     | String(20) | NOT NULL      | 공유 방법 (direct/broadcast/scheduled)         |
| sharing_scope      | String(20) | NOT NULL      | 공유 범위 (individual/team/department/company) |
| access_permissions | JSONB      |               | 접근 권한 설정                                   |
| expiry_date        | DateTime   |               | 공유 만료일                                     |
| access_count       | Integer    | DEFAULT 0     | 접근 횟수                                      |
| download_count     | Integer    | DEFAULT 0     | 다운로드 횟수                                    |
| last_accessed      | DateTime   |               | 마지막 접근 시간                                  |
| sharing_note       | Text       |               | 공유 메모                                      |
| is_active          | Boolean    | DEFAULT TRUE  | 활성 상태                                      |
| created_date       | DateTime   | DEFAULT NOW() | 생성일시                                       |

**관계**:
- sharer: TbSapHrInfo (sharer_emp_no 기준)
- recipient: TbSapHrInfo (recipient_emp_no 기준)
- container: TbKnowledgeContainers (container_id 기준)

**인덱스**:
- idx_knowledge_sharing_sharer (sharer_emp_no, created_date)
- idx_knowledge_sharing_recipient (recipient_emp_no, created_date)
- idx_knowledge_sharing_container (container_id)
- idx_knowledge_sharing_type (sharing_type)
- idx_knowledge_sharing_active (is_active, expiry_date)

## 7. 시스템 공통 모델

### 7.1 TbCmnsCdGrpItem (공통 코드)

**테이블명**: `tb_cmns_cd_grp_item`  
**목적**: 시스템 전반의 공통 코드 관리

| 컬럼명                | 타입          | 제약조건          | 설명        |
| ------------------ | ----------- | ------------- | --------- |
| grp_cd             | String(20)  | PRIMARY KEY   | 그룹 코드     |
| cd                 | String(20)  | PRIMARY KEY   | 코드        |
| cd_nm              | String(100) | NOT NULL      | 코드명       |
| cd_desc            | Text        |               | 코드 설명     |
| cd_value           | String(500) |               | 코드 값      |
| parent_cd          | String(20)  |               | 상위 코드     |
| sort_ordr          | Integer     | DEFAULT 0     | 정렬 순서     |
| use_yn             | CHAR(1)     | DEFAULT 'Y'   | 사용 여부     |
| sys_cd_yn          | CHAR(1)     | DEFAULT 'N'   | 시스템 코드 여부 |
| attr1              | String(100) |               | 확장 속성 1   |
| attr2              | String(100) |               | 확장 속성 2   |
| attr3              | String(100) |               | 확장 속성 3   |
| created_by         | String(20)  |               | 생성자       |
| created_date       | DateTime    | DEFAULT NOW() | 생성일시      |
| last_modified_by   | String(20)  |               | 최종 수정자    |
| last_modified_date | DateTime    | DEFAULT NOW() | 최종 수정일시   |

**인덱스**:
- idx_cmns_cd_grp (grp_cd, sort_ordr)
- idx_cmns_cd_use (use_yn, grp_cd)
- idx_cmns_cd_parent (parent_cd)

### 7.2 TbSystemSettings (시스템 설정)

**테이블명**: `tb_system_settings`  
**목적**: ABEKM 시스템 환경 설정 관리

| 컬럼명                | 타입          | 제약조건             | 설명                                 |
| ------------------ | ----------- | ---------------- | ---------------------------------- |
| setting_key        | String(100) | PRIMARY KEY      | 설정 키                               |
| setting_value      | Text        |                  | 설정 값                               |
| setting_type       | String(20)  | DEFAULT 'string' | 설정 타입 (string/number/boolean/json) |
| setting_group      | String(50)  |                  | 설정 그룹                              |
| category           | String(50)  |                  | 설정 카테고리                            |
| description        | Text        |                  | 설정 설명                              |
| default_value      | Text        |                  | 기본값                                |
| allowed_values     | JSONB       |                  | 허용되는 값들                            |
| validation_rule    | Text        |                  | 검증 규칙                              |
| is_encrypted       | Boolean     | DEFAULT FALSE    | 암호화 여부                             |
| is_editable        | Boolean     | DEFAULT TRUE     | 편집 가능 여부                           |
| is_public          | Boolean     | DEFAULT FALSE    | 공개 여부                              |
| requires_restart   | Boolean     | DEFAULT FALSE    | 재시작 필요 여부                          |
| environment        | String(20)  |                  | 적용 환경 (dev/staging/prod/all)       |
| priority           | Integer     | DEFAULT 0        | 우선순위                               |
| created_by         | String(20)  |                  | 생성자                                |
| created_date       | DateTime    | DEFAULT NOW()    | 생성일시                               |
| last_modified_by   | String(20)  |                  | 최종 수정자                             |
| last_modified_date | DateTime    | DEFAULT NOW()    | 최종 수정일시                            |

**인덱스**:
- idx_system_settings_group (setting_group)
- idx_system_settings_category (category)
- idx_system_settings_editable (is_editable)
- idx_system_settings_environment (environment)

### 7.3 TbKnowledgeCategories (지식 카테고리)

**테이블명**: `tb_knowledge_categories`  
**목적**: 지식 분류 체계 관리

| 컬럼명                | 타입          | 제약조건          | 설명          |
| ------------------ | ----------- | ------------- | ----------- |
| category_id        | String(50)  | PRIMARY KEY   | 카테고리 ID     |
| category_name      | String(100) | NOT NULL      | 카테고리명       |
| parent_category_id | String(50)  | FK            | 상위 카테고리 ID  |
| category_path      | Text        |               | 카테고리 경로     |
| category_level     | Integer     | DEFAULT 1     | 카테고리 레벨     |
| description        | Text        |               | 카테고리 설명     |
| category_icon      | String(100) |               | 카테고리 아이콘    |
| category_color     | String(7)   |               | 카테고리 색상     |
| sort_order         | Integer     | DEFAULT 0     | 정렬 순서       |
| document_count     | Integer     | DEFAULT 0     | 문서 수        |
| is_active          | Boolean     | DEFAULT TRUE  | 활성화 여부      |
| is_system          | Boolean     | DEFAULT FALSE | 시스템 카테고리 여부 |
| created_by         | String(20)  |               | 생성자         |
| created_date       | DateTime    | DEFAULT NOW() | 생성일시        |
| last_modified_by   | String(20)  |               | 최종 수정자      |
| last_modified_date | DateTime    | DEFAULT NOW() | 최종 수정일시     |

**관계**:
- parent_category: TbKnowledgeCategories (자기 참조)
- child_categories: TbKnowledgeCategories (자기 참조)

**인덱스**:
- idx_knowledge_categories_parent (parent_category_id)
- idx_knowledge_categories_level (category_level)
- idx_knowledge_categories_active (is_active, sort_order)

## 8. 데이터베이스 스키마 정보 (2025-10-27 기준)

### 8.1 PostgreSQL + pgvector 구성

**데이터베이스**: PostgreSQL 15.x  
**데이터베이스명**: wkms  
**접속 정보**:
- 호스트: localhost (Docker 컨테이너: wkms-postgres)
- 포트: 5432
- 사용자: wkms
- 비밀번호: wkms123

**확장 모듈**:
- pgvector 0.5+: 벡터 검색 지원
- pg_trgm: Trigram 유사도 검색 (오타 허용)
- hstore: Key-Value 스토어 (선택)

**벡터 차원**:
- 텍스트 임베딩 (vector): 1536차원 (text-embedding-3-small), 3072차원 (text-embedding-3-large)
- 멀티모달 임베딩 (clip_vector): 512차원 (Azure CLIP 고정)

**인덱싱 알고리즘**:
- HNSW (Hierarchical Navigable Small World): 고속 근사 최근접 이웃 검색
- GIN (Generalized Inverted Index): 전문 검색 (tsvector, 배열, JSONB)
- B-tree: 일반 인덱스 (정렬, 범위 검색)

**총 테이블 수**: 38개 (운영 테이블 36개 + alembic_version 1개 + 백업 1개)

### 8.2 주요 인덱스 전략

```sql
-- 1. 멀티모달 벡터 검색 인덱스 (HNSW)
-- CLIP 512차원 벡터 (이미지/텍스트 크로스 모달 검색)
CREATE INDEX idx_doc_embedding_clip_vector 
ON doc_embedding USING hnsw (clip_vector vector_cosine_ops)
WITH (m = 16, ef_construction = 64);

-- 텍스트 임베딩 벡터 (동적 차원 지원)
CREATE INDEX vs_doc_contents_chunks_embedding_idx 
ON vs_doc_contents_chunks USING hnsw (embedding_vector vector_cosine_ops);

-- 2. 다국어 전문 검색 인덱스 (GIN + tsvector)
-- 한국어 키워드 검색
CREATE INDEX idx_search_keyword_tsvector 
ON tb_document_search_index USING GIN (keyword_tsvector);

-- 한국어 내용 검색
CREATE INDEX idx_search_content_tsvector 
ON tb_document_search_index USING GIN (content_tsvector);

-- 영어 키워드 검색
CREATE INDEX idx_search_keyword_tsvector_en 
ON tb_document_search_index USING GIN (keyword_tsvector_en);

-- 영어 내용 검색
CREATE INDEX idx_search_content_tsvector_en 
ON tb_document_search_index USING GIN (content_tsvector_en);

-- 3. Trigram 유사도 검색 (오타 허용)
-- 문서 제목 유사도
CREATE INDEX idx_search_document_title_trgm 
ON tb_document_search_index USING GIN (document_title gin_trgm_ops);

-- 문서 내용 유사도
CREATE INDEX idx_search_full_content_trgm 
ON tb_document_search_index USING GIN (full_content gin_trgm_ops);

-- 4. 멀티모달 메타데이터 검색 (GIN + JSONB)
CREATE INDEX idx_search_images_metadata 
ON tb_document_search_index USING GIN (images_metadata);

-- 5. 학술 서지정보 검색 (GIN + 배열)
CREATE INDEX idx_acad_doc_keywords 
ON tb_academic_document_metadata USING GIN (keywords);

-- 6. 복합 인덱스 (권한 관리 최적화)
CREATE INDEX idx_user_permissions_composite 
ON tb_user_permissions(user_emp_no, container_id, permission_type);

-- 7. 부분 인덱스 (조건부 인덱싱으로 인덱스 크기 최소화)
-- 검색 가능한 문서만 인덱싱
CREATE INDEX idx_search_container_status_fts 
ON tb_document_search_index(knowledge_container_id, indexing_status) 
WHERE indexing_status = 'indexed';

-- CLIP 벡터가 있는 임베딩만 인덱싱
CREATE INDEX idx_doc_embedding_clip_vector_exists 
ON doc_embedding(clip_vector) 
WHERE clip_vector IS NOT NULL;

-- 활성 리프레시 토큰만 인덱싱
CREATE INDEX idx_tb_refresh_tokens_active 
ON tb_refresh_tokens(is_active) 
WHERE is_active = TRUE;
```

### 8.3 파티셔닝 전략 (향후 확장 고려)

```sql
-- 대용량 로그 테이블 월별 파티셔닝 (월 1천만 건 이상 시 적용)
-- 예시: 2025년 1월 파티션
CREATE TABLE tb_knowledge_access_log_y2025m01 PARTITION OF tb_knowledge_access_log
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- 채팅 이력 연도별 파티셔닝 (연 1억 건 이상 시 적용)
CREATE TABLE tb_chat_history_y2025 PARTITION OF tb_chat_history
FOR VALUES FROM ('2025-01-01') TO ('2026-01-01');

-- 검색 분석 데이터 월별 파티셔닝
CREATE TABLE tb_search_analytics_y2025m01 PARTITION OF tb_search_analytics
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

### 8.4 백업 및 복원 전략

```bash
# 1. 전체 데이터베이스 백업 (스키마 + 데이터)
pg_dump -h localhost -U wkms -d wkms -F c -b -v \
  -f wkms_full_backup_$(date +%Y%m%d_%H%M%S).dump

# 2. 스키마만 백업 (테이블 구조, 인덱스, 제약조건)
pg_dump -h localhost -U wkms -d wkms --schema-only \
  -f wkms_schema_$(date +%Y%m%d).sql

# 3. 데이터만 백업 (INSERT 문 형식)
pg_dump -h localhost -U wkms -d wkms --data-only \
  -f wkms_data_$(date +%Y%m%d).sql

# 4. 특정 테이블만 백업 (벡터 데이터)
pg_dump -h localhost -U wkms -d wkms \
  -t doc_embedding -t vs_doc_contents_chunks -t doc_chunk \
  -f wkms_vector_backup_$(date +%Y%m%d).sql

# 5. 학술 서지정보만 백업
pg_dump -h localhost -U wkms -d wkms \
  -t tb_academic_* \
  -f wkms_academic_backup_$(date +%Y%m%d).sql

# 6. 전체 복원
pg_restore -h localhost -U wkms -d wkms_restored -v \
  wkms_full_backup_20251027_120000.dump

# 7. 특정 테이블만 복원
pg_restore -h localhost -U wkms -d wkms -t doc_embedding -v \
  wkms_full_backup_20251027_120000.dump
```

### 8.5 PostgreSQL 확장 설치

```sql
-- pgvector 확장 (벡터 검색)
CREATE EXTENSION IF NOT EXISTS vector;

-- pg_trgm 확장 (Trigram 유사도 검색)
CREATE EXTENSION IF NOT EXISTS pg_trgm;

-- 한국어 전문 검색 설정
-- 한국어 사전 파일 경로: /usr/share/postgresql/15/tsearch_data/korean.stop
CREATE TEXT SEARCH CONFIGURATION korean (COPY = simple);

-- 영어 전문 검색 (기본 제공)
-- english 설정 사용
```

## 9. 성능 및 확장성 고려사항

### 9.1 벡터 검색 최적화

- **HNSW 인덱스**: 빠른 근사 최근접 이웃 검색 (m=16, ef_construction=64)
- **듀얼 벡터 전략**: 텍스트 벡터(1536d) + CLIP 벡터(512d) 병렬 검색
- **벡터 차원 최적화**: 1536d 사용으로 저장 공간 50% 절감 (3072d 대비)
- **배치 임베딩**: 대량 문서 처리 시 배치 크기 최적화 (500~1000건/배치)

### 9.2 권한 관리 최적화

- **권한 캐싱**: Redis 기반 권한 정보 캐싱 (TTL 1시간)
- **계층 구조 최적화**: Materialized Path 패턴으로 org_path 저장
- **권한 상속**: inherit_parent_permissions 플래그로 상속 관계 단순화
- **복합 인덱스**: (user_emp_no, container_id, permission_type) 트리플 인덱스

### 9.3 검색 성능 최적화

- **하이브리드 검색**: 벡터(70%) + 키워드(30%) RRF 융합
- **다국어 검색**: 한국어/영어 tsvector 분리로 정확도 향상
- **Trigram 검색**: 오타 허용 유사도 검색 (pg_trgm 활용)
- **멀티모달 필터**: has_images, has_tables 인덱스로 전처리 필터링
- **부분 인덱스**: indexing_status='indexed' 조건부 인덱싱으로 크기 최소화

### 9.4 멀티모달 검색 최적화

- **CLIP 벡터 인덱스**: 512차원 HNSW 인덱스로 이미지-텍스트 크로스 모달 검색
- **이미지 메타데이터**: JSONB 인덱스로 크기, 타입, 경로 검색
- **모달리티별 검색**: text/table/image 타입별 전용 쿼리 최적화

## 10. 결론

### 10.1 주요 특징 (v2.0)

이 정적 설계 명세서는 ABEKM 시스템의 **실제 운영 중인 데이터베이스 스키마 (2025-10-27 기준)**를 PostgreSQL 직접 조회 및 SQLAlchemy 모델 분석을 통해 완전히 문서화했습니다.

**핵심 아키텍처**:
- **38개 테이블**: 인증/권한(10) + 문서(9) + 학술(5) + 채팅(3) + 검색/분석(3) + 시스템(4) + 사전(2) + 기타(2)
- **듀얼 벡터 전략**: 텍스트 임베딩(1536d) + CLIP 멀티모달(512d) 동시 지원
- **다국어 검색**: 한국어/영어 tsvector 분리 + Trigram 유사도 검색
- **멀티모달 RAG**: 추출 → 청킹 → 임베딩 5단계 파이프라인
- **학술 서지정보**: 논문, 저자, 소속, 참고문헌, 인용 관계 관리

**기술 스택**:
- **데이터베이스**: PostgreSQL 15 + pgvector 0.5 + pg_trgm
- **벡터 검색**: HNSW 인덱스 (m=16, ef_construction=64)
- **전문 검색**: GIN 인덱스 (tsvector, 배열, JSONB)
- **스토리지**: Azure Blob Storage (wkms-raw, wkms-intermediate, wkms-derived)
- **인증**: JWT + Refresh Token (자동 회전, 세션 추적)

**v2.0 주요 업데이트**:
1. **학술 논문 지원**: 5개 서지정보 테이블 추가 (DOI, ORCID, 인용 관계)
2. **멀티모달 강화**: CLIP 512d 벡터 + 이미지 메타데이터 JSONB
3. **다국어 검색**: 한국어/영어 tsvector 분리 + Trigram 오타 허용
4. **보안 강화**: Refresh Token 테이블 + 토큰 회전 + IP/User-Agent 추적
5. **Blob 연동**: Azure Blob Storage blob_key 필드 추가

### 10.2 설계 원칙

1. **실무 중심**: 실제 운영 데이터베이스 스키마 100% 반영
2. **확장 가능**: 모듈화된 테이블 구조로 기능 추가 용이
3. **성능 최적화**: 부분 인덱스, 복합 인덱스, 파티셔닝 전략
4. **감사 추적**: created_date, last_modified_date, audit_log 테이블
5. **다국어 지원**: 한국어/영어 tsvector 분리 + 언어별 NLP

### 10.3 참조 정보

- **Alembic 마이그레이션**: `/backend/alembic/versions/` (26개 마이그레이션 파일)
- **SQLAlchemy 모델**: `/backend/app/models/` (auth, document, academic, chat, search, core)
- **데이터베이스 접속**: `postgresql://wkms:wkms123@localhost:5432/wkms`
- **Docker 컨테이너**: wkms-postgres (PostgreSQL 15), wkms-redis (Redis 7), wkms-pgadmin (pgAdmin 4)

이 문서는 개발자가 시스템을 구현하고 데이터베이스를 운영할 때 참조할 수 있는 **완전하고 정확한** 기술 명세서를 제공합니다.