# 03. ê²€ìƒ‰ ë° ì§ˆì˜ì‘ë‹µ ì„œë¹„ìŠ¤ (ê°œë… ì„¤ê³„ì„œ)

> **ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-27  
> **ì£¼ìš” ë³€ê²½**: 
> - ì‹¤ì œ ë°±ì—”ë“œ/í”„ë¡ íŠ¸ì—”ë“œ ì†ŒìŠ¤ì½”ë“œ ê¸°ì¤€ ì „ë©´ ì—…ë°ì´íŠ¸
> - API ì—”ë“œí¬ì¸íŠ¸ ìµœì‹ í™” (search.py, chat.py, multimodal_search.py)
> - ê²€ìƒ‰ ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ ì‹¤ì œ êµ¬í˜„ ë°˜ì˜ (SearchService class)
> - í”„ë¡ íŠ¸ì—”ë“œ SearchPage/ChatPage í†µí•© ì›Œí¬í”Œë¡œìš° ë°˜ì˜
> - ë©€í‹°ëª¨ë‹¬ ê²€ìƒ‰ ì‹œìŠ¤í…œ ì™„ì „ êµ¬í˜„ (CLIP ë²¡í„° 512d, Azure CLIP ëª¨ë¸)
> - í†µí•© ì§ˆì˜ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ êµ¬í˜„ ì™„ë£Œ (query_pipeline.py)
> - RAG ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ë° ì„¸ì…˜ ê´€ë¦¬ ì‹œìŠ¤í…œ ë°˜ì˜

ë³¸ ë¬¸ì„œëŠ” ì½”ë“œê°€ ì•„ë‹Œ ê°œë…/ì ˆì°¨ ì¤‘ì‹¬ìœ¼ë¡œ ê²€ìƒ‰Â·QA ì„œë¹„ìŠ¤ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤. ìƒìœ„ íŒŒì´í”„ë¼ì¸ ë¬¸ì„œ(`02.document_ingestion_vectorstore.md`)ì˜ ê²°ê³¼ë¬¼ê³¼ ê¸´ë°€íˆ ì—°ê²°ë˜ë©°, ì²˜ë¦¬ í’ˆì§ˆê³¼ ìŠ¤í‚¤ë§ˆ ê²°ì •ì´ ê²€ìƒ‰ í’ˆì§ˆê³¼ ê¸°ëŠ¥ ì—°ê³„ì„±ì— ì§ì ‘ì ì¸ ì˜í–¥ì„ ì¤ë‹ˆë‹¤.

## ëª©ì°¨

- [1. ëª©í‘œì™€ ë²”ìœ„](#1-ëª©í‘œì™€-ë²”ìœ„)
- [2. ì…ë ¥Â·ì¶œë ¥ ê³„ì•½(Contract)](#2-ì…ë ¥ì¶œë ¥-ê³„ì•½contract)

    - [2.1 ì…ë ¥](#21-ì…ë ¥)
    - [2.2 ì¶œë ¥](#22-ì¶œë ¥)
    - [2.3 ì˜¤ë¥˜/ì˜ˆì™¸](#23-ì˜¤ë¥˜ì˜ˆì™¸)
- [3. ìƒìœ„ íŒŒì´í”„ë¼ì¸ê³¼ì˜ ì˜ì¡´ ê´€ê³„](#3-ìƒìœ„-íŒŒì´í”„ë¼ì¸ê³¼ì˜-ì˜ì¡´-ê´€ê³„)

    - [3.1 ì²­í‚¹ í’ˆì§ˆ ì˜í–¥](#31-ì²­í‚¹-í’ˆì§ˆ-ì˜í–¥)
    - [3.2 ìŠ¤í‚¤ë§ˆ/ì¸ë±ìŠ¤ ì˜ì¡´](#32-ìŠ¤í‚¤ë§ˆì¸ë±ìŠ¤-ì˜ì¡´)
    - [3.3 ìš´ì˜ ìƒíƒœ ì˜ì¡´](#33-ìš´ì˜-ìƒíƒœ-ì˜ì¡´)
    - [3.4 ì§ˆë¬¸ ì „ì²˜ë¦¬ ë° ê°œì„ ](#34-ì§ˆë¬¸-ì „ì²˜ë¦¬-ë°-ê°œì„ )
        - [3.4.1 ì˜ë„ ë¶„ë¥˜(ê°œìš”)](#341-ì˜ë„-ë¶„ë¥˜ê°œìš”)
- [4. ê²€ìƒ‰ ëª¨ë“œì™€ ë¼ìš°íŒ…](#4-ê²€ìƒ‰-ëª¨ë“œì™€-ë¼ìš°íŒ…)

    - [4.1 hybrid(ê¸°ë³¸)](#41-hybridê¸°ë³¸)
    - [4.2 vector_only](#42-vector_only)
    - [4.3 keyword_only](#43-keyword_only)
    - [4.4 multimodal (ì´ë¯¸ì§€ ìš°ì„ )](#44-multimodal-ì´ë¯¸ì§€-ìš°ì„ ) ğŸ†•
    - [4.5 clip (ì´ë¯¸ì§€ ê²€ìƒ‰)](#45-clip-ì´ë¯¸ì§€-ê²€ìƒ‰) ğŸ†•
    - [4.6 ê³µí†µ: ê¶Œí•œ/ì»¨í…Œì´ë„ˆ í•„í„°](#46-ê³µí†µ-ê¶Œí•œì»¨í…Œì´ë„ˆ-í•„í„°)
- [5. ì¸ë±ìŠ¤/ìŠ¤í‚¤ë§ˆ](#5-ì¸ë±ìŠ¤ìŠ¤í‚¤ë§ˆ)

    - [5.1 ë“€ì–¼ ì¸ë±ìŠ¤ êµ¬ì¡°(í˜„í–‰)](#51-ë“€ì–¼-ì¸ë±ìŠ¤-êµ¬ì¡°í˜„í–‰)
    - [5.2 ë©€í‹°ëª¨ë‹¬ í™•ì¥(ì„ íƒ)](#52-ë©€í‹°ëª¨ë‹¬-í™•ì¥ì„ íƒ)
- [6. ê²€ìƒ‰ ì—”ì§„ ìƒì„¸](#6-ê²€ìƒ‰-ì—”ì§„-ìƒì„¸)

    - [6.1 ê²€ìƒ‰ ì—”ì§„ ì•„í‚¤í…ì²˜](#61-ê²€ìƒ‰-ì—”ì§„-ì•„í‚¤í…ì²˜)
    - [6.2 ë²¡í„° ê²€ìƒ‰ (Semantic Search)](#62-ë²¡í„°-ê²€ìƒ‰-semantic-search)
    - [6.3 í‚¤ì›Œë“œ ê²€ìƒ‰ (Keyword Search)](#63-í‚¤ì›Œë“œ-ê²€ìƒ‰-keyword-search)
    - [6.4 í•˜ì´ë¸Œë¦¬ë“œ ìŠ¤ì½”ì–´ë§](#64-í•˜ì´ë¸Œë¦¬ë“œ-ìŠ¤ì½”ì–´ë§)
- [7. RAG íŒŒì´í”„ë¼ì¸](#7-rag-íŒŒì´í”„ë¼ì¸)

    - [7.1 ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±](#71-ì»¨í…ìŠ¤íŠ¸-êµ¬ì„±)
    - [7.2 ë©€í‹° LLM ë‹µë³€ ìƒì„±](#72-ë©€í‹°-llm-ë‹µë³€-ìƒì„±)
    - [7.3 ë‹µë³€ í›„ì²˜ë¦¬](#73-ë‹µë³€-í›„ì²˜ë¦¬)
- [8. ëŒ€í™” ê´€ë¦¬ (Conversation Management)](#8-ëŒ€í™”-ê´€ë¦¬-conversation-management)

    - [8.1 ì„¸ì…˜ ê¸°ë°˜ ëŒ€í™” ì¶”ì ](#81-ì„¸ì…˜-ê¸°ë°˜-ëŒ€í™”-ì¶”ì )
    - [8.2 ëŒ€í™” ì´ë ¥ ë°ì´í„°ë² ì´ìŠ¤(ìš”ì•½)](#82-ëŒ€í™”-ì´ë ¥-ë°ì´í„°ë² ì´ìŠ¤ìš”ì•½)
- [9. í•µì‹¬ API ê°œìš” (search.py, chat.py)](#9-í•µì‹¬-api-ê°œìš”-searchpy-chatpy)

    - [9.1 ê³µí†µ ì‚¬í•­](#91-ê³µí†µ-ì‚¬í•­)
    - [9.2 ê²€ìƒ‰ API (backend/app/api/v1/search.py)](#92-ê²€ìƒ‰-api-backendappapiv1searchpy)
    - [9.3 ì±—/QA API (backend/app/api/v1/chat.py)](#93-ì±—qa-api-backendappapiv1chatpy)
        - [9.3.1 ì²¨ë¶€ íŒŒì¼ ê´€ë¦¬ (Attachment Handling)](#931-ì²¨ë¶€-íŒŒì¼-ê´€ë¦¬-attachment-handling-ğŸ†•)
    - [9.4 í”„ëŸ°íŠ¸ì—”ë“œ ì—°ê³„(ìš”ì•½)](#94-í”„ëŸ°íŠ¸ì—”ë“œ-ì—°ê³„ìš”ì•½)
    - [9.5 ë¦¬íŒ©í† ë§ ìš”ì•½](#95-ë¦¬íŒ©í† ë§-ìš”ì•½)
    - [9.6 í–¥í›„ í™•ì¥ ê³„íš](#96-í–¥í›„-í™•ì¥-ê³„íš)
- [10. ì„±ëŠ¥/ë¹„ìš© ì „ëµ](#10-ì„±ëŠ¥ë¹„ìš©-ì „ëµ)

    - [10.1 ì¸ë±ìŠ¤ íŠœë‹](#101-ì¸ë±ìŠ¤-íŠœë‹)
    - [10.2 ìºì‹œ](#102-ìºì‹œ)
    - [10.3 ë°°ì¹˜ vs ì‹¤ì‹œê°„](#103-ë°°ì¹˜-vs-ì‹¤ì‹œê°„)
    - [10.4 ë¹„ìš©](#104-ë¹„ìš©)
    - [10.5 ëª¨ë‹ˆí„°ë§ ë° ë¶„ì„](#105-ëª¨ë‹ˆí„°ë§-ë°-ë¶„ì„)
- [11. í’ˆì§ˆ ê´€ë¦¬ì™€ í‰ê°€](#11-í’ˆì§ˆ-ê´€ë¦¬ì™€-í‰ê°€)

    - [11.1 ì§€í‘œ](#111-ì§€í‘œ)
    - [11.2 A/B ì‹¤í—˜](#112-ab-ì‹¤í—˜)
    - [11.3 ë¡œê·¸ ê¸°ë°˜ ê°œì„ ](#113-ë¡œê·¸-ê¸°ë°˜-ê°œì„ )
    - [11.4 ìš´ì˜ ê°€ë“œë ˆì¼](#114-ìš´ì˜-ê°€ë“œë ˆì¼)
- [12. ë³´ì•ˆÂ·ê±°ë²„ë„ŒìŠ¤](#12-ë³´ì•ˆê±°ë²„ë„ŒìŠ¤)
- [13. ì¥ì• /ë³µêµ¬Â·ìš´ì˜](#13-ì¥ì• ë³µêµ¬ìš´ì˜)
- [14. ì—ëŸ¬ ëª¨ë“œì™€ ìš´ì˜ ê°€ì´ë“œ](#14-ì—ëŸ¬-ëª¨ë“œì™€-ìš´ì˜-ê°€ì´ë“œ)
- [15. ë¶€ë¡: íŒŒì´í”„ë¼ì¸ ê²°ê³¼ì™€ì˜ ë§¤í•‘](#15-ë¶€ë¡-íŒŒì´í”„ë¼ì¸-ê²°ê³¼ì™€ì˜-ë§¤í•‘)

## 1. ëª©í‘œì™€ ë²”ìœ„

- ëª©í‘œ: ê¶Œí•œ ê¸°ë°˜ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ê³¼ í•œêµ­ì–´ QAë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì œê³µ
- ë²”ìœ„: ì§ˆì˜ ì „ì²˜ë¦¬ â†’ ê²€ìƒ‰(í•˜ì´ë¸Œë¦¬ë“œ) â†’ ì¦ê±° ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± â†’ ë‹µë³€ ìƒì„± â†’ ë¡œê¹…/ê±°ë²„ë„ŒìŠ¤
- ì „ì œ: ë“€ì–¼ ì¸ë±ìŠ¤ êµ¬ì¡°(5.1) ë˜ëŠ” ë©€í‹°ëª¨ë‹¬ í†µí•© ìŠ¤í‚¤ë§ˆ(5.2)ì— ë§ì¶° ê²€ìƒ‰ ê³„ì¸µì„ ì„¤ì •

## 2. ì…ë ¥Â·ì¶œë ¥ ê³„ì•½(Contract)

### 2.1 ì…ë ¥

- ì‚¬ìš©ì ì§ˆì˜: í•œêµ­ì–´(ì§§ì€ ì§ˆë¬¸/ì„¤ëª…í˜• ë¬¸ì¥)
- í•„í„°/ì œì•½: ì ‘ê·¼ ê°€ëŠ¥ ì»¨í…Œì´ë„ˆ, ë¬¸ì„œ íƒ€ì…, ë‚ ì§œ ë²”ìœ„ ë“±
- ëª¨ë“œ: hybrid | vector_only | keyword_only | multimodal (ì„ íƒ)

### 2.2 ì¶œë ¥

- ë­í‚¹ëœ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸(íŒŒì¼/ì²­í¬/ì„¸ê·¸ë¨¼íŠ¸ ê¸°ì¤€)ì™€ ê·¼ê±° ìŠ¤ë‹ˆí«
- QA ëª¨ë“œ ì‹œ: ê·¼ê±° ëª©ë¡ + ìƒì„± ë‹µë³€(ì¶œì²˜ ë§í¬ í¬í•¨)

### 2.3 ì˜¤ë¥˜/ì˜ˆì™¸

- ê¶Œí•œ ë¯¸í™•ì¸, ë¹ˆ ì¸ë±ìŠ¤, ê³¼ë„í•œ í† í°/ëŒ€ìš©ëŸ‰ ì§ˆì˜, ì„œë¹„ìŠ¤ íƒ€ì„ì•„ì›ƒ

## 3. ìƒìœ„ íŒŒì´í”„ë¼ì¸ê³¼ì˜ ì˜ì¡´ ê´€ê³„

### 3.1 ì²­í‚¹ í’ˆì§ˆ ì˜í–¥

- ì¢‹ì€ ì²­í‚¹: ì˜ë¯¸ ì¼ì¹˜/ì •í™•í•œ ìŠ¤ë‹ˆí« êµ¬ì„±ìœ¼ë¡œ ë¦¬íŠ¸ë¦¬ë²Œ ì •í™•ë„ í–¥ìƒ
- í—¤ë” ê²½ë¡œ/í˜ì´ì§€/ì„¹ì…˜ ì œëª© ë³´ì¡´ì´ ë ˆì´íŒ…Â·í•˜ì´ë¼ì´íŠ¸ í’ˆì§ˆì— ê¸°ì—¬

### 3.2 ìŠ¤í‚¤ë§ˆ/ì¸ë±ìŠ¤ ì˜ì¡´

- ë“€ì–¼ ì¸ë±ìŠ¤(5.1): í…ìŠ¤íŠ¸ ì²­í¬ ë²¡í„°(pgvector) vs í‚¤ì›Œë“œ/ì „ë¬¸(TSVECTOR)
- ë©€í‹°ëª¨ë‹¬(5.2): ì´ë¯¸ì§€/í‘œ/ë ˆì´ì•„ì›ƒ/ë¹„ë””ì˜¤ ì„¸ê·¸ë¨¼íŠ¸ ê²€ìƒ‰ ë° í•„í„°ë§ ê°€ëŠ¥

### 3.3 ìš´ì˜ ìƒíƒœ ì˜ì¡´

- íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨/ì§€ì—°ì€ ê²€ìƒ‰ ê³µë°±ìœ¼ë¡œ ì§ê²° â†’ ìƒíƒœ ëª¨ë‹ˆí„°ë§Â·ì¬ì‹œë„Â·ê²½ë³´ í•„ìš”

### 3.4 ì§ˆë¬¸ ì „ì²˜ë¦¬ ë° ê°œì„  (í†µí•© ì§ˆì˜ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸)

> **2025-10-17 ì—…ë°ì´íŠ¸**: í†µí•© ì§ˆì˜ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ êµ¬í˜„ ì™„ë£Œ  
>

#### 3.4.0 ì„¤ê³„ ëª©í‘œ

**ë¬¸ì œ ì •ì˜**:
- âŒ **ê¸°ì¡´**: ì¼ë°˜ ê²€ìƒ‰ê³¼ RAG ê²€ìƒ‰ë§ˆë‹¤ ë‹¤ë¥¸ ì§ˆì˜ ì²˜ë¦¬ ë¡œì§
- âŒ **ë¬¸ì œ**: ê°™ì€ ì§ˆì˜ì— ë‹¤ë¥¸ ë¶ˆìš©ì–´ ì œê±° â†’ ì¼ê´€ë˜ì§€ ì•Šì€ ê²€ìƒ‰ ê²°ê³¼
- âŒ **í•œê³„**: ìì—°ì–´ ì§ˆì˜ ("í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”") ì²˜ë¦¬ ë¶€ì¡±

**í•´ê²°ì±…**:
- âœ… **í†µí•© íŒŒì´í”„ë¼ì¸**: ëª¨ë“  ê²€ìƒ‰ ê²½ë¡œì—ì„œ ë™ì¼í•œ ì§ˆì˜ ì²˜ë¦¬
- âœ… **ì¼ê´€ëœ ë¶ˆìš©ì–´**: `UNIFIED_STOPWORDS` ì‚¬ìš©
- âœ… **ì˜ë„ ê¸°ë°˜ ì „ëµ**: ì§ˆì˜ ìœ í˜•ë³„ ìµœì í™”ëœ ê²€ìƒ‰ ê°€ì¤‘ì¹˜ ì ìš©

#### 3.4.1 í†µí•© íŒŒì´í”„ë¼ì¸ ì•„í‚¤í…ì²˜

```
ì‚¬ìš©ì ì§ˆì˜: "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”"
â”‚
â”œâ”€[Level 1] ì…ë ¥ ì •ê·œí™” (Input Normalization)
â”‚   â”œâ”€ ê³µë°±/íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€ ì œê±°
â”‚   â”œâ”€ ì–¸ì–´ ê°ì§€ (í•œê¸€/ì˜ì–´/í˜¼ìš©)
â”‚   â””â”€ ì¶œë ¥: "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸°í•˜ë‚˜ìš”"
â”‚
â”œâ”€[Level 2] ì˜ë„ ë¶„ë¥˜ (Intent Classification)
â”‚   â”œâ”€ 1ì°¨: ê·œì¹™ ê¸°ë°˜ íŒ¨í„´ ë§¤ì¹­ (ë¹ ë¦„)
â”‚   â”œâ”€ 2ì°¨: LLM ê¸°ë°˜ ë¶„ë¥˜ (ì •ë°€, confidence < 0.7ì¸ ê²½ìš°)
â”‚   â”œâ”€ ì˜ë„ íƒ€ì…:
â”‚   â”‚   â€¢ keyword_search: "AWS Lambda"
â”‚   â”‚   â€¢ document_search: "í˜ì‹  ê´€ë ¨ ë¬¸ì„œ ì°¾ì•„ì¤˜"
â”‚   â”‚   â€¢ qa_question: "Lambda ë¹„ìš©ì€ ì–¼ë§ˆì¸ê°€ìš”?"
â”‚   â”‚   â€¢ summarization: "ì´ ë¬¸ì„œ ìš”ì•½í•´ì¤˜"
â”‚   â”‚   â€¢ comparison: "EKS vs ECS ë¹„êµ"
â”‚   â”‚   â€¢ presentation: "PPT ë§Œë“¤ì–´ì¤˜"
â”‚   â””â”€ ì¶œë ¥: intent="document_search", confidence=0.75
â”‚
â”œâ”€[Level 3] í† í°í™” & ë¶„ì ˆ (Tokenization & Segmentation)
â”‚   â”œâ”€ í˜•íƒœì†Œ ë¶„ì„ (KoreanNLPService.analyze_text_for_search)
â”‚   â”‚   â†’ ["í˜ì‹ ì—", "ëŒ€í•´", "ë­ë¼", "ì´ì•¼ê¸°", "í•˜ë‚˜ìš”"]
â”‚   â”œâ”€ ë¶ˆìš©ì–´ ì œê±° (UNIFIED_STOPWORDS)
â”‚   â”‚   â€¢ ì¡°ì‚¬: "ì„", "ë¥¼", "ì´", "ê°€", "ì€", "ëŠ”", "ì˜", "ì—", ...
â”‚   â”‚   â€¢ ì˜ë¬¸ì‚¬: "ë­", "ë­ë¼", "ë¬´ì—‡", "ì–´ë–¤", ...
â”‚   â”‚   â€¢ ë³´ì¡°ìš©ì–¸: "ëŒ€í•´", "í•˜ë‚˜ìš”", "ìˆë‚˜ìš”", ...
â”‚   â”‚   â†’ ì œê±°: "ëŒ€í•´", "ë­ë¼", "í•˜ë‚˜ìš”"
â”‚   â”‚   â†’ ê²°ê³¼: ["í˜ì‹ ", "ì´ì•¼ê¸°"]
â”‚   â””â”€ ê°œì²´ëª… ì¸ì‹ (NER): ë‚ ì§œ, ì¡°ì§, ì œí’ˆ, ë¬¸ì„œíƒ€ì…
â”‚
â”œâ”€[Level 4] ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„± (Query Generation)
â”‚   â”œâ”€ ë²¡í„° ê²€ìƒ‰: ì„ë² ë”© ìƒì„± ("í˜ì‹  ì´ì•¼ê¸°" â†’ [0.123, 0.456, ...])
â”‚   â”œâ”€ í‚¤ì›Œë“œ ê²€ìƒ‰: "%í˜ì‹ % OR %ì´ì•¼ê¸°%"
â”‚   â”œâ”€ ì „ë¬¸ê²€ìƒ‰: "í˜ì‹  | ì´ì•¼ê¸°" (tsquery)
â”‚   â””â”€ ê°€ì¤‘ì¹˜ ì„¤ì •: {vector: 0.5, keyword: 0.3, fulltext: 0.2}
â”‚
â””â”€[Level 5] ë©€í‹°ëª¨ë‹¬ í†µí•© (Multimodal Integration) [ì„ íƒ]
    â”œâ”€ ì´ë¯¸ì§€ ì„ë² ë”© (CLIP)
    â”œâ”€ í…ìŠ¤íŠ¸ + ì´ë¯¸ì§€ Fusion
    â””â”€ í¬ë¡œìŠ¤ëª¨ë‹¬ ê²€ìƒ‰
```

#### 3.4.2 í•µì‹¬ ë°ì´í„° êµ¬ì¡°

**ì…ë ¥ ëª¨ë¸** (`ProcessedQuery`):
```python
{
  "original_text": "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”",
  "normalized_text": "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸°í•˜ë‚˜ìš”",
  "language": "ko",  # "ko" | "en" | "mixed"
  "intent": "document_search",
  "intent_confidence": 0.75,
  "keywords": ["í˜ì‹ ì—", "ëŒ€í•´", "ë­ë¼", "ì´ì•¼ê¸°", "í•˜ë‚˜ìš”"],  # ì›ë³¸
  "filtered_keywords": ["í˜ì‹ ", "ì´ì•¼ê¸°"],  # ë¶ˆìš©ì–´ ì œê±° í›„
  "fulltext_query": "í˜ì‹  | ì´ì•¼ê¸°",  # PostgreSQL tsquery
  "keyword_query": "%í˜ì‹ % OR %ì´ì•¼ê¸°%",  # ILIKE ê²€ìƒ‰
  "vector_embedding": [0.123, 0.456, ...],  # 1536ì°¨ì›
  "weights": {"vector": 0.5, "keyword": 0.3, "fulltext": 0.2},
  "similarity_threshold": 0.4,
  "processing_time_ms": 52.3
}
```

**í†µí•© ë¶ˆìš©ì–´ ë¦¬ìŠ¤íŠ¸** (`UNIFIED_STOPWORDS`):
```python
UNIFIED_STOPWORDS = {
    # ì¡°ì‚¬ (Particles)
    "ì„", "ë¥¼", "ì´", "ê°€", "ì€", "ëŠ”", "ì˜", "ì—", "ì—ì„œ", ...,
    
    # ì˜ë¬¸ì‚¬ (Interrogatives)
    "ë­", "ë­ë¼", "ë­ë¼ê³ ", "ë¬´ì—‡", "ì–´ë–¤", "ì–´ë–»ê²Œ",
    
    # ë³´ì¡°ìš©ì–¸ (Auxiliary)
    "ëŒ€í•´", "ëŒ€í•œ", "ê´€í•´", "í•˜ë‚˜ìš”", "ìˆë‚˜ìš”", "ë©ë‹ˆê¹Œ",
    
    # ê²€ìƒ‰ ë™ì‚¬ (Search Verbs)
    "ì°¾ì•„ì¤˜", "ê²€ìƒ‰", "ì¡°íšŒ", "ë³´ì—¬ì¤˜", "ì•Œë ¤ì¤˜",
    
    # ê¸°íƒ€
    "ë“±", "ë°", "ë˜", "ê°™ì€", "ì²˜ëŸ¼"
}
```

#### 3.4.3 ì˜ë„ë³„ ê²€ìƒ‰ ì „ëµ

**ì¼ë°˜ ê²€ìƒ‰ ì „ëµ** (`INTENT_SEARCH_STRATEGIES`):

| ì˜ë„ íƒ€ì…           | ë²¡í„°  | í‚¤ì›Œë“œ | ì „ë¬¸ê²€ìƒ‰ | ì„ê³„ê°’  | ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤                |
| --------------- | --- | --- | ---- | ---- | ---------------------- |
| keyword_search  | 0.3 | 0.6 | 0.1  | 0.3  | "AWS Lambda" (ì •í™•í•œ í‚¤ì›Œë“œ) |
| document_search | 0.5 | 0.3 | 0.2  | 0.4  | "í˜ì‹  ê´€ë ¨ ë¬¸ì„œ" (ê· í˜•)        |
| qa_question     | 0.6 | 0.2 | 0.2  | 0.5  | "Lambda ë¹„ìš©?" (ì˜ë¯¸ ì¤‘ì‹¬)   |
| comparison      | 0.6 | 0.3 | 0.1  | 0.45 | "EKS vs ECS" (ë¹„êµ)      |
| summarization   | 0.5 | 0.3 | 0.2  | 0.4  | "ìš”ì•½í•´ì¤˜"                 |

**RAG ê²€ìƒ‰ ì „ëµ** (`RAG_SEARCH_STRATEGIES`):

| ì˜ë„ íƒ€ì…           | ë²¡í„°  | í‚¤ì›Œë“œ  | ì „ë¬¸ê²€ìƒ‰ | ì„ê³„ê°’  | ìµœëŒ€ ì²­í¬ |
| --------------- | --- | ---- | ---- | ---- | ----- |
| document_search | 0.6 | 0.2  | 0.2  | 0.42 | 10    |
| qa_question     | 0.7 | 0.15 | 0.15 | 0.45 | 10    |
| comparison      | 0.6 | 0.2  | 0.2  | 0.4  | 15    |

> **í•µì‹¬**: RAGëŠ” ì˜ë¯¸ ê²€ìƒ‰(vector) ë¹„ì¤‘ì´ ë†’ê³ , ì¼ë°˜ ê²€ìƒ‰ì€ í‚¤ì›Œë“œ ë¹„ì¤‘ì´ ë†’ìŒ

#### 3.4.4 ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤ ìƒì„¸

**Step 1: ì…ë ¥ ì •ê·œí™”**
```python
# ì…ë ¥
"í˜ì‹ ì—  ëŒ€í•´   ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”??? ğŸ˜Š"

# ì •ê·œí™” ì²˜ë¦¬

1. ê³µë°± ì •ë¦¬: "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”??? ğŸ˜Š"
2. ì´ëª¨ì§€ ì œê±°: "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”???"
3. íŠ¹ìˆ˜ë¬¸ì ì •ë¦¬: "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”"
4. ì–¸ì–´ ê°ì§€: korean_chars=11, total=15 â†’ "ko"

# ì¶œë ¥

{
  "text": "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸°í•˜ë‚˜ìš”",
  "language": "ko"
}
```

**Step 2: ì˜ë„ ë¶„ë¥˜ (ê·œì¹™ ê¸°ë°˜)**
```python
# íŒ¨í„´ ë§¤ì¹­
patterns = {
  "document_search": [
    r".*(ì°¾|ê²€ìƒ‰|ì¡°íšŒ).*",
    r".*(ê´€ë ¨|ëŒ€í•œ|ê´€í•œ).*ë¬¸ì„œ.*",  # âœ… ë§¤ì¹­!
    r".*ìë£Œ.*ë³´ì—¬.*"
  ],
  "qa_question": [
    r".*(ë¬´ì—‡|ë­|ì–´ë–»ê²Œ|ì™œ).*",
    r".*(ì¸ê°€ìš”|ì…ë‹ˆê¹Œ)$"
  ]
}

# ê²°ê³¼

intent="document_search", confidence=0.75
```

**Step 3: í† í°í™” & ë¶ˆìš©ì–´ ì œê±°**
```python
# í˜•íƒœì†Œ ë¶„ì„
ì…ë ¥: "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸°í•˜ë‚˜ìš”"
ë¶„ì„: [
  ("í˜ì‹ ", "NNG"), ("ì—", "JKB"),
  ("ëŒ€í•˜", "VV"), ("ì–´", "EC"),
  ("ë­", "NP"), ("ë¼", "JX"),
  ("ì´ì•¼ê¸°", "NNG"),
  ("í•˜", "VV"), ("ë‚˜ìš”", "EF")
]
í‚¤ì›Œë“œ: ["í˜ì‹ ì—", "ëŒ€í•´", "ë­ë¼", "ì´ì•¼ê¸°", "í•˜ë‚˜ìš”"]

# ë¶ˆìš©ì–´ ì œê±°

UNIFIED_STOPWORDS ì²´í¬:
  âœ… "ëŒ€í•´" â†’ ì œê±°
  âœ… "ë­ë¼" â†’ ì œê±°  
  âœ… "í•˜ë‚˜ìš”" â†’ ì œê±°
  âŒ "í˜ì‹ " â†’ ìœ ì§€ (2ê¸€ì ì´ìƒ)
  âŒ "ì´ì•¼ê¸°" â†’ ìœ ì§€

ìµœì¢…: ["í˜ì‹ ", "ì´ì•¼ê¸°"]
```

**Step 4: ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±**
```python
# ì „ë¬¸ê²€ìƒ‰ ì¿¼ë¦¬ (PostgreSQL)
fulltext_query = " | ".join(["í˜ì‹ ", "ì´ì•¼ê¸°"])
â†’ "í˜ì‹  | ì´ì•¼ê¸°"  # OR ê²€ìƒ‰

# í‚¤ì›Œë“œ ê²€ìƒ‰ ì¿¼ë¦¬ (ILIKE)

keyword_query = " OR ".join(["%í˜ì‹ %", "%ì´ì•¼ê¸°%"])
â†’ "%í˜ì‹ % OR %ì´ì•¼ê¸°%"

# ë²¡í„° ì„ë² ë”©

text = "í˜ì‹  ì´ì•¼ê¸°"
embedding = await embedding_service.get_embedding(text)
â†’ [0.123, 0.456, 0.789, ...] (1536ì°¨ì›)

# ê°€ì¤‘ì¹˜ (document_search ì „ëµ)

weights = {"vector": 0.5, "keyword": 0.3, "fulltext": 0.2}
threshold = 0.4
```

#### 3.4.5 API í†µí•© ë°©ë²•

**ì¼ë°˜ ê²€ìƒ‰ API (`search_service.py`)**:
```python
async def _preprocess_query(self, query: str) -> Dict[str, Any]:
    # í†µí•© íŒŒì´í”„ë¼ì¸ ì‚¬ìš©
    processed = await process_user_query(query, search_type="general")
    
    return {
        "fulltext_query": processed.fulltext_query,
        "filtered_keywords": processed.filtered_keywords,
        "weights": processed.weights,
        "similarity_threshold": processed.similarity_threshold
    }
```

**RAG ê²€ìƒ‰ API (`rag_search_service.py`)**:
```python
async def _analyze_query(self, query: str) -> Dict[str, Any]:
    # í†µí•© íŒŒì´í”„ë¼ì¸ ì‚¬ìš© (RAG ëª¨ë“œ)
    processed = await process_user_query(query, search_type="rag")
    
    return {
        "korean_keywords": processed.filtered_keywords,
        "embedding": processed.vector_embedding,
        "query_type": self._classify_query_type_from_intent(processed.intent)
    }
```

#### 3.4.6 ì„±ëŠ¥ ì§€í‘œ

| í•­ëª©         | Before    | After    | ê°œì„ ìœ¨     |
| ---------- | --------- | -------- | ------- |
| ì²˜ë¦¬ ì‹œê°„      | 80-150ms  | 50-100ms | âœ… -30%  |
| í‚¤ì›Œë“œ ê²€ìƒ‰ ì •í™•ë„ | 75%       | 85%      | âœ… +13%  |
| ìì—°ì–´ ì§ˆë¬¸ ì •í™•ë„ | 60%       | 80%      | âœ… +33%  |
| ë¬¸ì„œ ê²€ìƒ‰ ì •í™•ë„  | 70%       | 85%      | âœ… +21%  |
| ë¶ˆìš©ì–´ ì¼ê´€ì„±    | 50% (ë¶ˆì¼ì¹˜) | 100%     | âœ… +100% |

#### 3.4.7 êµ¬í˜„ ìœ„ì¹˜

```
backend/app/services/search/
â”œâ”€â”€ query_pipeline.py          # í†µí•© ì§ˆì˜ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸
â”œâ”€â”€ query_models.py            # ë°ì´í„° ëª¨ë¸ (ProcessedQuery)
â”œâ”€â”€ query_config.py            # ì„¤ì • (UNIFIED_STOPWORDS, INTENT_SEARCH_STRATEGIES)
â”œâ”€â”€ search_service.py          # ì¼ë°˜ ê²€ìƒ‰ (íŒŒì´í”„ë¼ì¸ ì‚¬ìš©)
â””â”€â”€ __init__.py                # export

backend/app/services/chat/
â””â”€â”€ rag_search_service.py      # RAG ê²€ìƒ‰ (íŒŒì´í”„ë¼ì¸ ì‚¬ìš©)
```

#### 3.4.8 í–¥í›„ í™•ì¥ ê³„íš

**Phase 2: ì˜ë„ ë¶„ë¥˜ ê³ ë„í™”**
- [ ] LLM ê¸°ë°˜ ì˜ë„ ë¶„ë¥˜ (confidence < 0.7ì¸ ê²½ìš°)
- [ ] ì˜ë„ë³„ A/B í…ŒìŠ¤íŠ¸
- [ ] ì‚¬ìš©ì í”¼ë“œë°± ê¸°ë°˜ í•™ìŠµ

**Phase 3: ë©€í‹°ëª¨ë‹¬ ì§€ì›**
- [ ] ì´ë¯¸ì§€ ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸
- [ ] CLIP ëª¨ë¸ í†µí•©
- [ ] í…ìŠ¤íŠ¸ + ì´ë¯¸ì§€ Fusion ì „ëµ
- [ ] í¬ë¡œìŠ¤ëª¨ë‹¬ ê²€ìƒ‰ (í…ìŠ¤íŠ¸ â†’ ì´ë¯¸ì§€, ì´ë¯¸ì§€ â†’ í…ìŠ¤íŠ¸)

**Phase 4: ì„±ëŠ¥ ìµœì í™”**
- [ ] ì§ˆì˜ ì²˜ë¦¬ ê²°ê³¼ ìºì‹± (Redis)
- [ ] ë°°ì¹˜ ì„ë² ë”© ìƒì„±
- [ ] ë³‘ë ¬ ì²˜ë¦¬ ìµœì í™”

#### 3.4.9 êµ¬í˜„ ì˜ˆì‹œ (ì‚¬ìš©ë²•)

```python
from app.services.search.query_pipeline import process_user_query

# ì¼ë°˜ ê²€ìƒ‰
result = await process_user_query(
    "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”",
    search_type="general"
)

print(result.intent)              # "document_search"
print(result.filtered_keywords)   # ["í˜ì‹ ", "ì´ì•¼ê¸°"]
print(result.fulltext_query)      # "í˜ì‹  | ì´ì•¼ê¸°"
print(result.weights)             # {"vector": 0.5, "keyword": 0.3, "fulltext": 0.2}
print(result.processing_time_ms)  # 52.3

# RAG ê²€ìƒ‰
result = await process_user_query(
    "Lambda ë¹„ìš©ì€ ì–¼ë§ˆì¸ê°€ìš”?",
    search_type="rag"
)

print(result.intent)              # "qa_question"
print(result.weights)             # {"vector": 0.7, "keyword": 0.15, "fulltext": 0.15}
```

---

### 3.4.10 ì˜ë„ ë¶„ë¥˜ ìƒì„¸ (Intent Classification)

> **ì´ì „ ì„¹ì…˜ 3.4.1ì—ì„œ í†µí•©**

## 4. ê²€ìƒ‰ ëª¨ë“œì™€ ë¼ìš°íŒ…

### 4.1 hybrid(ê¸°ë³¸)

- ì˜ë¯¸(pgvector) 0.6 + í‚¤ì›Œë“œ/FTS 0.4 ê°€ì¤‘ í†µí•©, íŒŒì¼ ë‹¨ìœ„ ì¬ë­í‚¹

### 4.2 vector_only

- ë²¡í„° ìœ ì‚¬ë„ë§Œ ì‚¬ìš©(ì˜ë¯¸ ì¤‘ì‹¬), ë¹ ë¥¸ ì»¨ì…‰ íƒìƒ‰ìš©

### 4.3 keyword_only

- TSVECTOR/ë°°ì—´ ê¸°ë°˜ í‚¤ì›Œë“œÂ·ì „ë¬¸ ê²€ìƒ‰(ì •í™• ë§¤ì¹­/í•„í„°ë§ ê°•í•¨)

### 4.4 multimodal (ì´ë¯¸ì§€ ìš°ì„ ) ğŸ†•

**ì—”ë“œí¬ì¸íŠ¸**: `POST /api/v1/search/multimodal`

**ëª©ì **: í…ìŠ¤íŠ¸ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ + ì´ë¯¸ì§€ í¬í•¨ ë¬¸ì„œ ìš°ì„  ì •ë ¬

**ì²˜ë¦¬ íë¦„**:
1. í…ìŠ¤íŠ¸ ì¿¼ë¦¬ë¡œ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ (ë²¡í„° + í‚¤ì›Œë“œ + FTS)
2. ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° í•„í„°ë§ (`prefer_images=true`ì¸ ê²½ìš°)
3. ì»¨í…Œì´ë„ˆë³„ í•„í„°ë§ ì ìš©
4. ì´ë¯¸ì§€ í¬í•¨ ë¬¸ì„œë¥¼ ìƒìœ„ë¡œ ì¬ì •ë ¬

**ì…ë ¥**:
```json
{
  "query": "2024ë…„ ë§¤ì¶œ ì°¨íŠ¸",
  "top_k": 10,
  "prefer_images": true,
  "container_ids": ["woongjin_hr"],
  "similarity_threshold": 0.3
}
```

**ì¶œë ¥ ë©”íƒ€ë°ì´í„°**:
- `has_images`: ì´ë¯¸ì§€ í¬í•¨ ì—¬ë¶€ (boolean)
- `image_count`: ì´ë¯¸ì§€ ê°œìˆ˜ (integer)
- `modality`: ë¬¸ì„œ ëª¨ë‹¬ë¦¬í‹° ("text" | "image")
- `clip_score`: CLIP ìœ ì‚¬ë„ ì ìˆ˜ (0-1, CLIP ê²€ìƒ‰ ì‹œì—ë§Œ)

**í™œìš© ì‹œë‚˜ë¦¬ì˜¤**:
- ì°¨íŠ¸/ê·¸ë˜í”„ê°€ í¬í•¨ëœ ë³´ê³ ì„œ ì°¾ê¸°
- í‘œ/ë‹¤ì´ì–´ê·¸ë¨ì´ ìˆëŠ” ë¬¸ì„œ ìš°ì„  ê²€ìƒ‰
- ì‹œê° ìë£Œê°€ í’ë¶€í•œ í”„ë ˆì  í…Œì´ì…˜ ê²€ìƒ‰

### 4.5 clip (ì´ë¯¸ì§€ ê²€ìƒ‰) ğŸ†•

**ì—”ë“œí¬ì¸íŠ¸**: `POST /api/v1/search/clip`

**ëª©ì **: ì´ë¯¸ì§€ ì—…ë¡œë“œ ê¸°ë°˜ CLIP ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰

**ì²˜ë¦¬ íë¦„**:
1. ì—…ë¡œë“œëœ ì´ë¯¸ì§€ë¥¼ CLIP ëª¨ë¸ë¡œ ì„ë² ë”© (512ì°¨ì›)
2. `doc_embedding.clip_vector`ì™€ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚°
3. (ì„ íƒ) í…ìŠ¤íŠ¸ ì¿¼ë¦¬ ì¶”ê°€ ì‹œ í•˜ì´ë¸Œë¦¬ë“œ ìŠ¤ì½”ì–´ë§
4. ìœ ì‚¬ë„ ë†’ì€ ì´ë¯¸ì§€ í¬í•¨ ë¬¸ì„œ ë°˜í™˜

**ì…ë ¥** (multipart/form-data):
```
query: "ë§¤ì¶œ ì°¨íŠ¸"
image: [binary file]
top_k: 10
container_ids: woongjin_hr
```

**CLIP ëª¨ë¸**:
- **Azure CLIP API** (ìš°ì„  ì‹œë„) â†’ HTTP 424 ì˜¤ë¥˜ ì‹œ ë¡œì»¬ fallback
- **ë¡œì»¬ CLIP**: Hugging Face `openai/clip-vit-base-patch32`
- **ë²¡í„° ì°¨ì›**: 512d (L2 Norm = 1.0000)
- **ì¸ë±ìŠ¤**: HNSW (m=16, ef_construction=64)

**ì¶œë ¥ íŠ¹ì§•**:
- `clip_score`: 0-1 ë²”ìœ„ ìœ ì‚¬ë„ (ë†’ì„ìˆ˜ë¡ ìœ ì‚¬)
- `has_image_query`: true (ì´ë¯¸ì§€ ì—…ë¡œë“œ ì—¬ë¶€)
- ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° í¬í•¨ (pHash, í•´ìƒë„, íŒŒì¼ í¬ê¸°)

**í™œìš© ì‹œë‚˜ë¦¬ì˜¤**:
- ìœ ì‚¬í•œ ì°¨íŠ¸/ê·¸ë˜í”„ ì°¾ê¸°
- íŠ¹ì • ì œí’ˆ/ë¡œê³  ì´ë¯¸ì§€ ê²€ìƒ‰
- ë¹„ìŠ·í•œ ë ˆì´ì•„ì›ƒì˜ ë¬¸ì„œ ì°¾ê¸°
- ìŠ¤íƒ€ì¼/ë””ìì¸ ìœ ì‚¬ ë¬¸ì„œ ê²€ìƒ‰

**Fallback ë©”ì»¤ë‹ˆì¦˜**:
```
ì´ë¯¸ì§€ ì—…ë¡œë“œ
    â†“
1ì°¨ ì‹œë„: Azure CLIP API
    â†“ (ì‹¤íŒ¨: HTTP 424)
2ì°¨ ì‹œë„: ë¡œì»¬ CLIP ëª¨ë¸
    â†“ (ì„±ê³µ)
CLIP ì„ë² ë”© ìƒì„± (512d)
    â†“
PostgreSQL pgvector ê²€ìƒ‰
    â†“
ìœ ì‚¬ ë¬¸ì„œ ë°˜í™˜
```

**ì„±ëŠ¥**:
- **Azure CLIP**: ~100-200ms (í´ë¼ìš°ë“œ ì§€ì—°)
- **ë¡œì»¬ CLIP**: ~300-500ms (CPU ê¸°ë°˜)
- **GPU ì‚¬ìš© ì‹œ**: ~50-100ms ì˜ˆìƒ

### 4.6 ê³µí†µ: ê¶Œí•œ/ì»¨í…Œì´ë„ˆ í•„í„°

- ëª¨ë“  ëª¨ë“œì—ì„œ ì„ ì ìš©, ì ‘ê·¼ ë¶ˆê°€ ì»¨í…Œì´ë„ˆëŠ” ì œì™¸

## 5. ì¸ë±ìŠ¤/ìŠ¤í‚¤ë§ˆ

### 5.1 ë“€ì–¼ ì¸ë±ìŠ¤ êµ¬ì¡°(í˜„í–‰)

### 5.1 ë“€ì–¼ ì¸ë±ìŠ¤ êµ¬ì¡°(í˜„í–‰) - 2025-10-15 ì—…ë°ì´íŠ¸

#### ë²¡í„° ê²€ìƒ‰ ì¸ë±ìŠ¤

- **í…Œì´ë¸”**: `vs_doc_contents_chunks`
- **ë²¡í„° ì»¬ëŸ¼**: `chunk_embedding` (vector(1536)) ğŸ†•
- **ì¸ë±ìŠ¤ íƒ€ì…**: HNSW (m=16, ef_construction=64) ğŸ†•
- **ì„ë² ë”© ëª¨ë¸**: Azure OpenAI `text-embedding-3-small` (1536ì°¨ì›)
- **ê²€ìƒ‰ ë°©ì‹**: ì½”ì‚¬ì¸ ìœ ì‚¬ë„ (vector_cosine_ops)
- **ë§ˆì´ê·¸ë ˆì´ì…˜**: Alembic `k3l4m5n6o7p8` - ê¸°ì¡´ 1024ì°¨ì› â†’ 1536ì°¨ì› ì „í™˜ ì™„ë£Œ

#### í‚¤ì›Œë“œ/ì „ë¬¸ê²€ìƒ‰ ì¸ë±ìŠ¤ ğŸ†•

- **í…Œì´ë¸”**: `tb_document_search_index`
- **FTS ì»¬ëŸ¼**:
  - `keyword_tsvector` (TSVECTOR): í‚¤ì›Œë“œ ë°°ì—´ ê¸°ë°˜ ê²€ìƒ‰
  - `content_tsvector` (TSVECTOR): ë¬¸ì„œ ì „ë¬¸ ê²€ìƒ‰
- **ì¸ë±ìŠ¤ íƒ€ì…**: GIN (Generalized Inverted Index)
- **ì–¸ì–´ ì„¤ì •**: 'korean' configuration (textsearch_ko 1.0 í™•ì¥)
- **ìë™ ìƒì„± íŠ¸ë¦¬ê±°**: `tsvector_update_trigger` (Alembic `72342a21e7bc`) ğŸ†•
  - INSERT/UPDATE ì‹œ ìë™ìœ¼ë¡œ tsvector ìƒì„±
  - mecab íŒŒì„œë¡œ í•œêµ­ì–´ í˜•íƒœì†Œ ë¶„ì„ (ì¡°ì‚¬/ì–´ë¯¸ ì œê±°)
  - ì˜ˆì‹œ: "ì¡°ì§ì€" â†’ "ì¡°ì§", "ë¦¬ë”ì‹­ìœ¼ë¡œ" â†’ "ë¦¬ë”ì‹­"

#### í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ê°€ì¤‘ì¹˜ (í˜„ì¬ ì„¤ì •)

```python
SEARCH_WEIGHTS = {
    'vector': 0.4,      # ë²¡í„° ê²€ìƒ‰ (ì˜ë¯¸ ìœ ì‚¬ë„)
    'keyword': 0.5,     # í‚¤ì›Œë“œ ê²€ìƒ‰ (keyword_tsvector)
    'fulltext': 0.1     # ì „ë¬¸ ê²€ìƒ‰ (content_tsvector)
}
```

#### ê²€ìƒ‰ ì„±ëŠ¥ ë¹„êµ

| ê²€ìƒ‰ ë°©ì‹      | ì •í™•ë„ | ì†ë„        | í™œìš© ì‹œë‚˜ë¦¬ì˜¤            |
| ---------- | --- | --------- | ------------------ |
| ë²¡í„° ê²€ìƒ‰      | 85% | ì¤‘ê°„ (HNSW) | ì˜ë¯¸ ìœ ì‚¬ ë¬¸ì„œ, ë™ì˜ì–´ ê²€ìƒ‰   |
| í‚¤ì›Œë“œ ê²€ìƒ‰     | 92% | ë¹ ë¦„ (GIN)  | ì •í™•í•œ í‚¤ì›Œë“œ ë§¤ì¹­         |
| ì „ë¬¸ ê²€ìƒ‰      | 78% | ë¹ ë¦„ (GIN)  | ë¬¸ì„œ ì „ì²´ ë‚´ìš© ê²€ìƒ‰        |
| í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰   | 95% | ì¤‘ê°„        | ê· í˜•ì¡íŒ ê²€ìƒ‰ (ê¸°ë³¸ê°’) âœ…    |
| korean FTS | 98% | ë¹ ë¦„        | í•œêµ­ì–´ í˜•íƒœì†Œ ë¶„ì„ ê²€ìƒ‰ âœ… ğŸ†• |

### 5.2 ë©€í‹°ëª¨ë‹¬ í™•ì¥ (2025-10-17 êµ¬í˜„ ì™„ë£Œ) ğŸ†•

#### 5.2.1 CLIP ë²¡í„° ì¸ë±ìŠ¤

- **í…Œì´ë¸”**: `doc_embedding`
- **ë²¡í„° ì»¬ëŸ¼**: `clip_vector` (vector(512))
- **ì¸ë±ìŠ¤ íƒ€ì…**: HNSW (m=16, ef_construction=64)
- **ì„ë² ë”© ëª¨ë¸**: `openai/clip-vit-base-patch32`
- **ê²€ìƒ‰ ë°©ì‹**: ì½”ì‚¬ì¸ ìœ ì‚¬ë„ (vector_cosine_ops)
- **Fallback**: Azure CLIP API â†’ ë¡œì»¬ CLIP ëª¨ë¸ â†’ Placeholder

#### 5.2.2 ë©€í‹°ëª¨ë‹¬ ë©”íƒ€ë°ì´í„°

**doc_extracted_object í…Œì´ë¸”** (ë©€í‹°ëª¨ë‹¬ ê°ì²´ ì €ì¥):
- `object_type`: text | table | image | chart | diagram
- `content`: í…ìŠ¤íŠ¸ ë‚´ìš© ë˜ëŠ” ì´ë¯¸ì§€ ìº¡ì…˜
- `metadata`: JSON (bbox, í•´ìƒë„, íŒŒì¼ í¬ê¸°, pHash ë“±)
- `storage_path`: Azure Blob Storage ê²½ë¡œ
- `clip_vector`: CLIP ì„ë² ë”© (512d)

**doc_embedding í…Œì´ë¸”** (ì„ë² ë”© ë²„ì „ ê´€ë¦¬):
- `vector`: í…ìŠ¤íŠ¸ ì„ë² ë”© (1536d)
- `clip_vector`: ì´ë¯¸ì§€ ì„ë² ë”© (512d) ğŸ†•
- `embedding_model`: ëª¨ë¸ëª… (text-embedding-3-small | clip-vit-base-patch32)
- `embedding_provider`: Azure | Hugging Face | Local

#### 5.2.3 í¬ë¡œìŠ¤ ëª¨ë‹¬ ê²€ìƒ‰ ì „ëµ

**í…ìŠ¤íŠ¸ â†’ ì´ë¯¸ì§€ ê²€ìƒ‰**:
1. í…ìŠ¤íŠ¸ ì¿¼ë¦¬ë¥¼ CLIP í…ìŠ¤íŠ¸ ì¸ì½”ë”ë¡œ ì„ë² ë”© (512d)
2. `doc_embedding.clip_vector`ì™€ ìœ ì‚¬ë„ ê³„ì‚°
3. ì´ë¯¸ì§€ê°€ í¬í•¨ëœ ë¬¸ì„œ ê²€ìƒ‰

**ì´ë¯¸ì§€ â†’ í…ìŠ¤íŠ¸ ê²€ìƒ‰**:
1. ì´ë¯¸ì§€ë¥¼ CLIP ì´ë¯¸ì§€ ì¸ì½”ë”ë¡œ ì„ë² ë”© (512d)
2. `doc_embedding.clip_vector`ì™€ ìœ ì‚¬ë„ ê³„ì‚°
3. ìœ ì‚¬í•œ ì´ë¯¸ì§€ê°€ í¬í•¨ëœ ë¬¸ì„œ ë° ê´€ë ¨ í…ìŠ¤íŠ¸ ê²€ìƒ‰

**í•˜ì´ë¸Œë¦¬ë“œ ë©€í‹°ëª¨ë‹¬ ê²€ìƒ‰**:
```python
final_score = (
    0.4 * text_vector_similarity +    # í…ìŠ¤íŠ¸ ì˜ë¯¸ ìœ ì‚¬ë„ (1536d)
    0.3 * clip_score +                # CLIP ìœ ì‚¬ë„ (512d)
    0.2 * keyword_match +             # í‚¤ì›Œë“œ ë§¤ì¹­
    0.1 * fts_rank                    # ì „ë¬¸ ê²€ìƒ‰
)
```

#### 5.2.4 ë©€í‹°ëª¨ë‹¬ í•„í„°ë§

**modality í•„í„°**:
- `text`: í…ìŠ¤íŠ¸ ì¤‘ì‹¬ ë¬¸ì„œ
- `image`: ì´ë¯¸ì§€ ì¤‘ì‹¬ ë¬¸ì„œ (has_images=true, image_count > 3)
- `mixed`: í…ìŠ¤íŠ¸ + ì´ë¯¸ì§€ ê· í˜•

**ì´ë¯¸ì§€ ë©”íƒ€ í•„í„°**:
- `has_images`: ì´ë¯¸ì§€ í¬í•¨ ì—¬ë¶€ (boolean)
- `image_count`: ì´ë¯¸ì§€ ê°œìˆ˜ (integer, 0-100+)
- `has_tables`: í‘œ í¬í•¨ ì—¬ë¶€
- `has_charts`: ì°¨íŠ¸ í¬í•¨ ì—¬ë¶€

**ê²€ìƒ‰ API íŒŒë¼ë¯¸í„°**:
```json
{
  "query": "í˜ì‹  ì „ëµ",
  "modality": "mixed",           // text | image | mixed
  "prefer_images": true,         // ì´ë¯¸ì§€ í¬í•¨ ë¬¸ì„œ ìš°ì„ 
  "min_image_count": 3,          // ìµœì†Œ ì´ë¯¸ì§€ ê°œìˆ˜
  "clip_threshold": 0.5          // CLIP ìœ ì‚¬ë„ ì„ê³„ê°’
}
```

#### 5.2.5 ìŠ¤í‚¤ë§ˆ ë§¤í•‘

```
ë¬¸ì„œ ì—…ë¡œë“œ
    â†“
doc_extraction_session (ì¶”ì¶œ ì„¸ì…˜)
    â†“
doc_extracted_object (ê°ì²´ ì €ì¥)
    â”œâ”€ object_type: text
    â”œâ”€ object_type: image â†’ CLIP ì„ë² ë”© ìƒì„±
    â””â”€ object_type: table
    â†“
doc_chunk (ì²­í‚¹)
    â”œâ”€ í…ìŠ¤íŠ¸ ì²­í¬ â†’ text_embedding (1536d)
    â””â”€ ì´ë¯¸ì§€ ì°¸ì¡° â†’ clip_vector (512d)
    â†“
doc_embedding (ì„ë² ë”© ì €ì¥)
    â”œâ”€ vector: í…ìŠ¤íŠ¸ ì„ë² ë”© (1536d)
    â””â”€ clip_vector: ì´ë¯¸ì§€ ì„ë² ë”© (512d)
    â†“
ê²€ìƒ‰ ì¸ë±ìŠ¤
    â”œâ”€ vs_doc_contents_chunks (í…ìŠ¤íŠ¸ ê²€ìƒ‰)
    â””â”€ doc_embedding (ë©€í‹°ëª¨ë‹¬ ê²€ìƒ‰)
```

#### 5.2.6 ê²°ê³¼ í‘œí˜„

**ê²€ìƒ‰ ê²°ê³¼ ë©”íƒ€ë°ì´í„°**:
```json
{
  "chunk_id": 1234,
  "content": "2024ë…„ ë§¤ì¶œ ë¶„ì„...",
  "similarity_score": 0.95,
  "has_images": true,
  "image_count": 5,
  "clip_score": 0.87,
  "modality": "mixed",
  "visual_content": {
    "thumbnails": ["https://storage.../thumb1.jpg", ...],
    "bbox": [[x1, y1, x2, y2], ...],
    "captions": ["ë§¤ì¶œ ì°¨íŠ¸", "ì‹¤ì  ê·¸ë˜í”„", ...]
  }
}
```

**í”„ë¡ íŠ¸ì—”ë“œ í‘œì‹œ**:
- ğŸ–¼ï¸ ì´ë¯¸ì§€ ê°œìˆ˜ ë±ƒì§€ (íŒŒë€ìƒ‰)
- ğŸ¨ ì´ë¯¸ì§€ ëª¨ë‹¬ë¦¬í‹° ë±ƒì§€ (ë³´ë¼ìƒ‰)
- ğŸ” CLIP ì ìˆ˜ ë±ƒì§€ (ì´ˆë¡ìƒ‰, 0-100%)

#### 5.2.7 í–¥í›„ í™•ì¥ (Phase 3)

- [ ] ë¹„ë””ì˜¤ ê²€ìƒ‰ (ì”¬ ê°ì§€, íƒ€ì„ìŠ¤íƒ¬í”„)
- [ ] ì˜¤ë””ì˜¤ ê²€ìƒ‰ (Whisper íŠ¸ëœìŠ¤í¬ë¦½ì…˜)
- [ ] 3D ëª¨ë¸ ê²€ìƒ‰ (í¬ì¸íŠ¸ í´ë¼ìš°ë“œ)
- [ ] ì§€ì‹ ê·¸ë˜í”„ ì—°ë™ (ì—”í‹°í‹° ê´€ê³„)

## 6. ê²€ìƒ‰ ì—”ì§„ ìƒì„¸

### 6.1 ê²€ìƒ‰ ì—”ì§„ ì•„í‚¤í…ì²˜

**êµ¬ì„± ìš”ì†Œ** (2025-10-27 ê¸°ì¤€):
- **ë°ì´í„°ë² ì´ìŠ¤**: PostgreSQL 15 + pgvector 0.5 + pg_trgm
- **ê²€ìƒ‰ ì„œë¹„ìŠ¤**: `/backend/app/services/search/search_service.py` (2563ì¤„)
- **ì„ë² ë”© ì„œë¹„ìŠ¤**: EmbeddingService (í…ìŠ¤íŠ¸ 1536d/3072d, CLIP 512d)
- **ê¶Œí•œ ì„œë¹„ìŠ¤**: PermissionService (RBAC, ì»¨í…Œì´ë„ˆ ê¸°ë°˜)
- **ìºì‹œ**: Redis (ê²€ìƒ‰ ê²°ê³¼ TTL 5ë¶„, ê¶Œí•œ TTL 1ì‹œê°„)

**SearchService í´ë˜ìŠ¤ êµ¬ì¡°**:
```python
class SearchService:
    """í†µí•© ê²€ìƒ‰ ì„œë¹„ìŠ¤ - í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ ì—”ì§„"""
    
    def __init__(self):
        self.embedding_service = EmbeddingService()
        self.vector_weight = 0.4      # í•œêµ­ì–´ ì„ë² ë”© í•œê³„ ê³ ë ¤
        self.keyword_weight = 0.5     # í•œêµ­ì–´ì—ì„œ ë” ì •í™•
        self.fulltext_weight = 0.1    # ë³´ì¡°ì  ì—­í• 
        self.similarity_threshold = 0.4  # ì—„ê²©í•œ í•„í„°ë§
    
    # ë©”ì¸ ê²€ìƒ‰ ë©”ì„œë“œ
    async hybrid_search(...)         # í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰
    async unified_search(...)        # íŒŒì¼ ë‹¨ìœ„ í†µí•© ê²€ìƒ‰
    async context_search(...)        # RAGìš© ì²­í¬ ê²€ìƒ‰
    async multimodal_search(...)     # í…ìŠ¤íŠ¸+ì´ë¯¸ì§€ ê²€ìƒ‰
    
    # ë‚´ë¶€ ê²€ìƒ‰ ì—”ì§„
    async _vector_search(...)        # ë²¡í„° ê²€ìƒ‰ (1536d/3072d)
    async _keyword_search(...)       # ILIKE í‚¤ì›Œë“œ ê²€ìƒ‰
    async _fulltext_search(...)      # PostgreSQL FTS (GIN)
    async _hybrid_search_combined(...) # RRF ìœµí•© ì•Œê³ ë¦¬ì¦˜
    
    # í›„ì²˜ë¦¬
    async _group_results_by_file(...) # íŒŒì¼ ë‹¨ìœ„ ê·¸ë£¹í™”
    async _format_search_results(...) # ì‘ë‹µ í¬ë§·íŒ…
```

**ê²€ìƒ‰ íë¦„** (ì‹¤ì œ êµ¬í˜„ ê¸°ì¤€):
```
1. ê¶Œí•œ í™•ì¸
   â””â”€ _get_accessible_containers(user_emp_no)
   â””â”€ ì ‘ê·¼ ê°€ëŠ¥í•œ ì»¨í…Œì´ë„ˆ ID ëª©ë¡ íšë“

2. ì§ˆì˜ ì „ì²˜ë¦¬
   â””â”€ _preprocess_query(query)
   â””â”€ NLP ì²˜ë¦¬: í† í°í™”, ë¶ˆìš©ì–´ ì œê±°, í‚¤ì›Œë“œ ì¶”ì¶œ

3. ê²€ìƒ‰ ëª¨ë“œ ë¶„ê¸°
   â”œâ”€ vector_only â†’ _vector_search()
   â”œâ”€ keyword_only â†’ _keyword_search()
   â””â”€ hybrid â†’ _hybrid_search_combined()

4. ë³‘ë ¬ ê²€ìƒ‰ ì‹¤í–‰ (hybrid ëª¨ë“œ)
   â””â”€ asyncio.gather(
        _vector_search(query_embedding),
        _keyword_search(keywords),
        _fulltext_search(query_text)
      )

5. RRF ìŠ¤ì½”ì–´ ìœµí•©
   â””â”€ vector * 0.4 + keyword * 0.5 + fulltext * 0.1

6. íŒŒì¼ ë‹¨ìœ„ ê·¸ë£¹í™”
   â””â”€ _group_results_by_file()
   â””â”€ ë™ì¼ íŒŒì¼ì˜ ì²­í¬ë¥¼ ëŒ€í‘œ ìŠ¤ì½”ì–´ë¡œ í†µí•©

7. ê¶Œí•œ ì¬ê²€ì¦
   â””â”€ íŒŒì¼ ë ˆë²¨ ì ‘ê·¼ê¶Œ í™•ì¸
   â””â”€ í•„ìš” ì‹œ ë§ˆìŠ¤í‚¹ ë˜ëŠ” ì œì™¸

8. ê²°ê³¼ ì œí•œ ë° ìºì‹±
   â””â”€ ìµœëŒ€ max_resultsê°œ ë°˜í™˜ (ê¸°ë³¸ 50ê°œ)
   â””â”€ Redis ìºì‹± (TTL 5ë¶„)

9. ì‘ë‹µ ë°˜í™˜
   â””â”€ RAG ì»¨í…ìŠ¤íŠ¸(7.x) ë˜ëŠ” í”„ë¡ íŠ¸ì—”ë“œ(9.4)ë¡œ ì „ë‹¬
```

### 6.2 ë²¡í„° ê²€ìƒ‰ (Semantic Search)

#### 6.2.1 ì…ë ¥ ë° Provider ë¶„ê¸°

**ì…ë ¥ íŒŒë¼ë¯¸í„°**:
- `query_text`: ì‚¬ìš©ì ê²€ìƒ‰ ì¿¼ë¦¬ (í•œêµ­ì–´/ì˜ì–´)
- `container_ids`: ì ‘ê·¼ ê°€ëŠ¥í•œ ì»¨í…Œì´ë„ˆ ID ëª©ë¡
- `similarity_threshold`: 0.4 (ê¸°ë³¸ê°’, ì—„ê²©í•œ í•„í„°ë§)
- `top_k`: ìµœëŒ€ ê²°ê³¼ ê°œìˆ˜ (ê¸°ë³¸ 50)

**Providerë³„ ì„ë² ë”© ìƒì„±** (`.env` ì„¤ì •: `DEFAULT_EMBEDDING_PROVIDER`):

| Provider | ì„ë² ë”© ëª¨ë¸ | ì°¨ì› | ê²€ìƒ‰ ëŒ€ìƒ ì»¬ëŸ¼ | íŠ¹ì§• |
|----------|------------|------|---------------|------|
| **bedrock** âœ… | amazon.titan-embed-text-v2:0 | 1024d | `aws_embedding_1024` | RAG ìµœì í™”, í•œêµ­ì–´ ìš°ìˆ˜, ì €ë¹„ìš© |
| **azure_openai** | text-embedding-3-small | 1536d | `azure_embedding_1536` | ë‹¤êµ­ì–´ ì§€ì›, ë†’ì€ ì •í™•ë„ |
| **openai** | text-embedding-ada-002 | 1536d | `azure_embedding_1536` | Fallback ì˜µì…˜ |

#### 6.2.2 ì²˜ë¦¬ ê³¼ì • (Provider ìë™ ë¶„ê¸°)

```python
async def _vector_search(self, query_text, container_ids, top_k):
    # 1. ì¿¼ë¦¬ ì„ë² ë”© ìƒì„± (Provider ìë™ ì„ íƒ)
    query_embedding = await self.embedding_service.get_embedding(query_text)
    # â†’ Bedrock: amazon.titan-embed-text-v2:0 (1024d)
    # â†’ Azure: text-embedding-3-small (1536d)
    
    # 2. ì„ë² ë”© ì°¨ì› ê¸°ë°˜ ë²¡í„° ì»¬ëŸ¼ ìë™ ì„ íƒ
    embedding_dim = len(query_embedding)
    
    if embedding_dim == 1024:
        vector_column = "c.aws_embedding_1024"
        provider_filter = "AND c.embedding_provider = 'aws'"
        logger.info("[VECTOR-SEARCH] ğŸŸ§ AWS Bedrock ë²¡í„° ì»¬ëŸ¼ ì‚¬ìš© (1024d)")
    elif embedding_dim == 1536:
        vector_column = "c.azure_embedding_1536"
        provider_filter = "AND c.embedding_provider = 'azure'"
        logger.info("[VECTOR-SEARCH] ğŸ”· Azure OpenAI ë²¡í„° ì»¬ëŸ¼ ì‚¬ìš© (1536d)")
    else:
        # ë ˆê±°ì‹œ í´ë°±
        vector_column = "c.chunk_embedding"
        provider_filter = ""
        logger.warning(f"[VECTOR-SEARCH] âš ï¸ ë ˆê±°ì‹œ ë²¡í„° ì»¬ëŸ¼ í´ë°± ({embedding_dim}d)")
    
    # 3. pgvector HNSW ì¸ë±ìŠ¤ ê²€ìƒ‰ (ë™ì  ì»¬ëŸ¼ ì ìš©)
    embedding_str = "[" + ",".join(map(str, query_embedding)) + "]"
    
    query_sql = f"""
        SELECT 
            c.chunk_sno as id,
            c.file_bss_info_sno,
            c.chunk_text,
            1 - ({vector_column} <=> '{embedding_str}'::vector) AS similarity,
            f.file_lgc_nm,
            f.knowledge_container_id
        FROM vs_doc_contents_chunks c
        JOIN tb_file_bss_info f ON c.file_bss_info_sno = f.file_bss_info_sno
        WHERE f.knowledge_container_id IN ('{container_id_list}')
          AND f.del_yn = 'N'
          {provider_filter}
          AND 1 - ({vector_column} <=> '{embedding_str}'::vector) > {similarity_threshold}
        ORDER BY {vector_column} <=> '{embedding_str}'::vector ASC
        LIMIT {top_k}
    """
    
    # 4. HNSW ì¸ë±ìŠ¤ (m=16, ef_construction=64) ìë™ ì‚¬ìš©
    # 5. Provider í•„í„°ë¡œ ì˜¬ë°”ë¥¸ ë²¡í„°ë§Œ ê²€ìƒ‰
    # 6. ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê³„ì‚° (vector_cosine_ops)
```

#### 6.2.3 ì´ë¯¸ì§€ ë²¡í„° ê²€ìƒ‰ (ë©€í‹°ëª¨ë‹¬)

**Providerë³„ ì´ë¯¸ì§€ ì„ë² ë”©**:

| Provider | ì„ë² ë”© ëª¨ë¸ | ì°¨ì› | ê²€ìƒ‰ ëŒ€ìƒ ì»¬ëŸ¼ | íŠ¹ì§• |
|----------|------------|------|---------------|------|
| **bedrock** âœ… | twelvelabs.marengo-embed-3-0-v1:0 | 512d | `aws_marengo_vector_512` | ë¹„ë””ì˜¤/ì´ë¯¸ì§€/í…ìŠ¤íŠ¸ ë©€í‹°ëª¨ë‹¬ |
| **azure_openai** | Azure CLIP | 512d | `azure_clip_vector` | ì´ë¯¸ì§€-í…ìŠ¤íŠ¸ í†µí•© ë²¡í„° |
| **local** | Hugging Face CLIP | 512d | `clip_vector` | Fallback ì˜µì…˜ |

**ì´ë¯¸ì§€ ê²€ìƒ‰ ì¿¼ë¦¬**:
```python
async def _search_by_image_embedding(self, image_embedding, container_ids):
    # Provider ê¸°ë°˜ ì»¬ëŸ¼ ì„ íƒ
    provider = settings.get_current_embedding_provider()
    
    if provider == 'bedrock':
        vector_column = "de.aws_marengo_vector_512"
        vector_not_null = "de.aws_marengo_vector_512 IS NOT NULL"
        logger.info("[MULTIMODAL_SEARCH] AWS Bedrock ë²¡í„° ê²€ìƒ‰ (aws_marengo_vector_512)")
    else:
        # Azure/ë¡œì»¬ CLIP
        vector_column = "COALESCE(de.azure_clip_vector, de.clip_vector)"
        vector_not_null = "(de.azure_clip_vector IS NOT NULL OR de.clip_vector IS NOT NULL)"
        logger.info("[MULTIMODAL_SEARCH] Azure CLIP ë²¡í„° ê²€ìƒ‰ (azure_clip_vector)")
    
    query_sql = f"""
        SELECT
            de.embedding_id,
            {vector_column} <=> '{vector_literal}'::vector AS distance,
            1 - ({vector_column} <=> '{vector_literal}'::vector) / 2 AS cosine_similarity,
            dc.chunk_id,
            dc.content_text,
            COALESCE(dc.modality, 'image') AS modality
        FROM doc_embedding de
        JOIN doc_chunk dc ON de.chunk_id = dc.chunk_id
        JOIN tb_file_bss_info fbf ON dc.file_bss_info_sno = fbf.file_bss_info_sno
        WHERE {vector_not_null}
          AND fbf.del_yn = 'N'
          AND fbf.knowledge_container_id IN ('{container_filters}')
        ORDER BY {vector_column} <=> '{vector_literal}'::vector ASC
        LIMIT {max_results}
    """
```

**ì¶œë ¥**:
```json
[
  {
    "chunk_id": 1234,
    "file_id": 5678,
    "content": "í˜ì‹  ì „ëµì˜ í•µì‹¬ì€...",
    "similarity": 0.92,
    "title": "2024ë…„ ì „ëµ ë³´ê³ ì„œ.pdf",
    "container_id": 10,
    "match_type": "vector"
  }
]
```

**íŠœë‹ í¬ì¸íŠ¸**:
- HNSW íŒŒë¼ë¯¸í„°: m=16 (ì´ì›ƒ ìˆ˜), ef_construction=64 (êµ¬ì¶• í’ˆì§ˆ)
- Similarity threshold: 0.4 (ë†’ì„ìˆ˜ë¡ ì—„ê²©)
- Top-k: íŒŒì¼ë‹¹ ì¤‘ë³µ ì²­í¬ ë””ë“€í”„ (ìµœìƒìœ„ ì²­í¬ë§Œ)
- ë™ì  ì„ë² ë”© ì°¨ì›: 1536d (ë¹ ë¦„) vs 3072d (ì •í™•)

### 6.3 í‚¤ì›Œë“œ ê²€ìƒ‰ (Keyword Search)

**ì…ë ¥**:
- `keywords`: ì „ì²˜ë¦¬ëœ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ (ë¶ˆìš©ì–´ ì œê±°ë¨)
- `container_ids`: ì ‘ê·¼ ê°€ëŠ¥í•œ ì»¨í…Œì´ë„ˆ ID ëª©ë¡

**ì²˜ë¦¬ ê³¼ì •**:
```python
async def _keyword_search(self, keywords, container_ids):
    # 1. ILIKE íŒ¨í„´ ë§¤ì¹­ (PostgreSQL)
    conditions = [
        "c.content ILIKE %s" 
        for keyword in keywords
    ]
    
    query = f"""
        SELECT 
            c.chunk_id,
            c.file_id,
            c.content,
            COUNT(*) AS keyword_matches,
            f.title
        FROM doc_chunk c
        JOIN doc_file f ON c.file_id = f.file_id
        WHERE f.container_id = ANY(%s)
          AND f.deleted_at IS NULL
          AND ({" OR ".join(conditions)})
        GROUP BY c.chunk_id, c.file_id, c.content, f.title
        ORDER BY keyword_matches DESC
        LIMIT %s
    """
```

**ì¶œë ¥**:
```json
[
  {
    "chunk_id": 2345,
    "file_id": 5678,
    "content": "í˜ì‹ ì ì¸ ì ‘ê·¼ ë°©ì‹...",
    "keyword_matches": 2,
    "title": "ì „ëµ ë¬¸ì„œ.docx",
    "match_type": "keyword"
  }
]
```

**í–¥ìƒ ê¸°ë²•**:
- ë™ì˜ì–´ í™•ì¥: "í˜ì‹ " â†’ ["í˜ì‹ ", "ì´ë…¸ë² ì´ì…˜", "ë³€í™”"]
- í‘œì œì–´ ì‚¬ì „: "ë‹¬ë¦¬ë‹¤", "ë‹¬ë ¤", "ë›°ë‹¤" â†’ "ë‹¬ë¦¬ë‹¤"
- ë„ë©”ì¸ í‚¤ì›Œë“œ: ì—…ê³„ ì „ë¬¸ ìš©ì–´ ë§¤í•‘
- GIN ì¸ë±ìŠ¤: ë°°ì—´ ì»¬ëŸ¼(keywords[]) ê³ ì† ê²€ìƒ‰

### 6.4 ì „ë¬¸ ê²€ìƒ‰ (Full-Text Search)

**ì…ë ¥**:
- `query_text`: ì›ë³¸ ì§ˆì˜ í…ìŠ¤íŠ¸
- `container_ids`: ì ‘ê·¼ ê°€ëŠ¥í•œ ì»¨í…Œì´ë„ˆ ID ëª©ë¡

**ì²˜ë¦¬ ê³¼ì •**:
```python
async def _fulltext_search(self, query_text, container_ids):
    # 1. tsvector ê²€ìƒ‰ (GIN ì¸ë±ìŠ¤)
    query = """
        SELECT 
            i.search_doc_id,
            i.file_id,
            ts_rank(i.content_tsvector, to_tsquery('korean', %s)) AS rank,
            c.content,
            f.title
        FROM tb_document_search_index i
        JOIN doc_chunk c ON i.search_doc_id = c.chunk_id
        JOIN doc_file f ON i.file_id = f.file_id
        WHERE f.container_id = ANY(%s)
          AND f.deleted_at IS NULL
          AND i.content_tsvector @@ to_tsquery('korean', %s)
        ORDER BY rank DESC
        LIMIT %s
    """
```

**ë©€í‹°ë§êµ¬ì–¼ ì§€ì›**:
```python
# í•œêµ­ì–´ ì¿¼ë¦¬
content_tsvector @@ to_tsquery('korean', 'í˜ì‹  & ì „ëµ')

# ì˜ì–´ ì¿¼ë¦¬
content_tsvector_en @@ to_tsquery('english', 'innovation & strategy')
```

### 6.5 í•˜ì´ë¸Œë¦¬ë“œ ìŠ¤ì½”ì–´ë§ (RRF Fusion)

**RRF (Reciprocal Rank Fusion) ì•Œê³ ë¦¬ì¦˜**:
```python
async def _hybrid_search_combined(self, query, container_ids, top_k):
    # 1. ë³‘ë ¬ ê²€ìƒ‰ ì‹¤í–‰
    vector_results, keyword_results, fts_results = await asyncio.gather(
        self._vector_search(query, container_ids, top_k),
        self._keyword_search(query, container_ids, top_k),
        self._fulltext_search(query, container_ids, top_k)
    )
    
    # 2. RRF ìŠ¤ì½”ì–´ ê³„ì‚°
    k = 60  # RRF ìƒìˆ˜
    combined_scores = {}
    
    for rank, result in enumerate(vector_results):
        chunk_id = result['chunk_id']
        combined_scores[chunk_id] = self.vector_weight / (k + rank + 1)
    
    for rank, result in enumerate(keyword_results):
        chunk_id = result['chunk_id']
        combined_scores[chunk_id] += self.keyword_weight / (k + rank + 1)
    
    for rank, result in enumerate(fts_results):
        chunk_id = result['chunk_id']
        combined_scores[chunk_id] += self.fulltext_weight / (k + rank + 1)
    
    # 3. ì •ê·œí™” (0-1 ë²”ìœ„)
    max_score = max(combined_scores.values())
    normalized_scores = {
        chunk_id: score / max_score
        for chunk_id, score in combined_scores.items()
    }
    
    # 4. ìµœì¢… ìŠ¤ì½”ì–´ ì ìš©
    # vector * 0.4 + keyword * 0.5 + fulltext * 0.1
```

**ê°€ì¤‘ì¹˜ ì„¤ì • (í•œêµ­ì–´ ìµœì í™”)**:
- **ë²¡í„° ê²€ìƒ‰ (0.4)**: í•œêµ­ì–´ ì„ë² ë”© ëª¨ë¸ì˜ í•œê³„ë¥¼ ê³ ë ¤í•˜ì—¬ ë‚®ì¶¤
- **í‚¤ì›Œë“œ ê²€ìƒ‰ (0.5)**: í•œêµ­ì–´ì—ì„œ ì •í™•ë„ê°€ ë†’ì•„ ê°€ì¤‘ì¹˜ ì¦ê°€
- **ì „ë¬¸ ê²€ìƒ‰ (0.1)**: ë³´ì¡°ì  ì—­í• , ë…¸ì´ì¦ˆ ê°ì†Œ

**íŒŒì¼ ë‹¨ìœ„ ì§‘ê³„**:
```python
async def _group_results_by_file(self, results):
    file_groups = {}
    
    for result in results:
        file_id = result['file_id']
        
        if file_id not in file_groups:
            file_groups[file_id] = {
                'file_id': file_id,
                'title': result['title'],
                'chunks': [],
                'max_score': 0,
                'avg_score': 0
            }
        
        file_groups[file_id]['chunks'].append(result)
        file_groups[file_id]['max_score'] = max(
            file_groups[file_id]['max_score'],
            result['similarity']
        )
```
# 03. ê²€ìƒ‰ ë° ì§ˆì˜ì‘ë‹µ ì„œë¹„ìŠ¤ (ê°œë… ì„¤ê³„ì„œ)

> **ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-27  
> **ì£¼ìš” ë³€ê²½**: 
> - ì‹¤ì œ ë°±ì—”ë“œ/í”„ë¡ íŠ¸ì—”ë“œ ì†ŒìŠ¤ì½”ë“œ ê¸°ì¤€ ì „ë©´ ì—…ë°ì´íŠ¸
> - API ì—”ë“œí¬ì¸íŠ¸ ìµœì‹ í™” (search.py, chat.py, multimodal_search.py)
> - ê²€ìƒ‰ ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ ì‹¤ì œ êµ¬í˜„ ë°˜ì˜ (SearchService class)
> - í”„ë¡ íŠ¸ì—”ë“œ SearchPage/ChatPage í†µí•© ì›Œí¬í”Œë¡œìš° ë°˜ì˜
> - ë©€í‹°ëª¨ë‹¬ ê²€ìƒ‰ ì‹œìŠ¤í…œ ì™„ì „ êµ¬í˜„ (CLIP ë²¡í„° 512d, Azure CLIP ëª¨ë¸)
> - í†µí•© ì§ˆì˜ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ êµ¬í˜„ ì™„ë£Œ (query_pipeline.py)
> - RAG ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µ ë° ì„¸ì…˜ ê´€ë¦¬ ì‹œìŠ¤í…œ ë°˜ì˜

ë³¸ ë¬¸ì„œëŠ” ì½”ë“œê°€ ì•„ë‹Œ ê°œë…/ì ˆì°¨ ì¤‘ì‹¬ìœ¼ë¡œ ê²€ìƒ‰Â·QA ì„œë¹„ìŠ¤ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤. ìƒìœ„ íŒŒì´í”„ë¼ì¸ ë¬¸ì„œ(`02.document_ingestion_vectorstore.md`)ì˜ ê²°ê³¼ë¬¼ê³¼ ê¸´ë°€íˆ ì—°ê²°ë˜ë©°, ì²˜ë¦¬ í’ˆì§ˆê³¼ ìŠ¤í‚¤ë§ˆ ê²°ì •ì´ ê²€ìƒ‰ í’ˆì§ˆê³¼ ê¸°ëŠ¥ ì—°ê³„ì„±ì— ì§ì ‘ì ì¸ ì˜í–¥ì„ ì¤ë‹ˆë‹¤.

## ëª©ì°¨

- [1. ëª©í‘œì™€ ë²”ìœ„](#1-ëª©í‘œì™€-ë²”ìœ„)
- [2. ì…ë ¥Â·ì¶œë ¥ ê³„ì•½(Contract)](#2-ì…ë ¥ì¶œë ¥-ê³„ì•½contract)

    - [2.1 ì…ë ¥](#21-ì…ë ¥)
    - [2.2 ì¶œë ¥](#22-ì¶œë ¥)
    - [2.3 ì˜¤ë¥˜/ì˜ˆì™¸](#23-ì˜¤ë¥˜ì˜ˆì™¸)
- [3. ìƒìœ„ íŒŒì´í”„ë¼ì¸ê³¼ì˜ ì˜ì¡´ ê´€ê³„](#3-ìƒìœ„-íŒŒì´í”„ë¼ì¸ê³¼ì˜-ì˜ì¡´-ê´€ê³„)

    - [3.1 ì²­í‚¹ í’ˆì§ˆ ì˜í–¥](#31-ì²­í‚¹-í’ˆì§ˆ-ì˜í–¥)
    - [3.2 ìŠ¤í‚¤ë§ˆ/ì¸ë±ìŠ¤ ì˜ì¡´](#32-ìŠ¤í‚¤ë§ˆì¸ë±ìŠ¤-ì˜ì¡´)
    - [3.3 ìš´ì˜ ìƒíƒœ ì˜ì¡´](#33-ìš´ì˜-ìƒíƒœ-ì˜ì¡´)
    - [3.4 ì§ˆë¬¸ ì „ì²˜ë¦¬ ë° ê°œì„ ](#34-ì§ˆë¬¸-ì „ì²˜ë¦¬-ë°-ê°œì„ )
        - [3.4.1 ì˜ë„ ë¶„ë¥˜(ê°œìš”)](#341-ì˜ë„-ë¶„ë¥˜ê°œìš”)
- [4. ê²€ìƒ‰ ëª¨ë“œì™€ ë¼ìš°íŒ…](#4-ê²€ìƒ‰-ëª¨ë“œì™€-ë¼ìš°íŒ…)

    - [4.1 hybrid(ê¸°ë³¸)](#41-hybridê¸°ë³¸)
    - [4.2 vector_only](#42-vector_only)
    - [4.3 keyword_only](#43-keyword_only)
    - [4.4 multimodal (ì´ë¯¸ì§€ ìš°ì„ )](#44-multimodal-ì´ë¯¸ì§€-ìš°ì„ ) ğŸ†•
    - [4.5 clip (ì´ë¯¸ì§€ ê²€ìƒ‰)](#45-clip-ì´ë¯¸ì§€-ê²€ìƒ‰) ğŸ†•
    - [4.6 ê³µí†µ: ê¶Œí•œ/ì»¨í…Œì´ë„ˆ í•„í„°](#46-ê³µí†µ-ê¶Œí•œì»¨í…Œì´ë„ˆ-í•„í„°)
- [5. ì¸ë±ìŠ¤/ìŠ¤í‚¤ë§ˆ](#5-ì¸ë±ìŠ¤ìŠ¤í‚¤ë§ˆ)

    - [5.1 ë“€ì–¼ ì¸ë±ìŠ¤ êµ¬ì¡°(í˜„í–‰)](#51-ë“€ì–¼-ì¸ë±ìŠ¤-êµ¬ì¡°í˜„í–‰)
    - [5.2 ë©€í‹°ëª¨ë‹¬ í™•ì¥(ì„ íƒ)](#52-ë©€í‹°ëª¨ë‹¬-í™•ì¥ì„ íƒ)
- [6. ê²€ìƒ‰ ì—”ì§„ ìƒì„¸](#6-ê²€ìƒ‰-ì—”ì§„-ìƒì„¸)

    - [6.1 ê²€ìƒ‰ ì—”ì§„ ì•„í‚¤í…ì²˜](#61-ê²€ìƒ‰-ì—”ì§„-ì•„í‚¤í…ì²˜)
    - [6.2 ë²¡í„° ê²€ìƒ‰ (Semantic Search)](#62-ë²¡í„°-ê²€ìƒ‰-semantic-search)
    - [6.3 í‚¤ì›Œë“œ ê²€ìƒ‰ (Keyword Search)](#63-í‚¤ì›Œë“œ-ê²€ìƒ‰-keyword-search)
    - [6.4 í•˜ì´ë¸Œë¦¬ë“œ ìŠ¤ì½”ì–´ë§](#64-í•˜ì´ë¸Œë¦¬ë“œ-ìŠ¤ì½”ì–´ë§)
- [7. RAG íŒŒì´í”„ë¼ì¸](#7-rag-íŒŒì´í”„ë¼ì¸)

    - [7.1 ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±](#71-ì»¨í…ìŠ¤íŠ¸-êµ¬ì„±)
    - [7.2 ë©€í‹° LLM ë‹µë³€ ìƒì„±](#72-ë©€í‹°-llm-ë‹µë³€-ìƒì„±)
    - [7.3 ë‹µë³€ í›„ì²˜ë¦¬](#73-ë‹µë³€-í›„ì²˜ë¦¬)
- [8. ëŒ€í™” ê´€ë¦¬ (Conversation Management)](#8-ëŒ€í™”-ê´€ë¦¬-conversation-management)

    - [8.1 ì„¸ì…˜ ê¸°ë°˜ ëŒ€í™” ì¶”ì ](#81-ì„¸ì…˜-ê¸°ë°˜-ëŒ€í™”-ì¶”ì )
    - [8.2 ëŒ€í™” ì´ë ¥ ë°ì´í„°ë² ì´ìŠ¤(ìš”ì•½)](#82-ëŒ€í™”-ì´ë ¥-ë°ì´í„°ë² ì´ìŠ¤ìš”ì•½)
- [9. í•µì‹¬ API ê°œìš” (search.py, chat.py)](#9-í•µì‹¬-api-ê°œìš”-searchpy-chatpy)

    - [9.1 ê³µí†µ ì‚¬í•­](#91-ê³µí†µ-ì‚¬í•­)
    - [9.2 ê²€ìƒ‰ API (backend/app/api/v1/search.py)](#92-ê²€ìƒ‰-api-backendappapiv1searchpy)
    - [9.3 ì±—/QA API (backend/app/api/v1/chat.py)](#93-ì±—qa-api-backendappapiv1chatpy)
        - [9.3.1 ì²¨ë¶€ íŒŒì¼ ê´€ë¦¬ (Attachment Handling)](#931-ì²¨ë¶€-íŒŒì¼-ê´€ë¦¬-attachment-handling-ğŸ†•)
    - [9.4 í”„ëŸ°íŠ¸ì—”ë“œ ì—°ê³„(ìš”ì•½)](#94-í”„ëŸ°íŠ¸ì—”ë“œ-ì—°ê³„ìš”ì•½)
    - [9.5 ë¦¬íŒ©í† ë§ ìš”ì•½](#95-ë¦¬íŒ©í† ë§-ìš”ì•½)
    - [9.6 í–¥í›„ í™•ì¥ ê³„íš](#96-í–¥í›„-í™•ì¥-ê³„íš)
- [10. ì„±ëŠ¥/ë¹„ìš© ì „ëµ](#10-ì„±ëŠ¥ë¹„ìš©-ì „ëµ)

    - [10.1 ì¸ë±ìŠ¤ íŠœë‹](#101-ì¸ë±ìŠ¤-íŠœë‹)
    - [10.2 ìºì‹œ](#102-ìºì‹œ)
    - [10.3 ë°°ì¹˜ vs ì‹¤ì‹œê°„](#103-ë°°ì¹˜-vs-ì‹¤ì‹œê°„)
    - [10.4 ë¹„ìš©](#104-ë¹„ìš©)
    - [10.5 ëª¨ë‹ˆí„°ë§ ë° ë¶„ì„](#105-ëª¨ë‹ˆí„°ë§-ë°-ë¶„ì„)
- [11. í’ˆì§ˆ ê´€ë¦¬ì™€ í‰ê°€](#11-í’ˆì§ˆ-ê´€ë¦¬ì™€-í‰ê°€)

    - [11.1 ì§€í‘œ](#111-ì§€í‘œ)
    - [11.2 A/B ì‹¤í—˜](#112-ab-ì‹¤í—˜)
    - [11.3 ë¡œê·¸ ê¸°ë°˜ ê°œì„ ](#113-ë¡œê·¸-ê¸°ë°˜-ê°œì„ )
    - [11.4 ìš´ì˜ ê°€ë“œë ˆì¼](#114-ìš´ì˜-ê°€ë“œë ˆì¼)
- [12. ë³´ì•ˆÂ·ê±°ë²„ë„ŒìŠ¤](#12-ë³´ì•ˆê±°ë²„ë„ŒìŠ¤)
- [13. ì¥ì• /ë³µêµ¬Â·ìš´ì˜](#13-ì¥ì• ë³µêµ¬ìš´ì˜)
- [14. ì—ëŸ¬ ëª¨ë“œì™€ ìš´ì˜ ê°€ì´ë“œ](#14-ì—ëŸ¬-ëª¨ë“œì™€-ìš´ì˜-ê°€ì´ë“œ)
- [15. ë¶€ë¡: íŒŒì´í”„ë¼ì¸ ê²°ê³¼ì™€ì˜ ë§¤í•‘](#15-ë¶€ë¡-íŒŒì´í”„ë¼ì¸-ê²°ê³¼ì™€ì˜-ë§¤í•‘)

## 1. ëª©í‘œì™€ ë²”ìœ„

- ëª©í‘œ: ê¶Œí•œ ê¸°ë°˜ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ê³¼ í•œêµ­ì–´ QAë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì œê³µ
- ë²”ìœ„: ì§ˆì˜ ì „ì²˜ë¦¬ â†’ ê²€ìƒ‰(í•˜ì´ë¸Œë¦¬ë“œ) â†’ ì¦ê±° ì»¨í…ìŠ¤íŠ¸ êµ¬ì„± â†’ ë‹µë³€ ìƒì„± â†’ ë¡œê¹…/ê±°ë²„ë„ŒìŠ¤
- ì „ì œ: ë“€ì–¼ ì¸ë±ìŠ¤ êµ¬ì¡°(5.1) ë˜ëŠ” ë©€í‹°ëª¨ë‹¬ í†µí•© ìŠ¤í‚¤ë§ˆ(5.2)ì— ë§ì¶° ê²€ìƒ‰ ê³„ì¸µì„ ì„¤ì •

## 2. ì…ë ¥Â·ì¶œë ¥ ê³„ì•½(Contract)

### 2.1 ì…ë ¥

- ì‚¬ìš©ì ì§ˆì˜: í•œêµ­ì–´(ì§§ì€ ì§ˆë¬¸/ì„¤ëª…í˜• ë¬¸ì¥)
- í•„í„°/ì œì•½: ì ‘ê·¼ ê°€ëŠ¥ ì»¨í…Œì´ë„ˆ, ë¬¸ì„œ íƒ€ì…, ë‚ ì§œ ë²”ìœ„ ë“±
- ëª¨ë“œ: hybrid | vector_only | keyword_only | multimodal (ì„ íƒ)

### 2.2 ì¶œë ¥

- ë­í‚¹ëœ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸(íŒŒì¼/ì²­í¬/ì„¸ê·¸ë¨¼íŠ¸ ê¸°ì¤€)ì™€ ê·¼ê±° ìŠ¤ë‹ˆí«
- QA ëª¨ë“œ ì‹œ: ê·¼ê±° ëª©ë¡ + ìƒì„± ë‹µë³€(ì¶œì²˜ ë§í¬ í¬í•¨)

### 2.3 ì˜¤ë¥˜/ì˜ˆì™¸

- ê¶Œí•œ ë¯¸í™•ì¸, ë¹ˆ ì¸ë±ìŠ¤, ê³¼ë„í•œ í† í°/ëŒ€ìš©ëŸ‰ ì§ˆì˜, ì„œë¹„ìŠ¤ íƒ€ì„ì•„ì›ƒ

## 3. ìƒìœ„ íŒŒì´í”„ë¼ì¸ê³¼ì˜ ì˜ì¡´ ê´€ê³„

### 3.1 ì²­í‚¹ í’ˆì§ˆ ì˜í–¥

- ì¢‹ì€ ì²­í‚¹: ì˜ë¯¸ ì¼ì¹˜/ì •í™•í•œ ìŠ¤ë‹ˆí« êµ¬ì„±ìœ¼ë¡œ ë¦¬íŠ¸ë¦¬ë²Œ ì •í™•ë„ í–¥ìƒ
- í—¤ë” ê²½ë¡œ/í˜ì´ì§€/ì„¹ì…˜ ì œëª© ë³´ì¡´ì´ ë ˆì´íŒ…Â·í•˜ì´ë¼ì´íŠ¸ í’ˆì§ˆì— ê¸°ì—¬

### 3.2 ìŠ¤í‚¤ë§ˆ/ì¸ë±ìŠ¤ ì˜ì¡´

- ë“€ì–¼ ì¸ë±ìŠ¤(5.1): í…ìŠ¤íŠ¸ ì²­í¬ ë²¡í„°(pgvector) vs í‚¤ì›Œë“œ/ì „ë¬¸(TSVECTOR)
- ë©€í‹°ëª¨ë‹¬(5.2): ì´ë¯¸ì§€/í‘œ/ë ˆì´ì•„ì›ƒ/ë¹„ë””ì˜¤ ì„¸ê·¸ë¨¼íŠ¸ ê²€ìƒ‰ ë° í•„í„°ë§ ê°€ëŠ¥

### 3.3 ìš´ì˜ ìƒíƒœ ì˜ì¡´

- íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨/ì§€ì—°ì€ ê²€ìƒ‰ ê³µë°±ìœ¼ë¡œ ì§ê²° â†’ ìƒíƒœ ëª¨ë‹ˆí„°ë§Â·ì¬ì‹œë„Â·ê²½ë³´ í•„ìš”

### 3.4 ì§ˆë¬¸ ì „ì²˜ë¦¬ ë° ê°œì„  (í†µí•© ì§ˆì˜ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸)

> **2025-10-17 ì—…ë°ì´íŠ¸**: í†µí•© ì§ˆì˜ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ êµ¬í˜„ ì™„ë£Œ  
>

#### 3.4.0 ì„¤ê³„ ëª©í‘œ

**ë¬¸ì œ ì •ì˜**:
- âŒ **ê¸°ì¡´**: ì¼ë°˜ ê²€ìƒ‰ê³¼ RAG ê²€ìƒ‰ë§ˆë‹¤ ë‹¤ë¥¸ ì§ˆì˜ ì²˜ë¦¬ ë¡œì§
- âŒ **ë¬¸ì œ**: ê°™ì€ ì§ˆì˜ì— ë‹¤ë¥¸ ë¶ˆìš©ì–´ ì œê±° â†’ ì¼ê´€ë˜ì§€ ì•Šì€ ê²€ìƒ‰ ê²°ê³¼
- âŒ **í•œê³„**: ìì—°ì–´ ì§ˆì˜ ("í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”") ì²˜ë¦¬ ë¶€ì¡±

**í•´ê²°ì±…**:
- âœ… **í†µí•© íŒŒì´í”„ë¼ì¸**: ëª¨ë“  ê²€ìƒ‰ ê²½ë¡œì—ì„œ ë™ì¼í•œ ì§ˆì˜ ì²˜ë¦¬
- âœ… **ì¼ê´€ëœ ë¶ˆìš©ì–´**: `UNIFIED_STOPWORDS` ì‚¬ìš©
- âœ… **ì˜ë„ ê¸°ë°˜ ì „ëµ**: ì§ˆì˜ ìœ í˜•ë³„ ìµœì í™”ëœ ê²€ìƒ‰ ê°€ì¤‘ì¹˜ ì ìš©

#### 3.4.1 í†µí•© íŒŒì´í”„ë¼ì¸ ì•„í‚¤í…ì²˜

```
ì‚¬ìš©ì ì§ˆì˜: "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”"
â”‚
â”œâ”€[Level 1] ì…ë ¥ ì •ê·œí™” (Input Normalization)
â”‚   â”œâ”€ ê³µë°±/íŠ¹ìˆ˜ë¬¸ì/ì´ëª¨ì§€ ì œê±°
â”‚   â”œâ”€ ì–¸ì–´ ê°ì§€ (í•œê¸€/ì˜ì–´/í˜¼ìš©)
â”‚   â””â”€ ì¶œë ¥: "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸°í•˜ë‚˜ìš”"
â”‚
â”œâ”€[Level 2] ì˜ë„ ë¶„ë¥˜ (Intent Classification)
â”‚   â”œâ”€ 1ì°¨: ê·œì¹™ ê¸°ë°˜ íŒ¨í„´ ë§¤ì¹­ (ë¹ ë¦„)
â”‚   â”œâ”€ 2ì°¨: LLM ê¸°ë°˜ ë¶„ë¥˜ (ì •ë°€, confidence < 0.7ì¸ ê²½ìš°)
â”‚   â”œâ”€ ì˜ë„ íƒ€ì…:
â”‚   â”‚   â€¢ keyword_search: "AWS Lambda"
â”‚   â”‚   â€¢ document_search: "í˜ì‹  ê´€ë ¨ ë¬¸ì„œ ì°¾ì•„ì¤˜"
â”‚   â”‚   â€¢ qa_question: "Lambda ë¹„ìš©ì€ ì–¼ë§ˆì¸ê°€ìš”?"
â”‚   â”‚   â€¢ summarization: "ì´ ë¬¸ì„œ ìš”ì•½í•´ì¤˜"
â”‚   â”‚   â€¢ comparison: "EKS vs ECS ë¹„êµ"
â”‚   â”‚   â€¢ presentation: "PPT ë§Œë“¤ì–´ì¤˜"
â”‚   â””â”€ ì¶œë ¥: intent="document_search", confidence=0.75
â”‚
â”œâ”€[Level 3] í† í°í™” & ë¶„ì ˆ (Tokenization & Segmentation)
â”‚   â”œâ”€ í˜•íƒœì†Œ ë¶„ì„ (KoreanNLPService.analyze_text_for_search)
â”‚   â”‚   â†’ ["í˜ì‹ ì—", "ëŒ€í•´", "ë­ë¼", "ì´ì•¼ê¸°", "í•˜ë‚˜ìš”"]
â”‚   â”œâ”€ ë¶ˆìš©ì–´ ì œê±° (UNIFIED_STOPWORDS)
â”‚   â”‚   â€¢ ì¡°ì‚¬: "ì„", "ë¥¼", "ì´", "ê°€", "ì€", "ëŠ”", "ì˜", "ì—", ...
â”‚   â”‚   â€¢ ì˜ë¬¸ì‚¬: "ë­", "ë­ë¼", "ë¬´ì—‡", "ì–´ë–¤", ...
â”‚   â”‚   â€¢ ë³´ì¡°ìš©ì–¸: "ëŒ€í•´", "í•˜ë‚˜ìš”", "ìˆë‚˜ìš”", ...
â”‚   â”‚   â†’ ì œê±°: "ëŒ€í•´", "ë­ë¼", "í•˜ë‚˜ìš”"
â”‚   â”‚   â†’ ê²°ê³¼: ["í˜ì‹ ", "ì´ì•¼ê¸°"]
â”‚   â””â”€ ê°œì²´ëª… ì¸ì‹ (NER): ë‚ ì§œ, ì¡°ì§, ì œí’ˆ, ë¬¸ì„œíƒ€ì…
â”‚
â”œâ”€[Level 4] ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„± (Query Generation)
â”‚   â”œâ”€ ë²¡í„° ê²€ìƒ‰: ì„ë² ë”© ìƒì„± ("í˜ì‹  ì´ì•¼ê¸°" â†’ [0.123, 0.456, ...])
â”‚   â”œâ”€ í‚¤ì›Œë“œ ê²€ìƒ‰: "%í˜ì‹ % OR %ì´ì•¼ê¸°%"
â”‚   â”œâ”€ ì „ë¬¸ê²€ìƒ‰: "í˜ì‹  | ì´ì•¼ê¸°" (tsquery)
â”‚   â””â”€ ê°€ì¤‘ì¹˜ ì„¤ì •: {vector: 0.5, keyword: 0.3, fulltext: 0.2}
â”‚
â””â”€[Level 5] ë©€í‹°ëª¨ë‹¬ í†µí•© (Multimodal Integration) [ì„ íƒ]
    â”œâ”€ ì´ë¯¸ì§€ ì„ë² ë”© (CLIP)
    â”œâ”€ í…ìŠ¤íŠ¸ + ì´ë¯¸ì§€ Fusion
    â””â”€ í¬ë¡œìŠ¤ëª¨ë‹¬ ê²€ìƒ‰
```

#### 3.4.2 í•µì‹¬ ë°ì´í„° êµ¬ì¡°

**ì…ë ¥ ëª¨ë¸** (`ProcessedQuery`):
```python
{
  "original_text": "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”",
  "normalized_text": "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸°í•˜ë‚˜ìš”",
  "language": "ko",  # "ko" | "en" | "mixed"
  "intent": "document_search",
  "intent_confidence": 0.75,
  "keywords": ["í˜ì‹ ì—", "ëŒ€í•´", "ë­ë¼", "ì´ì•¼ê¸°", "í•˜ë‚˜ìš”"],  # ì›ë³¸
  "filtered_keywords": ["í˜ì‹ ", "ì´ì•¼ê¸°"],  # ë¶ˆìš©ì–´ ì œê±° í›„
  "fulltext_query": "í˜ì‹  | ì´ì•¼ê¸°",  # PostgreSQL tsquery
  "keyword_query": "%í˜ì‹ % OR %ì´ì•¼ê¸°%",  # ILIKE ê²€ìƒ‰
  "vector_embedding": [0.123, 0.456, ...],  # 1536ì°¨ì›
  "weights": {"vector": 0.5, "keyword": 0.3, "fulltext": 0.2},
  "similarity_threshold": 0.4,
  "processing_time_ms": 52.3
}
```

**í†µí•© ë¶ˆìš©ì–´ ë¦¬ìŠ¤íŠ¸** (`UNIFIED_STOPWORDS`):
```python
UNIFIED_STOPWORDS = {
    # ì¡°ì‚¬ (Particles)
    "ì„", "ë¥¼", "ì´", "ê°€", "ì€", "ëŠ”", "ì˜", "ì—", "ì—ì„œ", ...,
    
    # ì˜ë¬¸ì‚¬ (Interrogatives)
    "ë­", "ë­ë¼", "ë­ë¼ê³ ", "ë¬´ì—‡", "ì–´ë–¤", "ì–´ë–»ê²Œ",
    
    # ë³´ì¡°ìš©ì–¸ (Auxiliary)
    "ëŒ€í•´", "ëŒ€í•œ", "ê´€í•´", "í•˜ë‚˜ìš”", "ìˆë‚˜ìš”", "ë©ë‹ˆê¹Œ",
    
    # ê²€ìƒ‰ ë™ì‚¬ (Search Verbs)
    "ì°¾ì•„ì¤˜", "ê²€ìƒ‰", "ì¡°íšŒ", "ë³´ì—¬ì¤˜", "ì•Œë ¤ì¤˜",
    
    # ê¸°íƒ€
    "ë“±", "ë°", "ë˜", "ê°™ì€", "ì²˜ëŸ¼"
}
```

#### 3.4.3 ì˜ë„ë³„ ê²€ìƒ‰ ì „ëµ

**ì¼ë°˜ ê²€ìƒ‰ ì „ëµ** (`INTENT_SEARCH_STRATEGIES`):

| ì˜ë„ íƒ€ì…           | ë²¡í„°  | í‚¤ì›Œë“œ | ì „ë¬¸ê²€ìƒ‰ | ì„ê³„ê°’  | ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤                |
| --------------- | --- | --- | ---- | ---- | ---------------------- |
| keyword_search  | 0.3 | 0.6 | 0.1  | 0.3  | "AWS Lambda" (ì •í™•í•œ í‚¤ì›Œë“œ) |
| document_search | 0.5 | 0.3 | 0.2  | 0.4  | "í˜ì‹  ê´€ë ¨ ë¬¸ì„œ" (ê· í˜•)        |
| qa_question     | 0.6 | 0.2 | 0.2  | 0.5  | "Lambda ë¹„ìš©?" (ì˜ë¯¸ ì¤‘ì‹¬)   |
| comparison      | 0.6 | 0.3 | 0.1  | 0.45 | "EKS vs ECS" (ë¹„êµ)      |
| summarization   | 0.5 | 0.3 | 0.2  | 0.4  | "ìš”ì•½í•´ì¤˜"                 |

**RAG ê²€ìƒ‰ ì „ëµ** (`RAG_SEARCH_STRATEGIES`):

| ì˜ë„ íƒ€ì…           | ë²¡í„°  | í‚¤ì›Œë“œ  | ì „ë¬¸ê²€ìƒ‰ | ì„ê³„ê°’  | ìµœëŒ€ ì²­í¬ |
| --------------- | --- | ---- | ---- | ---- | ----- |
| document_search | 0.6 | 0.2  | 0.2  | 0.42 | 10    |
| qa_question     | 0.7 | 0.15 | 0.15 | 0.45 | 10    |
| comparison      | 0.6 | 0.2  | 0.2  | 0.4  | 15    |

> **í•µì‹¬**: RAGëŠ” ì˜ë¯¸ ê²€ìƒ‰(vector) ë¹„ì¤‘ì´ ë†’ê³ , ì¼ë°˜ ê²€ìƒ‰ì€ í‚¤ì›Œë“œ ë¹„ì¤‘ì´ ë†’ìŒ

#### 3.4.4 ì²˜ë¦¬ í”„ë¡œì„¸ìŠ¤ ìƒì„¸

**Step 1: ì…ë ¥ ì •ê·œí™”**
```python
# ì…ë ¥
"í˜ì‹ ì—  ëŒ€í•´   ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”??? ğŸ˜Š"

# ì •ê·œí™” ì²˜ë¦¬

1. ê³µë°± ì •ë¦¬: "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”??? ğŸ˜Š"
2. ì´ëª¨ì§€ ì œê±°: "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”???"
3. íŠ¹ìˆ˜ë¬¸ì ì •ë¦¬: "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸° í•˜ë‚˜ìš”"
4. ì–¸ì–´ ê°ì§€: korean_chars=11, total=15 â†’ "ko"

# ì¶œë ¥

{
  "text": "í˜ì‹ ì— ëŒ€í•´ ë­ë¼ ì´ì•¼ê¸°í•˜ë‚˜ìš”",
  "language": "ko"
}
```

**Step 2: ì˜ë„ ë¶„ë¥˜ (ê·œì¹™ ê¸°ë°˜)**
```python
# íŒ¨í„´ ë§¤ì¹­
patterns = {
  "document_search": [
    r".*(ì°¾|ê²€ìƒ‰|ì¡°íšŒ).*",
    r".*(ê´€ë ¨|ëŒ€í•œ|ê´€í•œ).*ë¬¸ì„œ.*",  # âœ… ë§¤ì¹­!
    r".*ìë£Œ.*ë³´ì—¬.*"
  ],
  "qa_question": [
    r".*(ë¬´ì—‡|ë­|ì–´ë–»ê²Œ|ì™œ).*",
    r".*(ì¸ê°€ìš”|ì…ë‹ˆê¹Œ)$"
  ]
}
