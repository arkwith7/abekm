# 14. Text-to-SQL ì—ì´ì „íŠ¸ ì„¤ê³„ ë° êµ¬í˜„ í˜„í™© (Phase B)

**âœ… Phase B êµ¬í˜„ ì™„ë£Œ (2026-01-03)**

## ëª©ì 
ìì—°ì–´ ì§ˆì˜ë¥¼ **ì•ˆì „í•œ(Read-only) SQL**ë¡œ ë³€í™˜í•˜ê³ , DB ì¡°íšŒ ê²°ê³¼ë¥¼ ì‚¬ìš©ìì—ê²Œ ì œê³µí•œë‹¤.

- Supervisor(ë©€í‹° ì—ì´ì „íŠ¸) ì•„í‚¤í…ì²˜ì— **feature-pack**ìœ¼ë¡œ í†µí•©í•œë‹¤.
- ê¸°ë³¸ ë³´ì•ˆ ì›ì¹™: **SELECT-only + LIMIT ê°•ì œ + ìœ„í—˜ í‚¤ì›Œë“œ ì°¨ë‹¨**
- ìš´ì˜ í™˜ê²½ì—ì„œëŠ” DB ì—°ê²°ì„ read-only ê³„ì •/ê¶Œí•œìœ¼ë¡œ ê°•ì œí•˜ëŠ” ê²ƒì„ ì „ì œë¡œ í•œë‹¤.
- **ReAct íŒ¨í„´** ê¸°ë°˜ ë„êµ¬ í˜¸ì¶œë¡œ ìŠ¤í‚¤ë§ˆ íƒìƒ‰ â†’ SQL ìƒì„± â†’ ê²€ì¦ â†’ ì‹¤í–‰ ì‚¬ì´í´ êµ¬í˜„

## ë²”ìœ„ (Phase B êµ¬í˜„ ì™„ë£Œ)
- Worker ì´ë¦„: `TextToSQLAgent` âœ…
- ì‹¤í–‰ ëŒ€ìƒ DB: **ì•± DB ì„¸ì…˜(AsyncSession)** ê¸°ë°˜ ì‹¤í–‰ âœ…
- ìŠ¤í‚¤ë§ˆ ë©”íƒ€ë°ì´í„°/ì¿¼ë¦¬ ìºì‹œ: ë¡œì»¬ SQLite ì €ì¥ì†Œ ì‚¬ìš© âœ…
- Supervisor ë¼ìš°íŒ…:
  - LLM ë¼ìš°íŒ… íŒíŠ¸ ì¶”ê°€ âœ…
  - í…ŒìŠ¤íŠ¸/ìš´ì˜ì„ ìœ„í•œ **íˆ´ ê°•ì œ ì„ íƒ**(`tool=sql`) ì§€ì› âœ…
- **LangChain Tool ê¸°ë°˜ ì•„í‚¤í…ì²˜**: 6ê°œ ë„êµ¬ í´ë˜ìŠ¤ êµ¬í˜„ âœ…
- **ReAct íŒ¨í„´**: Reasoning â†’ Action â†’ Observation ì‚¬ì´í´ êµ¬í˜„ âœ…

## ìƒìœ„ ì•„í‚¤í…ì²˜ ì •í•©ì„±
- AgentCatalog discovery ê·œì¹™ì„ ë”°ë¥¸ë‹¤:
  - `app.agents.features.<feature>.worker` ì˜ `get_worker_specs()` ë§Œ ìë™ íƒìƒ‰
- ë”°ë¼ì„œ Text-to-SQLì€ ì•„ë˜ ìœ„ì¹˜ì— top-level feature-packìœ¼ë¡œ ì¶”ê°€í•œë‹¤:
  - `backend/app/agents/features/text_to_sql/worker.py`
  - `backend/app/agents/features/text_to_sql/graph.py`

## ì‹¤í–‰ í”Œë¡œìš° (ReAct Pattern)
1. **API ì§„ì…**: `/agent/chat`ì—ì„œ `tool=sql` ë˜ëŠ” LLM ë¼ìš°íŒ…ìœ¼ë¡œ TextToSQLAgent í˜¸ì¶œ
2. **Worker ë…¸ë“œ ì‹¤í–‰** (`text_to_sql_worker_node`):
   
   **ReAct ì‚¬ì´í´ (6ë‹¨ê³„):**
   
   - **Reasoning**: ì§ˆë¬¸ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ (í˜•íƒœì†Œ ë¶„ì„ ê¸°ë°˜)
   
   - **Action 1 - ìŠ¤í‚¤ë§ˆ ê²€ìƒ‰**: `SearchSchemaTool`ë¡œ ê´€ë ¨ í…Œì´ë¸” íƒìƒ‰
     - ğŸ“Š **Observation**: ë§¤ì¹­ëœ í…Œì´ë¸” ëª©ë¡ ë°˜í™˜
   
   - **Action 2 - ìƒì„¸ ìŠ¤í‚¤ë§ˆ ì¡°íšŒ**: `GetTableSchemaTool`ë¡œ í…Œì´ë¸”ë³„ ì»¬ëŸ¼ ì •ë³´ ìˆ˜ì§‘
     - ğŸ“Š **Observation**: ì»¬ëŸ¼ëª…, íƒ€ì…, ì œì•½ì¡°ê±´ ë°˜í™˜
   
   - **Action 3 - ìœ ì‚¬ ì¿¼ë¦¬ ê²€ìƒ‰**: `SearchSimilarQueriesTool`ë¡œ ìºì‹œëœ ìœ ì‚¬ ì§ˆë¬¸ í™•ì¸
     - ğŸ“Š **Observation**: ìºì‹œ hit/miss
   
   - **Action 4 - SQL ìƒì„±**: `GenerateSQLTool`ë¡œ LLM ê¸°ë°˜ SQL ìƒì„±
     - ìŠ¤í‚¤ë§ˆ ì»¨í…ìŠ¤íŠ¸ + ìœ ì‚¬ ì˜ˆì œ í¬í•¨
     - ğŸ“Š **Observation**: ìƒì„±ëœ SQL ì¿¼ë¦¬
   
   - **Action 5 - ë³´ì•ˆ ê²€ì¦**: `ValidateSQLTool`ë¡œ SQL Guard ì ìš©
     - SELECT ì „ìš© í™•ì¸, ê¸ˆì§€ í‚¤ì›Œë“œ ì°¨ë‹¨, LIMIT ê°•ì œ
     - ğŸ“Š **Observation**: ê²€ì¦ëœ SQL (ë˜ëŠ” ì˜¤ë¥˜)
   
   - **Action 6 - SQL ì‹¤í–‰**: `ExecuteSQLTool`ë¡œ DB ì¿¼ë¦¬ ì‹¤í–‰
     - 30ì´ˆ íƒ€ì„ì•„ì›ƒ, 100í–‰ ì œí•œ
     - ğŸ“Š **Observation**: ì‹¤í–‰ ê²°ê³¼ (í‘œ í˜•íƒœ)

3. **ê²°ê³¼ ë°˜í™˜**: ë§ˆí¬ë‹¤ìš´ í…Œì´ë¸” + ì‹¤í–‰ ì •ë³´
4. **ìºì‹±**: ì§ˆë¬¸ â†’ SQL ë§¤í•‘ì„ SQLiteì— ì €ì¥

## ì£¼ìš” ì»´í¬ë„ŒíŠ¸

### 1. Worker / Graph âœ…
- **Worker ë“±ë¡**: `backend/app/agents/features/text_to_sql/worker.py`
  - `get_worker_specs()` â†’ AgentCatalog ìë™ íƒìƒ‰
- **ì‹¤í–‰ ë…¸ë“œ**: `backend/app/agents/features/text_to_sql/graph.py`
  - `text_to_sql_worker_node()`: ReAct íŒ¨í„´ 6ë‹¨ê³„ ì‹¤í–‰
  - ë¡œê¹…: ê° Action/Observation ë‹¨ê³„ë³„ ìƒì„¸ ë¡œê·¸

### 2. LangChain Tools (6ê°œ) âœ…
ê²½ë¡œ: `backend/app/agents/features/text_to_sql/tools/`

| Tool í´ë˜ìŠ¤ | íŒŒì¼ | ì—­í•  |
|-----------|------|------|
| `SearchSchemaTool` | `search_schema_tool.py` | í‚¤ì›Œë“œë¡œ í…Œì´ë¸”/ì»¬ëŸ¼ ê²€ìƒ‰ (í•œê¸€ ë§¤í•‘ ì§€ì›) |
| `GetTableSchemaTool` | `get_table_schema_tool.py` | íŠ¹ì • í…Œì´ë¸” ìƒì„¸ ìŠ¤í‚¤ë§ˆ ì¡°íšŒ |
| `SearchSimilarQueriesTool` | `search_similar_queries_tool.py` | ìºì‹œëœ ìœ ì‚¬ ì§ˆë¬¸-SQL ê²€ìƒ‰ |
| `GenerateSQLTool` | `generate_sql_tool.py` | LLM ê¸°ë°˜ SQL ìƒì„± (ìŠ¤í‚¤ë§ˆ ì»¨í…ìŠ¤íŠ¸ í¬í•¨) |
| `ValidateSQLTool` | `validate_sql_tool.py` | SQL Guard ë³´ì•ˆ ê²€ì¦ |
| `ExecuteSQLTool` | `execute_sql_tool.py` | PostgreSQL ì¿¼ë¦¬ ì‹¤í–‰ (íƒ€ì„ì•„ì›ƒ/ì œí•œ) |

**Tool íŠ¹ì§•:**
- Pydantic BaseModel ê¸°ë°˜ ì…ë ¥ ìŠ¤í‚¤ë§ˆ
- ë¹„ë™ê¸° ì‹¤í–‰ (`_arun()`) + ë™ê¸° í˜¸í™˜ (`_run()`)
- ìƒì„¸í•œ ì„¤ëª…ê³¼ ì‚¬ìš© ê°€ì´ë“œ í¬í•¨

### 3. Services âœ…
ê²½ë¡œ: `backend/app/agents/features/text_to_sql/services/`

- **`schema_introspector.py`**: PostgreSQL `information_schema` ì¿¼ë¦¬
  - í…Œì´ë¸” ëª©ë¡, ì»¬ëŸ¼ ì •ë³´ ìˆ˜ì§‘
- **`sql_generator.py`**: LLM ê¸°ë°˜ SQL ìƒì„±
  - Bedrock Claude-3.5 Sonnet v2 ì‚¬ìš©
  - ìŠ¤í‚¤ë§ˆ ì»¨í…ìŠ¤íŠ¸ + í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿
- **`sql_guard.py`**: ë³´ì•ˆ ê²€ì¦ ë¡œì§
  - SELECT ì „ìš©, DML/DDL ì°¨ë‹¨, LIMIT ê°•ì œ
- **`sql_executor.py`**: AsyncSession ê¸°ë°˜ ì¿¼ë¦¬ ì‹¤í–‰
  - 30ì´ˆ íƒ€ì„ì•„ì›ƒ, 100í–‰ ì œí•œ

### 4. Prompt Templates âœ…
- PromptLoaderë¥¼ í†µí•´ feature-pack í”„ë¡¬í”„íŠ¸ ë¡œë”©
- ê²½ë¡œ: `backend/app/agents/features/text_to_sql/prompts/`
  - `sql_generator_system.prompt` âœ…
  - `sql_generator_user.prompt` âœ…

**í”„ë¡¬í”„íŠ¸ íŠ¹ì§•:**
- PostgreSQL ì „ìš© ë¬¸ë²• ê°€ì´ë“œ
- ìŠ¤í‚¤ë§ˆ ì»¨í…ìŠ¤íŠ¸ ìë™ ì‚½ì…
- Few-shot ì˜ˆì œ ì§€ì› (ìœ ì‚¬ ì¿¼ë¦¬ ìºì‹œ í™œìš©)

### 5. SQL Guard (ë³´ì•ˆ ê³„ì¸µ) âœ…
- íŒŒì¼: `backend/app/agents/features/text_to_sql/services/sql_guard.py`
- **ê²€ì¦ ì •ì±…**:
  - âœ… `SELECT`ë¡œ ì‹œì‘í•´ì•¼ í•¨
  - âœ… DML/DDL í‚¤ì›Œë“œ ì°¨ë‹¨: `INSERT`, `UPDATE`, `DELETE`, `DROP`, `ALTER`, `CREATE`, `TRUNCATE`
  - âœ… ë‹¤ì¤‘ statement ì°¨ë‹¨ (`;` ê²€ì‚¬)
  - âœ… SQL injection íŒ¨í„´ ì°¨ë‹¨ (ì£¼ì„, `EXEC`, `xp_` ë“±)
  - âœ… `LIMIT` ëˆ„ë½ ì‹œ ìë™ ì¶”ê°€ (ê¸°ë³¸ê°’: 100)
- **ì„¤ì • ê°€ëŠ¥**: `SqlGuardConfig` í´ë˜ìŠ¤ë¡œ ì œí•œê°’ ì¡°ì •

### 6. Local Store (SQLite) âœ…
- íŒŒì¼: `backend/app/agents/features/text_to_sql/storage/sqlite_store.py`
- ì €ì¥ì†Œ ìœ„ì¹˜: `backend/data/text_to_sql.db`

**í…Œì´ë¸” êµ¬ì¡°:**
```sql
-- ìŠ¤í‚¤ë§ˆ ë©”íƒ€ë°ì´í„°
CREATE TABLE schema_metadata (
    connection_id TEXT,
    schema_name TEXT,
    table_name TEXT,
    column_name TEXT,
    data_type TEXT,
    is_nullable TEXT,
    column_default TEXT,
    PRIMARY KEY (connection_id, schema_name, table_name, column_name)
);

-- ì¿¼ë¦¬ ìºì‹œ
CREATE TABLE query_sql_cache (
    connection_id TEXT,
    question_hash TEXT,
    question TEXT,
    sql_query TEXT,
    executed_at TIMESTAMP,
    PRIMARY KEY (connection_id, question_hash)
);

-- ì»¤ë„¥ì…˜ ì„¤ì • (í–¥í›„ í™•ì¥)
CREATE TABLE connection_configs (
    connection_id TEXT PRIMARY KEY,
    db_type TEXT,
    host TEXT,
    port INTEGER,
    database TEXT,
    config_json TEXT
);
```

## ìš´ì˜/ì„¤ì • ë©”ëª¨
- âœ… LLM ë¯¸ì„¤ì • í™˜ê²½ì—ì„œë„ import-time crashê°€ ë‚˜ì§€ ì•Šë„ë¡, LLMì€ **ëŸ°íƒ€ì„ì— lazy init**í•œë‹¤.
- âœ… í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ LLM í‚¤ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, TextToSQLAgentëŠ” "ì„¤ì •ë˜ì§€ ì•ŠìŒ" ë©”ì‹œì§€ë¡œ graceful degrade í•œë‹¤.
- âœ… **Bedrock LLM ì‚¬ìš©**: AWS Bedrock Claude-3.5 Sonnet v2 (apac.anthropic.claude-3-5-sonnet-20241022-v2:0)
- âœ… **í•œêµ­ì–´ ì§€ì›**: Kiwi í˜•íƒœì†Œ ë¶„ì„ê¸°ë¡œ ì§ˆë¬¸ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ
- âœ… **ë¡œê¹…**: ê° ReAct ë‹¨ê³„ë³„ ìƒì„¸ ë¡œê·¸ (`loguru` ê¸°ë°˜)

## ì‹¤ì œ ë™ì‘ ì˜ˆì‹œ

### ì˜ˆì œ 1: ê°„ë‹¨í•œ ì¡°íšŒ
**ì§ˆë¬¸**: "ì§€ì‹ ì»¨í…Œì´ë„ˆê°€ ëª‡ ê°œì•¼?"

**ReAct ì‹¤í–‰ ë¡œê·¸**:
```
ğŸ’­ Reasoning: Extracting keywords from question...
ğŸ’­ Extracted keyword: 'ì»¨í…Œì´ë„ˆ'

ğŸ” Action 1: Searching schema with keyword 'ì»¨í…Œì´ë„ˆ'...
ğŸ“Š Observation 1: í‚¤ì›Œë“œ 'ì»¨í…Œì´ë„ˆ'ì™€ ê´€ë ¨ëœ í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ğŸ“‹ Action 2: Getting detailed schema for 0 tables...
ğŸ“Š Observation 2: Schema context built with 0 tables

ğŸ” Action 3: Searching for similar past queries...
ğŸ“Š Observation 3: âš ï¸ ìœ ì‚¬í•œ ì§ˆë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.

ğŸ¤– Action 4: Generating SQL with LLM...
ğŸ“Š Observation 4: âœ… SQL ìƒì„± ì™„ë£Œ:
    SELECT count(*) as knowledge_container_count
    FROM public.knowledge_container

ğŸ” Action 5: Validating SQL safety...
ğŸ“Š Observation 5: âœ… SQL ê²€ì¦ ì„±ê³µ
    SELECT count(*) as knowledge_container_count 
    FROM public.knowledge_container LIMIT 100

âš¡ Action 6: Executing SQL...
ğŸ“Š Observation 6: Execution completed

âœ… ì‹¤í–‰ ê²°ê³¼:
| knowledge_container_count |
| --- |
| 13 |
```

### ì˜ˆì œ 2: ë³´ì•ˆ ì°¨ë‹¨
**ì§ˆë¬¸**: "ì‚¬ìš©ì í…Œì´ë¸”ì„ ì‚­ì œí•´ì¤˜"

**SQL Guard ë™ì‘**:
```
ğŸ” Action 5: Validating SQL safety...
âŒ SQL ê²€ì¦ ì‹¤íŒ¨: Forbidden keyword detected: DELETE
```

**ì°¨ë‹¨ëœ ìœ„í˜‘**:
- âœ… DELETE FROM tb_knowledge_containers
- âœ… DROP TABLE tb_knowledge_containers
- âœ… UPDATE tb_knowledge_containers SET container_name ...
- âœ… INSERT INTO tb_knowledge_containers VALUES (...)
- âœ… SELECT * FROM tb; DROP TABLE tb;
- âœ… EXEC sp_executesql 'SELECT 1'

## í–¥í›„ í™•ì¥ í¬ì¸íŠ¸ (Phase C ì´í›„)

### 1. ë‹¤ì¤‘ DB ì»¤ë„¥ì…˜ ì§€ì›
- í˜„ì¬: ì•± DB ì„¸ì…˜ë§Œ ì§€ì›
- í–¥í›„: `connection_configs` í…Œì´ë¸” í™œìš©í•˜ì—¬ ì™¸ë¶€ DB ì—°ê²°
- ì¸í„°í˜ì´ìŠ¤: `connection_id` íŒŒë¼ë¯¸í„°ë¡œ ëŒ€ìƒ DB ì„ íƒ

### 2. ì„ë² ë”© ê¸°ë°˜ ìœ ì‚¬ ì¿¼ë¦¬ ê²€ìƒ‰
- í˜„ì¬: ì •í™• ì¼ì¹˜ ìºì‹œë§Œ ì§€ì›
- í–¥í›„: ì§ˆë¬¸ ì„ë² ë”© â†’ ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰ìœ¼ë¡œ Few-shot ì˜ˆì œ ìë™ ë°œêµ´

### 3. ìŠ¤í‚¤ë§ˆ ìë™ ì—…ë°ì´íŠ¸
- í˜„ì¬: ìµœì´ˆ ì‹¤í–‰ ì‹œ í•œ ë²ˆë§Œ ìˆ˜ì§‘
- í–¥í›„: ì£¼ê¸°ì  ìŠ¤í‚¤ë§ˆ ë™ê¸°í™” ë˜ëŠ” ë³€ê²½ ê°ì§€

### 4. ë¹„ì¦ˆë‹ˆìŠ¤ ìš©ì–´ ì‚¬ì „
- í˜„ì¬: í˜•íƒœì†Œ ë¶„ì„ ê¸°ë°˜ í‚¤ì›Œë“œ ì¶”ì¶œ
- í–¥í›„: ë„ë©”ì¸ë³„ ìš©ì–´ â†’ í…Œì´ë¸”/ì»¬ëŸ¼ ë§¤í•‘ DB êµ¬ì¶•

### 5. SQL ì‹¤í–‰ ê³„íš ë¶„ì„
- í–¥í›„: EXPLAIN ë¶„ì„ìœ¼ë¡œ ë¹„íš¨ìœ¨ì  ì¿¼ë¦¬ ì‚¬ì „ ì°¨ë‹¨

## ì°¸ê³  ë¬¸ì„œ
- [10. Agentic Architecture](10.agentic_architecture.md) - Phase B ë¡œë“œë§µ
- [21.1. Agentic AI Roadmap](21.1.agentic_ai_roadmap.md) - ì „ì²´ ê°œë°œ ê³„íš

## í…ŒìŠ¤íŠ¸ í˜„í™© âœ…

### Functional Tests
- **íŒŒì¼**: `backend/tests/functional/test_text_to_sql_wiring.py`
- **ëª©ì **: API ë¼ìš°íŒ… ë° ê¸°ë³¸ wiring ê²€ì¦
- **ìƒíƒœ**: âœ… í†µê³¼

### Integration Tests (E2E)
- **íŒŒì¼**: `backend/tests/integration/test_text_to_sql_e2e.py`
- **ì‹¤í–‰ í™˜ê²½**: 
  - ì‹¤ì œ AWS Bedrock LLM (Claude-3.5 Sonnet v2)
  - ì‹¤ì œ PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ (13ê°œ í…Œì´ë¸”, 58ê°œ public ìŠ¤í‚¤ë§ˆ)
- **í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤** (6ê°œ, ëª¨ë‘ í†µê³¼ âœ…):

| í…ŒìŠ¤íŠ¸ | ê²€ì¦ ë‚´ìš© | ìƒíƒœ |
|-------|---------|------|
| `test_text_to_sql_full_e2e_with_real_llm_and_db` | ì „ì²´ í”Œë¡œìš° (ì§ˆë¬¸ â†’ SQL â†’ ì‹¤í–‰) | âœ… |
| `test_text_to_sql_schema_introspection` | ìŠ¤í‚¤ë§ˆ íƒìƒ‰ (58ê°œ í…Œì´ë¸”, 31ê°œ ì»¬ëŸ¼) | âœ… |
| `test_text_to_sql_sql_guard` | ë³´ì•ˆ ê²€ì¦ (6ê°€ì§€ ìœ„í˜‘ ì°¨ë‹¨) | âœ… |
| `test_text_to_sql_cache_mechanism` | ì¿¼ë¦¬ ìºì‹± ë™ì‘ í™•ì¸ | âœ… |
| `test_text_to_sql_via_api_endpoint` | AgentCatalog í†µí•© | âœ… |
| `test_text_to_sql_with_korean_business_terms` | í•œêµ­ì–´ í‚¤ì›Œë“œ ë§¤í•‘ | âœ… |

**í…ŒìŠ¤íŠ¸ ê²°ê³¼** (2026-01-03):
```
======================= 6 passed, 15 warnings in 16.51s ========================
```

**ì½”ë“œ ì»¤ë²„ë¦¬ì§€**:
- Text-to-SQL ëª¨ë“ˆ: **75-98%**
- í•µì‹¬ êµ¬í˜„: **100% ì»¤ë²„ë¦¬ì§€**
