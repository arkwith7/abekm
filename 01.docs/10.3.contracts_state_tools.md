# 10.3 Contracts (State·Evidence·Tool Contract·라우팅)

> 본 문서는 멀티에이전트 통합/확장을 위한 공용 계약(상태 스키마, 근거(Evidence), Tool contract, RAG/SQL 라우팅)을 정의합니다.

---

## 1. 공용 State 설계 원칙

- State는 “메시지 + 작업 컨텍스트 + 근거(증거) + 진행 상태”를 포함
- Reducer/merge 규칙이 명확해야 함(누적 리스트 vs overwrite)

권장 상태 필드(개념):
- `messages`: 대화 누적
- `query`: 현재 사용자 질의
- `evidence`: 근거/출처 목록(문서 chunk, 웹 결과, SQL 결과)
- `current_agent`, `completed_agents`: 진행 추적
- `artifacts`: 산출물(PPT 파일, 리포트 등)

---

## 2. Evidence(근거) 표준화

RAG와 Text-to-SQL 결과를 동일한 근거 타입으로 다룰 수 있어야, Deep Research/최종 응답 합성이 쉬워집니다.

권장: Evidence를 아래 3종으로 표준화
- `document_chunk`
- `web_result`
- `sql_result`

각 Evidence는 최소한 다음을 포함
- `source_type`
- `content/summary`
- `provenance`(doc_id/url/query/sql 등)
- `score/confidence`(가능한 경우)

---

## 3. Tool Contract(입출력/에러/근거)

- Tool은 입력/출력/에러가 명시돼야 함
- Tool 실행 결과는 가능하면 Evidence로 변환 가능해야 함

권장 규칙
- 입력은 명시적 파라미터(모호한 dict 남발 금지)
- 출력은 “사용 가능한 구조화 데이터 + 요약 텍스트”를 함께 제공
- 실패는 예외 숨김이 아니라, 호출자가 정책적으로 처리할 수 있도록 분류

---

## 4. RAG + Text-to-SQL 라우팅(semantic router)

쿼리 특성에 따라 다음 중 하나로 라우팅합니다.

- `rag`: 비정형(문서/특허/선행기술)
- `sql`: 정형(통계/수치/집계)
- `hybrid`: 두 소스 모두 필요

Text-to-SQL 안정화 구성요소(권장)
- Schema RAG(스키마 컨텍스트)
- Few-shot 예제
- SQL Guards(allowlist, DDL/DML 차단, WHERE/limit 검사)
- Read-only 우선

---

## 5. Adaptive RAG(선택)

문서 품질/적합도 평가 후
- 쿼리 재작성
- 외부 웹 검색
- 생성
등을 조건부로 분기하는 패턴을 적용할 수 있습니다.

---

## 6. 통합 체크리스트(Contract 관점)

- 새로운 에이전트는 “입력/출력/근거”가 10.3의 규약에 맞는다
- Wrapper(어댑터)를 만들면, 변환 규칙이 테스트로 고정된다
- 결과는 Evidence로 합성 가능하다
