# 프론트엔드 상태 캐시/복원 정책 (Policy v1)

> 목적: 좌측 메뉴(대시보드/지식 컨테이너/지식 검색/AI Agents/대화 이력/지식 컨테이너 탐색) 이동 시 **화면 상태를 즉시 복원**하고, 새로고침 시에는 **필요한 최소 상태만 복원**하여 저장 폭/리렌더/혼란을 줄인다.

## 정책의 기본 원칙

- **메뉴 이동(언마운트 → 리마운트)**: Zustand 메모리 캐시(`useGlobalAppStore`)로 **이전 화면을 즉시 복원**한다.
- **브라우저 새로고침/재접속**: Zustand persist는 **UI/선택 상태만 최소로 저장**한다.
  - 대용량 데이터(검색 결과/트리/목록)는 persist에서 **비움**(빈 배열)으로 저장하여 **저장 폭과 성능 리스크를 제거**한다.
- **“화면 그대로 복원” vs “항상 최신”의 구분**
  - 사용자 경험이 중요한 화면(검색 결과 스크롤/컨테이너 트리 확장/선택 문서)은 **메뉴 이동 동안 그대로 복원**
  - 데이터 정합성이 중요한 화면(대시보드 통계/최근 활동)은 **짧은 TTL 후 재조회**

## 저장 레이어 정의

- **In-memory cache (메뉴 이동 복원용)**: `useGlobalAppStore().pageStates`에 저장 (언마운트되어도 탭이 살아있는 동안 유지)
- **Persist (새로고침 복원용)**: `ABEKM-app-state` (Zustand persist)
  - `partialize()`로 저장 범위 제한
  - 대용량 필드 비움

## 메뉴별 기준표

| 메뉴 | 화면에서 유지해야 하는 UX 상태(메뉴 이동 시 그대로) | persist(새로고침 후 복원) | 항상/주기적으로 재조회(백엔드) | 비고 |
|---|---|---|---|---|
| **대시보드** | 위젯 접힘/펼침, 마지막 선택(있다면) | 기본값(필요 최소) | 최근 활동/문서 수/세션 수 등 요약 데이터 | 데이터는 TTL(예: 1~5분) 후 재조회 권장 |
| **지식 컨테이너(내 지식)** | 선택 컨테이너, 확장 트리, 페이지/정렬/필터, 로컬 목록 캐시(컨테이너/문서) | 선택 컨테이너/확장/페이지/정렬/필터/선택문서 | 컨테이너/문서 목록(새로고침 시) | 메뉴 이동: 즉시 복원 / 새로고침: 최신 재조회 |
| **지식 검색** | 쿼리/필터/페이지/뷰모드, 결과 리스트(메뉴 이동 동안), 선택 결과/선택 문서 | 쿼리/필터/페이지/뷰모드/선택값(결과는 비움) | 검색 결과(새로고침 시) | “메뉴 이동=복원”, “새로고침=재검색 또는 빈 결과” |
| **AI Agents(Agent Chat)** | 선택 문서, 세션 ID(있다면), 입력 UI 상태 | 선택 문서/세션 id 정도 | 세션 복원(필요 시) | `useAgentChat`은 별도의 localStorage 백업을 사용(정책 하단 참고) |
| **대화 이력** | 목록/커서/hasMore/스크롤 위치, (메뉴 이동 동안) 목록 캐시 | 커서/hasMore/스크롤/마지막 로드 시각(목록은 비움) | 목록(새로고침 시) | 목록은 커질 수 있어 persist에 저장하지 않음 |
| **지식 컨테이너 탐색(Explorer)** | 트리/확장/선택 노드/문서 목록 캐시(메뉴 이동 동안) | 확장/선택 노드/마지막 로드 시각(트리/문서 비움) | 트리/문서(새로고침 시) | 트리/문서가 커질 수 있어 persist에는 저장하지 않음 |

## 구현 반영(현재 코드와의 매핑)

- **Zustand 스토어 + persist(부분 저장)**: `frontend/src/store/globalAppStore.ts`
  - persist key: `ABEKM-app-state`
  - 대용량 비움 정책: `partialize()`에서 `search.results`, `containerExplorer.tree/documents`, `chatHistory.sessions` 등을 빈 배열로 저장
- **기존 Context API 유지(호환)**: `frontend/src/contexts/GlobalAppContext.tsx`
  - Provider는 no-op wrapper
  - `useGlobalApp()`가 Zustand를 직접 구독
  - `restorePageState()`의 stale 반환 문제를 제거
- **Search(메뉴 이동 즉시 복원)**: `frontend/src/pages/user/search/hooks/useSearch.ts`
  - 결과를 `pageStates.search.results`로 메모리 캐시
  - persist에서는 결과를 비움
- **MyKnowledge(메뉴 이동 즉시 복원)**: `frontend/src/pages/user/my-knowledge/hooks/useMyKnowledge.ts`
  - 컨테이너/문서 목록을 메모리 캐시
  - persist에서는 목록을 비움

## AI Agents(Agent Chat) 전용 보존 정책(추가)

현재 `useAgentChat`은 아래 키로 별도 백업/복원을 수행한다:

- `ABEKM_agent_chat_state` (페이지 재방문/새로고침 대비)
- `agent_session_{sessionId}` (세션 단위 백업)

권장 정책:

- **메뉴 이동**: Zustand 메모리 캐시를 우선(즉시 복원)
- **새로고침**: 위 localStorage 백업을 사용하되,
  - 세션 TTL(예: 6~24시간)과 백업 크기 제한(메시지 수/첨부 메타데이터 제한)을 명확히 유지
  - 장기적으로는 `ABEKM-app-state`와 중복 저장을 피하도록 정리(선택)

## 운영 체크리스트(권장)

- **저장 폭 모니터링**: localStorage의 `ABEKM-app-state` 크기가 커지지 않는지 주기 점검
- **TTL 통일**: “대시보드/이력”은 TTL 기반 재조회, “검색/탐색”은 메뉴 이동 동안 즉시 복원
- **대용량 필드 금지**: persist에 `results/tree/sessions/documents(목록)` 같은 대형 배열 저장 금지


