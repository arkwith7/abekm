# 10. 멀티 에이전트 아키텍처 (Agentic Architecture)

> 본 문서는 ABEKM 플랫폼의 **AI Agent 시스템** 아키텍처를 정의합니다.
> 사용자 유즈케이스, 에이전트 구조, 도구(Tool) 정의, 의존 관계를 포함합니다.

---

## 1. 시스템 개요 (System Overview)

### 1.1 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Frontend (React/TypeScript)                     │
│  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────────┐  │
│  │   AgentChatPage     │  │ PresentationAgent   │  │   useAgentChat      │  │
│  │   (일반 검색 UI)      │  │   ChatPage (PPT)    │  │   (SSE Hook)        │  │
│  └──────────┬──────────┘  └──────────┬──────────┘  └──────────┬──────────┘  │
└─────────────┼────────────────────────┼────────────────────────┼─────────────┘
              │                        │                        │
              └────────────────────────┼────────────────────────┘
                                       │ SSE Stream
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Backend API (FastAPI)                                │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                    /api/v1/agent/chat/stream                        │    │
│  │  • SSE 스트리밍 응답                                                  │    │
│  │  • answer_source 분류 (internet/mixed/database/attached/general)    │    │
│  └──────────────────────────────────┬──────────────────────────────────┘    │
└─────────────────────────────────────┼───────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Supervisor Agent (LangGraph)                          │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                      supervisor_agent.py                             │    │
│  │  • LLM 기반 라우팅 (GPT-4o / Claude)                                   │    │
│  │  • 작업 완료 판단 (FINISH)                                             │    │
│  └──────────────────────────────────┬──────────────────────────────────┘    │
│                    ┌────────────────┴────────────────┐                       │
│                    ▼                                 ▼                       │
│  ┌─────────────────────────────┐    ┌─────────────────────────────┐         │
│  │     SearchAgent Node        │    │  PresentationAgent Node     │         │
│  │  (paper_search_agent.py)    │    │  (presentation_agent.py)    │         │
│  └──────────────┬──────────────┘    └──────────────┬──────────────┘         │
└─────────────────┼───────────────────────────────────┼───────────────────────┘
                  │                                   │
                  ▼                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Tools Layer                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ Retrieval Tools                    │ Processing Tools               │    │
│  │ • vector_search (시맨틱 검색)        │ • deduplicate (중복 제거)       │    │
│  │ • keyword_search (키워드 매칭)       │ • rerank (재순위화)             │    │
│  │ • fulltext_search (전문 검색)       │ • context_builder (컨텍스트)    │    │
│  │ • internet_search (웹 검색)         │                                │    │
│  │ • multimodal_search (이미지 검색)   │                                │    │
│  ├─────────────────────────────────────┼────────────────────────────────┤    │
│  │ Vision Tools                        │ Presentation Tools             │    │
│  │ • image_analysis (이미지 분석)      │ • generate_outline (목차 생성)  │    │
│  │                                     │ • create_slides (슬라이드 생성) │    │
│  └─────────────────────────────────────┴────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           External Services                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  PostgreSQL  │  │   pgvector   │  │ Azure Blob   │  │  LLM APIs    │     │
│  │  (메타데이터) │  │  (벡터 DB)    │  │  (파일 저장)  │  │  (Claude/    │     │
│  │              │  │              │  │              │  │   GPT-4o)    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                       │
│  │  Tavily API  │  │  Bing API    │  │  DuckDuckGo  │                       │
│  │  (웹 검색)    │  │  (웹 검색)    │  │  (웹 검색)    │                       │
│  └──────────────┘  └──────────────┘  └──────────────┘                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 핵심 철학
- **자율성 (Autonomy)**: 각 에이전트는 자신의 목표 달성을 위해 스스로 도구 사용과 실행 순서를 결정합니다.
- **협업 (Collaboration)**: 에이전트 간의 명확한 역할 분담과 Supervisor를 통한 조율로 복합 작업을 수행합니다.
- **확장성 (Extensibility)**: 새로운 전문 에이전트를 쉽게 추가할 수 있는 구조입니다.

---

## 2. 사용자 유즈케이스 (User Use Cases)

### 2.1 주요 사용 시나리오

| 유즈케이스 | 설명 | 주요 에이전트 | 사용 도구 |
|-----------|------|-------------|----------|
| **논문/문서 검색** | 사용자가 특정 주제나 키워드로 논문 검색 | SearchAgent | vector_search, keyword_search, fulltext_search |
| **최신 정보 검색** | 웹에서 최신 뉴스, 트렌드 정보 검색 | SearchAgent | internet_search (Tavily/Bing/DDG) |
| **이미지 기반 검색** | 이미지를 업로드하여 유사 문서/이미지 검색 | SearchAgent | multimodal_search, image_analysis |
| **PPT 생성** | 검색 결과 또는 주제 기반으로 프레젠테이션 생성 | PresentationAgent | generate_outline, create_slides |
| **복합 작업** | "최신 AI 트렌드 검색해서 PPT 만들어줘" | Supervisor → SearchAgent → PresentationAgent | 전체 도구 활용 |
| **일반 대화** | 인사, 간단한 질문 등 도구 불필요한 대화 | (Direct LLM) | - |

### 2.2 유즈케이스 흐름도

```
사용자 요청 입력
       │
       ▼
┌──────────────────┐
│  의도 분류 (LLM)  │
└────────┬─────────┘
         │
    ┌────┴────┬────────────┬─────────────┬──────────────┐
    ▼         ▼            ▼             ▼              ▼
 FACTUAL   KEYWORD    EXPLORATORY   WEB_SEARCH    PPT_GENERATION
   QA      SEARCH                                 
    │         │            │             │              │
    ▼         ▼            ▼             ▼              ▼
┌───────────────────────────────────┐  ┌──────────────────┐
│         SearchAgent               │  │PresentationAgent │
│  전략 선택 → 도구 실행 → 결과 통합  │  │  목차→슬라이드    │
└───────────────────────────────────┘  └──────────────────┘
         │                                     │
         └─────────────────┬───────────────────┘
                           ▼
                    ┌──────────────┐
                    │ 답변 생성/반환 │
                    └──────────────┘
```

---

## 3. 에이전트 상세 (Agent Details)

### 3.1 Supervisor Agent (오케스트레이터)

**파일 위치**: `backend/app/agents/supervisor_agent.py`

**역할**: 사용자 요청을 분석하고 적절한 Worker Agent에게 작업을 위임하는 중앙 조율자

**LangGraph 워크플로우**:
```
                    ┌─────────────┐
                    │   START     │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
             ┌──────│ supervisor  │──────┐
             │      └─────────────┘      │
             │                           │
             ▼                           ▼
      ┌─────────────┐            ┌─────────────┐
      │ SearchAgent │            │Presentation │
      │    Node     │            │  Agent Node │
      └──────┬──────┘            └──────┬──────┘
             │                          │
             └──────────┬───────────────┘
                        │
                        ▼
                 ┌─────────────┐
                 │   FINISH    │
                 └─────────────┘
```

**라우팅 로직**:
- 검색/정보 요청 → `SearchAgent`
- PPT/프레젠테이션 요청 → `PresentationAgent`
- 작업 완료 → `FINISH`

**System Prompt 핵심**:
```
당신은 작업을 조율하는 감독관입니다. 
사용자의 요청을 분석하여 다음 에이전트 중 하나를 선택하거나, 
작업이 완료되면 FINISH를 반환하세요.

선택 가능: SearchAgent, PresentationAgent, FINISH
```

---

### 3.2 Search Agent (검색 전문가)

**파일 위치**: `backend/app/agents/paper_search_agent.py`

**역할**: 정보 검색 및 컨텍스트 수집 전문 에이전트

**핵심 기능**:

| 기능 | 설명 |
|------|------|
| **의도 분류** | 사용자 쿼리를 8가지 의도 유형으로 분류 |
| **전략 선택** | 의도에 맞는 최적 검색 전략 선택 |
| **쿼리 재작성** | 검색 효율을 위한 쿼리 최적화 |
| **도구 실행** | 선택된 도구들을 순차/병렬 실행 |
| **결과 통합** | 중복 제거, 재순위화, 답변 생성 |

**의도 유형 (AgentIntent)**:

| Intent | 설명 | 전략 |
|--------|------|------|
| `FACTUAL_QA` | 사실 기반 질문 답변 | vector_search → rerank |
| `KEYWORD_SEARCH` | 키워드 매칭 검색 | keyword_search + fulltext_search |
| `EXPLORATORY` | 탐색적 검색 | vector_search + keyword_search (병렬) |
| `WEB_SEARCH` | 웹 검색 필요 | internet_search |
| `MULTIMODAL` | 이미지 관련 검색 | multimodal_search |
| `ANALYSIS` | 분석/비교 요청 | 다중 검색 + context_builder |
| `GENERAL` | 일반 대화 | 도구 사용 없이 LLM 직접 응답 |
| `PPT_GENERATION` | PPT 생성 | Supervisor에 위임 |

**실행 흐름**:
```python
async def execute(self, query: str, ...):
    # 1. 의도 분류
    intent = await self.classify_intent(query)
    
    # 2. 쿼리 재작성
    rewritten = await self.rewrite_query(query, intent)
    
    # 3. 전략 선택 및 도구 실행
    strategy = self.select_strategy(intent)
    results = await self.execute_tools(strategy, rewritten)
    
    # 4. 후처리 (중복제거, 재순위화)
    processed = await self.deduplicate(results)
    ranked = await self.rerank(processed, query)
    
    # 5. 답변 생성
    answer = await self.generate_answer(query, ranked)
    return AgentResult(answer=answer, chunks=ranked)
```

---

### 3.3 Presentation Agent (프레젠테이션 전문가)

**파일 위치**: `backend/app/agents/presentation_agent.py`

**역할**: PPT/프레젠테이션 생성 전문 에이전트

**워크플로우**:
```
┌─────────────┐
│   START     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│   analyze   │ ← 요청 분석 및 기존 데이터 확인
└──────┬──────┘
       │
       ▼
┌─────────────────┐
│ generate_outline│ ← 목차/구조 생성
└───────┬─────────┘
        │
        ▼
┌─────────────────┐
│  create_slides  │ ← 슬라이드 내용 생성
└───────┬─────────┘
        │
        ▼
┌─────────────────┐
│      END        │
└─────────────────┘
```

**판단 로직**:
- 검색 결과가 있으면 해당 내용 기반으로 PPT 생성
- 검색 결과 없으면 Supervisor에게 검색 요청 반환
- 목차가 있으면 바로 슬라이드 생성으로 진행

---

## 4. 도구 상세 (Tool Details)

### 4.1 도구 목록

| 분류 | 도구명 | 설명 | 입력 | 출력 |
|------|--------|------|------|------|
| **Retrieval** | `vector_search` | 시맨틱 유사도 기반 벡터 검색 | query, top_k, container_ids | List[SearchChunk] |
| | `keyword_search` | 정확한 키워드 매칭 검색 | query, filters | List[SearchChunk] |
| | `fulltext_search` | PostgreSQL 전문 검색 | query, language | List[SearchChunk] |
| | `internet_search` | 웹 검색 (Tavily/Bing/DDG) | query, num_results | List[WebResult] |
| | `multimodal_search` | CLIP 기반 이미지-텍스트 검색 | query/image, top_k | List[ImageChunk] |
| **Processing** | `deduplicate` | 유사 청크 중복 제거 | chunks, threshold | List[SearchChunk] |
| | `rerank` | Cross-encoder 재순위화 | query, chunks | List[SearchChunk] |
| | `context_builder` | 검색 결과를 답변용 컨텍스트로 구성 | chunks, max_tokens | str |
| **Vision** | `image_analysis` | GPT-4o Vision 이미지 분석 | image_url, question | str |
| **Presentation** | `generate_outline` | PPT 목차 생성 | topic, context | Outline |
| | `create_slides` | 슬라이드 내용 생성 | outline, context | List[Slide] |

### 4.2 도구 의존 관계

```
internet_search ────────────────────────────────────────────┐
                                                            │
vector_search ──┬──→ deduplicate ──→ rerank ──→ context_builder ──→ LLM 답변 생성
keyword_search ─┤                                           │
fulltext_search ┘                                           │
                                                            │
multimodal_search ──→ image_analysis (선택적) ──────────────┘
                                                            │
                         검색 결과 컨텍스트 ◄───────────────┘
                                │
                                ▼
                     ┌──────────────────┐
                     │ generate_outline │
                     └────────┬─────────┘
                              │
                              ▼
                     ┌──────────────────┐
                     │  create_slides   │
                     └──────────────────┘
```

### 4.3 Internet Search 도구 상세

**지원 프로바이더** (우선순위 순):
1. **Tavily API** - 가장 안정적, API 키 필요
2. **Bing Search API** - Azure 구독 필요
3. **DuckDuckGo** - 무료, Rate Limit 있음

**Fallback 로직**:
```python
async def internet_search(query: str) -> List[WebResult]:
    providers = [tavily_search, bing_search, duckduckgo_search]
    
    for provider in providers:
        try:
            return await provider(query)
        except RateLimitError:
            continue
        except APIError:
            continue
    
    return []  # 모든 프로바이더 실패 시
```

---

## 5. API 엔드포인트 (API Endpoints)

### 5.1 에이전트 채팅 스트리밍

**엔드포인트**: `POST /api/v1/agent/chat/stream`

**요청**:
```json
{
  "message": "string",
  "session_id": "uuid (optional)",
  "container_ids": ["uuid"],
  "attached_documents": ["uuid"],
  "tool": "search | presentation | null"
}
```

**SSE 응답 이벤트**:

| 이벤트 | 설명 |
|--------|------|
| `content` | 스트리밍 텍스트 청크 |
| `thinking` | 에이전트 사고 과정 |
| `tool_start` | 도구 실행 시작 |
| `tool_result` | 도구 실행 결과 |
| `sources` | 참조 소스 정보 |
| `done` | 응답 완료 (answer_source 포함) |
| `error` | 오류 발생 |

**answer_source 값**:
- `internet_search`: 웹 검색만 사용
- `mixed_search`: 웹 + DB 검색 혼합
- `database_search`: DB 검색만 사용
- `attached_documents`: 첨부 문서 기반
- `general`: 도구 사용 없음

---

## 6. 데이터 흐름 (Data Flow)

### 6.1 일반 검색 요청 흐름

```
1. 사용자: "Attention 메커니즘에 대해 설명해주세요"
   │
   ▼
2. API 수신 → 의도 분류: FACTUAL_QA
   │
   ▼
3. SearchAgent 실행
   ├── vector_search("Attention mechanism", top_k=20)
   ├── 결과: 25개 청크
   ├── deduplicate(threshold=0.85) → 18개
   ├── rerank(query, chunks) → 10개 (상위)
   └── context_builder(chunks, max_tokens=4000)
   │
   ▼
4. LLM 답변 생성 (스트리밍)
   │
   ▼
5. 응답 완료
   └── answer_source: "database_search"
```

### 6.2 웹 검색 요청 흐름

```
1. 사용자: "2024년 AI 트렌드 알려줘"
   │
   ▼
2. API 수신 → 의도 분류: WEB_SEARCH
   │
   ▼
3. SearchAgent 실행
   ├── internet_search("2024 AI trends", providers=[tavily, bing, ddg])
   │   ├── Tavily 시도 → 성공
   │   └── 결과: 5개 웹 페이지
   └── context_builder(web_results)
   │
   ▼
4. LLM 답변 생성 (스트리밍)
   │
   ▼
5. 응답 완료
   └── answer_source: "internet_search"
```

### 6.3 복합 요청 흐름 (검색 → PPT)

```
1. 사용자: "트랜스포머 아키텍처 검색해서 PPT 만들어줘"
   │
   ▼
2. Supervisor 분석 → SearchAgent 호출
   │
   ▼
3. SearchAgent 실행
   ├── vector_search("Transformer architecture")
   ├── internet_search("Transformer architecture 2024")
   └── 결과 통합: 15개 관련 문서
   │
   ▼
4. Supervisor → PresentationAgent 호출
   │
   ▼
5. PresentationAgent 실행
   ├── generate_outline(topic, search_context)
   │   └── 목차: 소개, 구조, Self-Attention, 응용, 결론
   └── create_slides(outline, context)
       └── 각 슬라이드 내용 생성
   │
   ▼
6. PPT 파일 생성 및 반환
   └── answer_source: "mixed_search"
```

---

## 7. 핵심 코드 참조 (Code Reference)

### 7.1 주요 파일 목록

| 경로 | 설명 | LOC |
|------|------|-----|
| `backend/app/api/v1/agent.py` | API 엔드포인트, SSE 스트리밍 | ~1,180 |
| `backend/app/agents/paper_search_agent.py` | SearchAgent 구현 | ~860 |
| `backend/app/agents/supervisor_agent.py` | Supervisor 구현 | ~300 |
| `backend/app/agents/presentation_agent.py` | PresentationAgent 구현 | ~250 |
| `backend/app/tools/contracts.py` | 공통 타입 정의 | ~150 |
| `frontend/src/pages/user/AgentChatPage.tsx` | 채팅 UI | ~400 |
| `frontend/src/hooks/useAgentChat.ts` | SSE 훅 | ~250 |

### 7.2 핵심 타입 정의

```python
# backend/app/tools/contracts.py

class AgentIntent(str, Enum):
    FACTUAL_QA = "factual_qa"
    KEYWORD_SEARCH = "keyword_search"
    EXPLORATORY = "exploratory"
    WEB_SEARCH = "web_search"
    MULTIMODAL = "multimodal"
    ANALYSIS = "analysis"
    GENERAL = "general"
    PPT_GENERATION = "ppt_generation"

@dataclass
class SearchChunk:
    id: str
    content: str
    score: float
    metadata: Dict[str, Any]
    source_type: str  # "database" | "web" | "image"

@dataclass
class AgentResult:
    answer: str
    chunks: List[SearchChunk]
    answer_source: str
    tool_calls: List[ToolCall]
```

---

## 8. 설정 및 환경 변수 (Configuration)

### 8.1 필수 환경 변수

```bash
# LLM 설정
OPENAI_API_KEY=sk-...
AZURE_OPENAI_API_KEY=...
AZURE_OPENAI_ENDPOINT=https://...
AWS_BEDROCK_REGION=us-east-1

# 검색 설정
TAVILY_API_KEY=tvly-...
BING_SEARCH_API_KEY=...

# 벡터 DB
DATABASE_URL=postgresql://...
PGVECTOR_DIMENSION=1536

# 파일 저장
AZURE_STORAGE_CONNECTION_STRING=...
```

### 8.2 에이전트 설정

```python
# backend/app/core/config.py

class AgentSettings:
    # 검색 설정
    VECTOR_SEARCH_TOP_K: int = 20
    RERANK_TOP_K: int = 10
    CONTEXT_MAX_TOKENS: int = 4000
    
    # 중복 제거
    DEDUP_SIMILARITY_THRESHOLD: float = 0.85
    
    # 웹 검색
    WEB_SEARCH_NUM_RESULTS: int = 5
    WEB_SEARCH_TIMEOUT: int = 10
    
    # LLM
    DEFAULT_LLM_MODEL: str = "gpt-4o"
    STREAMING_ENABLED: bool = True
```

---

## 9. 변경 이력 (Change Log)

| 날짜 | 내용 | 작성자 |
|:-----|:-----|:------|
| 2025-11-26 | 문서 생성 및 초기 아키텍처 수립 | GitHub Copilot |
| 2025-11-27 | 구현 완료 후 아키텍처 명세서로 업데이트 | GitHub Copilot |

---

*본 문서는 ABEKM 플랫폼의 AI Agent 시스템 구현을 기준으로 작성되었습니다.*
