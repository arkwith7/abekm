# 특허 분석 에이전트 고도화 설계서 (Patent Analysis Agent Refactoring Design)

## 1. 개요
본 문서는 기존의 단일 도구(`PatentSearchTool`) 기반 특허 분석 시스템을 **Layered Tool Architecture**로 재설계하여, 에이전트가 사용자의 의도(검색, 상세 분석, 권리 분석 등)에 맞춰 최적의 도구를 선택하고 정밀한 데이터를 수집할 수 있도록 하는 것을 목적으로 한다.

## 2. 아키텍처 설계 (Layered Architecture)

시스템은 다음 3계층으로 구성된다.

### Layer 1: Provider Adapter (저수준 API 클라이언트)
각 데이터 제공자(KIPRIS, SerpAPI 등)의 API 명세와 1:1로 매핑되는 저수준 클라이언트 모듈.

*   **KIPRIS Client (`backend/app/clients/kipris.py`)**
    *   `search_patents`: 특허/실용신안 검색 (Advanced Search)
    *   `get_bibliography`: 서지 정보 조회 (요약, 대표도면 등)
    *   `get_full_text`: 전문(Full Text) 조회 (청구항, 상세설명)
    *   `get_legal_status`: 행정/법적 상태 조회 (등록, 거절, 소멸, 심사이력)
    *   `get_images`: 도면 이미지 조회
*   **Google Patents Client (`backend/app/clients/google_patents.py`)**
    *   `search`: 글로벌 특허 검색
    *   `get_details`: 상세 정보 및 인용 관계

### Layer 2: Functional Tools (기능별 도구)
에이전트가 사용하는 실제 도구(Tool). 사용자의 "의도" 단위로 기능을 추상화한다.

1.  **PatentDiscoveryTool (특허 탐색 도구)**
    *   **목적**: 광범위한 탐색, 리스트 확보.
    *   **기능**: 키워드/출원인/IPC 기반 검색. 가벼운 서지 정보(번호, 제목, 출원인, 날짜, 상태)만 반환.
    *   **Use Case**: "삼성전자의 AI 특허 찾아줘", "최근 3년 반도체 특허 리스트 뽑아줘"

2.  **PatentDetailTool (특허 상세 분석 도구)**
    *   **목적**: 특정 특허의 기술적 내용 심층 분석.
    *   **기능**: 특허 번호를 입력받아 **청구항(Claims)**, **상세설명**, **도면** 등 무거운 데이터를 로딩.
    *   **Use Case**: "이 특허의 핵심 기술이 뭐야?", "청구항 1항 분석해줘"

3.  **PatentLegalTool (권리/행정 분석 도구)**
    *   **목적**: 특허의 법적 유효성 및 권리 상태 확인.
    *   **기능**: 현재 권리 상태(등록/포기/소멸), 존속 기간, 심사 진행 이력, 등록료 납부 현황 확인.
    *   **Use Case**: "이 특허 아직 유효해?", "등록된 특허야 거절된 특허야?"

4.  **PatentCitationTool (인용 분석 도구)** (Optional/Future)
    *   **목적**: 기술의 영향력 및 원천 기술 추적.
    *   **기능**: 인용(Forward)/피인용(Backward) 관계 분석.

### Layer 3: Agent Strategy (에이전트 운용 전략)
에이전트는 사용자의 요청을 분석하여 위 도구들을 순차적 또는 병렬적으로 호출한다.

*   **Scenario A: 기술 동향 조사**
    *   User: "현대차의 수소전지 최근 동향 알려줘"
    *   Agent: `PatentDiscoveryTool` 호출 → 리스트 확보 → 연도별/IPC별 통계 분석 → 요약 보고.
*   **Scenario B: 특정 기술 심층 분석**
    *   User: "공개번호 10-2024-0000000 특허 분석해줘"
    *   Agent: `PatentDetailTool` 호출 → 청구항/요약 확보 → LLM 기술 분석 수행.
*   **Scenario C: FTO(자유실시) 기초 조사**
    *   User: "이 기술 우리가 써도 되는지 확인해줘"
    *   Agent: `PatentDiscoveryTool`로 유사 특허 검색 → `PatentLegalTool`로 유효성(소멸 여부) 확인.

## 3. 데이터 모델 설계

### 3.1. PatentBasicInfo (Discovery 결과)
*   `patent_number`: 출원/등록 번호
*   `title`: 발명의 명칭
*   `applicant`: 출원인
*   `application_date`: 출원일
*   `status`: 요약 상태 (등록/공개/거절 등)
*   `ipc_codes`: 대표 IPC

### 3.2. PatentFullText (Detail 결과)
*   `claims`: 청구항 리스트
*   `description`: 상세 설명
*   `abstract`: 초록
*   `inventors`: 발명자 전체
*   `drawings`: 도면 URL 리스트

### 3.3. PatentLegalStatus (Legal 결과)
*   `current_status`: 현재 법적 상태 (등록, 포기, 소멸, 거절)
*   `registration_date`: 등록일
*   `expiration_date`: 예상 만료일
*   `history`: 심사 이력 (출원서 제출 -> 의견제출통지 -> 등록결정 등)

## 4. 구현 로드맵

1.  **Phase 1: Client Refactoring**
    *   `backend/app/clients/kipris.py` 작성
    *   KIPRIS API Key 관리 및 세션 처리 최적화
    *   각 API 엔드포인트별 메서드 구현

2.  **Phase 2: Tool Implementation**
    *   `PatentDiscoveryTool`, `PatentDetailTool`, `PatentLegalTool` 구현
    *   LangChain BaseTool 상속 및 스키마 정의

3.  **Phase 3: Agent Integration**
    *   `PatentAnalysisAgent`가 새로운 툴들을 사용하도록 로직 변경
    *   LLM 프롬프트 최적화 (툴 선택 가이드)

4.  **Phase 4: Testing & Verification**
    *   단위 테스트 및 시나리오별 통합 테스트

## 5. 구현 결과 (Implementation Results - 2025.11.28)

설계에 따른 구현이 완료되었으며, 주요 변경 사항과 결과는 다음과 같다.

### 5.1. Layer 1: KIPRIS Client 구현 (`backend/app/clients/kipris.py`)
*   **기능 구현**:
    *   `search_patents`: `getAdvancedSearch` API를 사용하여 검색 기능 구현. `ipc_all` 파싱 및 `customer_no` 처리 로직 추가.
    *   `search_applicant_code`: 출원인 명칭으로 특허고객번호를 조회하여 검색 정확도를 높이는 로직 구현.
    *   `get_biblio_detail`: `getBiblioDetailInfo` API 연동 (청구항, 상세 정보 조회용).
*   **개선 사항 (2025.11.28 업데이트)**:
    *   **URL 인코딩 수정**: `aiohttp`와 `urllib.parse.quote`의 이중 인코딩 문제 해결. 검색 정확도 대폭 향상.
    *   **Total Count 파싱**: XML 응답에서 `<totalCount>` 필드를 추출하여 전체 검색 결과 수 제공 기능 추가.
    *   **반환 타입 변경**: `(List[PatentData], int)` 튜플을 반환하여 데이터와 메타데이터(총 개수)를 분리 전달.
    *   XML 파싱 에러 핸들링 강화.
    *   API 키 누락 시 안전한 폴백 처리.
    *   서비스명 오타(`patUtiModInfoSearchSevice`) 수정 및 적용.

### 5.2. Layer 2: Functional Tools 구현 (`backend/app/tools/retrieval/patent_functional_tools.py`)
*   **PatentDiscoveryTool**:
    *   상태: **완료 (Verified)**
    *   테스트 결과: "인공지능 이미지 생성" 쿼리로 8건의 유효한 특허 데이터 확보 확인. "삼성전자" 검색 시 30만 건 이상의 Total Count 정확히 반환 확인.
    *   **반환 포맷 변경**: 기존 `List[Dict]`에서 `Dict{'patents': List, 'total_count': int}` 구조로 변경하여 통계 정보 전달 능력 강화.
    *   특징: 검색 속도가 빠르며, 시각화에 필요한 핵심 메타데이터(출원인, 날짜, IPC 등)를 효율적으로 제공.
*   **PatentDetailTool**:
    *   상태: **구현 완료 (Refinement Needed)**
    *   구조는 완성되었으나, KIPRIS의 상세 정보 API 엔드포인트 특성상 일부 데이터(청구항 등)가 비어있는 경우가 있어 추가 튜닝 필요.
*   **PatentLegalTool**:
    *   상태: **구현 완료 (Refinement Needed)**
    *   기본 골격 구현 완료. 행정 정보 API 연동 최적화 필요.

### 5.3. Layer 3: Agent Integration (`backend/app/agents/patent/patent_analysis_agent.py`)
*   **하이브리드 검색 로직 적용**:
    *   **KR (한국)**: 새로 구현된 `PatentDiscoveryTool`을 사용하여 KIPRIS 직접 연동. 데이터 정합성 및 최신성 확보.
    *   **Global (미국/유럽 등)**: 기존 `PatentSearchTool` (SerpAPI)을 사용하여 글로벌 커버리지 유지.
*   **데이터 매핑 및 통계 처리**:
    *   `_map_discovery_to_patent_data` 메서드를 통해 Layer 2의 결과를 기존 에이전트 파이프라인과 호환되도록 변환.
    *   **Total Count 통합**: `PatentDiscoveryTool`이 반환하는 `total_count`를 에이전트 최종 결과(`total_patents`)에 반영하여, 실제 검색된(retrieved) 개수보다 더 정확한 전체 모집단 규모를 사용자에게 제공.
*   **검증**:
    *   통합 테스트 스크립트(`test_patent_tools.py`)를 통해 모듈 동작 확인 완료.
    *   "삼성전자" 키워드 테스트를 통해 검색 결과 및 총 건수(30만+ 건) 정상 출력 확인.

## 6. 향후 고도화 계획 (Future Improvements)

### 6.1. 데이터 깊이 확보 (Deep Dive)
*   **전문(Full Text) 확보**: 현재 서지 정보 위주의 데이터를 넘어, `PatentDetailTool`이 청구항 전문과 상세 설명을 완벽하게 가져오도록 KIPRIS의 `getFullTextInfo` 등 추가 API 발굴 및 연동.
*   **법적 상태 상세화**: 단순 등록/거절 상태를 넘어, 심사 진행 단계(의견제출통지, 보정서 제출 등)를 타임라인으로 시각화할 수 있도록 `PatentLegalTool` 고도화.

### 6.2. 에이전트 지능화
*   **자동 심층 분석**: 검색 결과 중 사용자가 관심을 보일만한 핵심 특허(Top 3)에 대해서는 에이전트가 스스로 `PatentDetailTool`을 호출하여 요약 정보를 미리 생성하는 로직 추가.
*   **FTO(자유실시) 분석 자동화**: 청구항 비교 분석 기능을 에이전트 스킬로 내재화.

### 6.3. 시각화 고도화
*   **IPC 네트워크 맵**: `ipc_all` 데이터를 활용하여 기술 간의 융합 관계를 보여주는 네트워크 그래프 추가.
*   **출원인-기술 매트릭스**: 경쟁사들이 어떤 기술 분야에 집중하고 있는지 보여주는 히트맵 생성.

## 7. 선행기술조사 Agentic AI 설계 (Prior Art Search with ReAct)

본 섹션은 “특허 문서 → 서지/핵심요소 추출 → KIPRIS 입력값 자동 구성 → ReAct 반복 검색/정제 → 선행기술조사보고서 생성” 플로우를 제품 코드에 연결하기 위한 구체 설계이다.

### 7.1. 목표 / 비목표
*   **목표**:
    *   특허 명세서(또는 아이디어 문서) 1건을 입력으로 받아, KIPRIS(우선) 기반의 재현 가능한 검색 전략을 수립하고 반복 개선하여 선행기술 후보를 수집한다.
    *   후보 특허의 핵심 유사점/차이점 및 법적 상태를 요약하여 “선행기술조사보고서” 템플릿으로 출력한다.
    *   구조적으로는 Provider Adapter 패턴을 유지하여, 추후 USPTO/Google Patents 등으로 자연스럽게 확장한다.
*   **비목표(초기 버전)**:
    *   법률적 판단을 대체하는 FTO/무효가능성에 대한 확정 결론 제공.
    *   모든 국가/언어를 동일 품질로 커버(우선순위는 KR(KIPRIS) → Global 확장).

### 7.2. 입력/출력 정의
*   **입력(현재)**:
    *   특허 문서 파일(PDF/DOCX) 또는 추출된 텍스트
*   **입력(확장)**:
    *   URL 링크(예: KIPRIS 상세 페이지, 공개/등록 공보 URL) 기반 수집
*   **출력**:
    *   선행기술조사보고서(구조화 JSON + Markdown/HTML 렌더)
    *   재현 가능한 검색 로그(검색식, 필터, 반복 단계별 의사결정)

### 7.3. 전체 처리 흐름 (End-to-End)
1) **문서 이해(Extraction)**
    *   입력 문서에서 아래 정보를 추출하고 정규화한다.
        *   서지: 발명의 명칭, 출원인/발명자, 출원/공개/등록 번호(가능 시), 출원일/공개일/우선권, 국가
        *   기술요약: 요약(abstract), 해결 과제, 핵심 구성요소, 주요 효과
        *   청구항: 독립항 우선(1항 등) + 종속항은 요약 수준
        *   분류: IPC/CPC(가능 시), 키워드
    *   산출물: `TargetPatentSpec` (구조화 객체)

2) **KIPRIS 검색 입력값 자동 구성(Query Synthesis)**
    *   `TargetPatentSpec` → KIPRIS Advanced Search에 투입 가능한 “검색식 후보군”을 생성한다.
    *   생성 전략(예시):
        *   (A) 제목/요약 키워드 기반 OR 묶음 + 핵심 구성요소(필수어) AND
        *   (B) IPC/CPC 기반 필터 + 키워드 보강
        *   (C) 출원인/발명자 시드(과도한 편향 방지를 위해 낮은 가중치)
        *   (D) 청구항 독립항에서 추출한 기능/구성요소 기반 조합
    *   산출물: `SearchPlan` (query_variants, 필터, 가드레일)

3) **ReAct 반복 검색/정제(Agent Loop)**
    *   에이전트는 “현재 검색식으로 충분한 커버리지가 확보되었는가?”를 기준으로 반복 수행한다.
    *   각 반복 단계(Iteration)에서 수행 가능한 행동(Action) 예시:
        *   `PatentDiscoveryTool`로 검색 실행(필요 시 여러 query variant를 순차 실행)
        *   결과의 상위 N건을 샘플링해 요약/키워드/IPC를 관찰하고, 검색식의 누락/과잉을 진단
        *   검색식 수정(동의어 추가, 필수어/제외어 조정, IPC 확장/축소)
        *   중복 제거/클러스터링으로 후보군의 다양성 확보
    *   종료 조건(초기 권장):
        *   최대 반복 횟수/시간 제한
        *   유효 후보(Top-K)에서 신규 정보(새 IPC/새 키워드/새 패밀리)가 더 이상 증가하지 않을 때

4) **상세/법적 상태 보강(Enrichment)**
    *   최종 후보 Top-K에 대해:
        *   `PatentDetailTool`: 서지/요약/청구항/상세설명(가능 범위) 확보
        *   `PatentLegalTool`: 법적 상태/권리 존속/이력 요약
    *   산출물: `CandidatePatent[]` (원문/요약/법적상태 포함)

5) **유사도 및 근거 작성(Scoring & Evidence)**
    *   유사도는 단일 수치로 고정하지 않고, “근거 중심”으로 구성한다.
        *   텍스트 유사도(요약/청구항 기반)
        *   구성요소 매칭(핵심 구성요소가 후보에 존재하는지)
        *   분류/키워드 일치도(IPC/CPC)
    *   산출물: `Comparison[]` (유사점/차이점, 리스크 포인트, 근거 인용)

6) **보고서 템플릿 생성(Reporting)**
    *   보고서 섹션(권장):
        *   조사 목적/범위
        *   입력 문서 요약(서지 + 핵심요소)
        *   검색 전략(반복 단계별 검색식/필터/의사결정 로그)
        *   검색 결과 요약(Top-K 후보 리스트)
        *   후보별 상세 비교(핵심 유사점/차이점/법적상태)
        *   결론(초기 관찰/추가 조사 권고; 법률 자문 아님 명시)

### 7.4. 데이터 모델(초안)
*   `TargetPatentSpec`
    *   `title`, `abstract`, `claims_independent[]`, `applicants[]`, `inventors[]`, `ipc[]`, `cpc[]`, `country`, `dates{}`
    *   `core_components[]`, `core_effects[]`, `keywords[]`
*   `SearchPlan`
    *   `query_variants[]`, `filters{ipc/cpc/date/country}`, `stop_conditions{}`
    *   `guardrails{max_iterations,max_results_per_query,rate_limit}`
*   `SearchIteration`
    *   `query_used`, `result_stats{total_count,retrieved}`, `observations[]`, `refinement_decision`
*   `CandidatePatent`
    *   `publication_number`, `title`, `abstract`, `ipc[]`, `assignee`, `url`, `legal_status{}`
    *   `evidence{matched_components[],key_snippets[]}`
*   `PriorArtReport`
    *   `target: TargetPatentSpec`, `iterations[]`, `candidates[]`, `comparisons[]`, `recommendations[]`

### 7.5. 기존 코드와의 연결 포인트(권장)
*   **ReAct 루프 구현 기반**: `backend/app/agents/patent/patent_analysis_agent_v2.py`
    *   기존 LangGraph ReAct 스타일을 유지하되, “선행기술조사”에 맞는 상태(`TargetPatentSpec`, `SearchPlan`, `SearchIteration`)를 추가하는 방향이 안전하다.
*   **도구 계층 재사용**: `backend/app/tools/retrieval/patent_functional_tools.py`
    *   Discovery/Detail/Legal 3종 도구를 “수집/보강” 단계에 그대로 사용한다.
*   **Provider Adapter 확장(USPTO)**:
    *   Layer 1에 `USPTOClient`(또는 `uspto.py`)를 추가하고, Discovery/Detail/Legal의 동일 인터페이스를 제공한다.
    *   Layer 2/3는 Provider가 바뀌어도 동일한 `CandidatePatent` 스키마를 사용하도록 매핑 계층을 둔다.

### 7.6. 운영/품질 가드레일
*   **재현성**: 보고서에 “검색식/필터/반복 로그”를 반드시 포함한다.
*   **비용/속도**: 반복 횟수, 상세 조회 Top-K, 레이트리밋을 기본 제한으로 둔다.
*   **신뢰성**: KIPRIS 장애/응답 스키마 변경 대비(에러 분류, 재시도, 부분 결과 반환).
*   **컴플라이언스**: 결과는 참고용이며 법률 자문이 아님을 템플릿에 명시한다.
